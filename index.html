<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>í”„ë¡œì íŠ¸ í—ˆë¸Œ Â· ë©”ì¸</title>

  <!-- Canonical & PWA/Theme -->
  <link rel="canonical" href="https://kimys01.github.io/propot/">
  <meta name="theme-color" content="#0b1020">

  <!-- Favicon / OG / Twitter -->
  <link rel="icon" href="web/favicon.svg">
  <meta property="og:type" content="website">
  <meta property="og:title" content="í”„ë¡œì íŠ¸ í—ˆë¸Œ">
  <meta property="og:description" content="ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ì™€ ì¹œêµ¬ ê³µë™ì‘ì—… ê³µê°„">
  <meta property="og:url" content="https://kimys01.github.io/propot/">
  <meta property="og:image" content="https://kimys01.github.io/propot/web/og-card.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="í”„ë¡œì íŠ¸ í—ˆë¸Œ">
  <meta name="twitter:description" content="ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ì™€ ì¹œêµ¬ ê³µë™ì‘ì—… ê³µê°„">
  <meta name="twitter:image" content="https://kimys01.github.io/propot/web/og-card.png">

  <!-- CSS (cache-busting ë²„ì „ ì¿¼ë¦¬) -->
  <base href="https://kimys01.github.io/propot/">
  <link rel="stylesheet" href="/propot/base.css?v=20250922">
  <link rel="stylesheet" href="/propot/index.css?v=20250922">


</head>
<body>
<header>
  <div class="wrap row">
    <div class="row" style="gap:8px">
      <strong>ğŸ“ í”„ë¡œì íŠ¸ í—ˆë¸Œ</strong><span class="chip">GitHub Pages + Firebase</span>
    </div>
    <div class="row" style="margin-left:auto">
      <span id="user-line" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
      <button id="btn-login" class="secondary" aria-label="êµ¬ê¸€ ë¡œê·¸ì¸">Google ë¡œê·¸ì¸</button>
      <button id="btn-logout" class="ghost" style="display:none" aria-label="ë¡œê·¸ì•„ì›ƒ">ë¡œê·¸ì•„ì›ƒ</button>
      <button id="btn-my" class="secondary" style="display:none" aria-label="ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ë¡œ ì´ë™">ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ë¡œ</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding:16px 18px">
  <div class="grid cols-2">
    <section class="card">
      <h2 style="margin:0 0 8px">ì‹œì‘í•˜ê¸°</h2>
      <p class="muted" id="hello">ë¡œê·¸ì¸í•˜ë©´ ë‚´ ê°œì¸ í¬íŠ¸í´ë¦¬ì˜¤ í˜ì´ì§€ê°€ ìƒì„±ë˜ê³ , ê³µìœ  ë§í¬ë¡œ ì¹œêµ¬ë¥¼ ì´ˆëŒ€í•  ìˆ˜ ìˆì–´ìš”.</p>
      <div id="share-box" class="grid" style="display:none">
        <label class="muted" for="share-url">ë‚´ ê³µìœ  ë§í¬</label>
        <div class="row" style="gap:8px">
          <input id="share-url" readonly aria-readonly="true"/>
          <button id="btn-copy" class="secondary" aria-label="ê³µìœ  ë§í¬ ë³µì‚¬">ë³µì‚¬</button>
        </div>
      </div>
      <div id="invite-box" class="grid" style="margin-top:12px; display:none">
        <h3 style="margin:8px 0">ì¹œêµ¬ ì´ˆëŒ€</h3>
        <p class="muted">ì•„ë˜ì— ì¹œêµ¬ ì´ë©”ì¼ ë˜ëŠ” UIDë¥¼ ì…ë ¥í•˜ë©´ ë‚´ í˜ì´ì§€ì— ê¸€ì“°ê¸° ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.</p>
        <div class="row" style="gap:8px">
          <input id="friend-input" placeholder="ì¹œêµ¬ ì´ë©”ì¼ ë˜ëŠ” UID" aria-label="ì¹œêµ¬ ì´ë©”ì¼ ë˜ëŠ” UID ì…ë ¥"/>
          <button id="btn-invite" aria-label="ê³µìœ  ì¶”ê°€">ê³µìœ  ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px">ë‚´ê°€ ê³µìœ í•œ ì¹œêµ¬</h2>
      <div id="my-friends" class="list"></div>
    </section>
  </div>

  <section class="card" style="margin-top:14px">
    <h2 style="margin:0 0 8px">ë‚˜ì—ê²Œ ê³µìœ í•´ì¤€ í˜ì´ì§€</h2>
    <div id="shared-to-me" class="list"></div>
  </section>

  <section class="card" style="margin-top:14px">
    <h2 style="margin:0 0 8px">ë„ì›€ë§</h2>
    <ol class="muted">
      <li>ë¡œê·¸ì¸ â†’ â€œë‚´ í¬íŠ¸í´ë¦¬ì˜¤ë¡œâ€ë¥¼ ëˆŒëŸ¬ <code>u.html?uid=ë‚´UID</code> í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.</li>
      <li>ì¹œêµ¬ë¥¼ ì´ˆëŒ€í•˜ë©´ ê·¸ ì¹œêµ¬ëŠ” ë‚´ í˜ì´ì§€ì—ì„œ ê¸€/íŒŒì¼ì„ ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”.</li>
      <li>ì•„ë˜ ëª©ë¡ì—ì„œ ê³µìœ  í•´ì œ(ì‚­ì œ)ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
    </ol>
  </section>
</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",
    authDomain:"propot-cc6bf.firebaseapp.com",
    projectId:"propot-cc6bf",
    appId:"1:30940698980:web:1729f30e68d3beb24ac271"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  const $ = s=>document.querySelector(s);
  const esc = s=>String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const lower = s => String(s||'').trim().toLowerCase();

  let me=null, isAdmin=false;

  // ===== ì—ëŸ¬ ë¡œê¹… (authenticatedë§Œ ê¸°ë¡; ì‹¤íŒ¨í•´ë„ ì•± ë™ì‘ì—ëŠ” ì˜í–¥ X)
  async function logError(error, context) {
    try {
      await db.collection('clientLogs').add({
        at: firebase.firestore.FieldValue.serverTimestamp(),
        path: location.pathname + location.search,
        uid: (auth.currentUser && auth.currentUser.uid) || null,
        context: context || null,
        message: String(error && (error.message || error)) || '',
        stack: String(error && error.stack) || ''
      });
    } catch (_) { /* ignore logging errors */ }
  }
  window.addEventListener('error', (e)=>logError(e.error||e.message, 'window.error'));
  window.addEventListener('unhandledrejection', (e)=>logError(e.reason, 'unhandledrejection'));

  // ===== UI Actions
  $('#btn-login').onclick = ()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>{ logError(e,'login'); alert(e.message); });
  $('#btn-logout').onclick= ()=>auth.signOut();
  $('#btn-my').onclick     = ()=>{ if(me) location.href=`u.html?uid=${encodeURIComponent(me.uid)}`; };

  $('#btn-copy').onclick = async ()=>{
    try { await navigator.clipboard.writeText($('#share-url').value); alert('ë³µì‚¬ ì™„ë£Œ!'); }
    catch (e) { logError(e,'copy'); alert('ë³µì‚¬ ì‹¤íŒ¨: ' + e.message); }
  };

  // ìµœì´ˆ/ë§¤ ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©ì í”„ë¡œí•„ ë¬¸ì„œ upsert
  async function ensureUserDoc(u){
    const ref = db.collection('users').doc(u.uid);
    const snap = await ref.get();
    const data = {
      uid: u.uid,
      displayName: u.displayName || 'ìµëª…',
      email: u.email || null,
      emailLower: lower(u.email),
      photoURL: u.photoURL || null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    if(!snap.exists) data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
    await ref.set(data,{merge:true});
  }

  // ì¹œêµ¬ ì¶”ê°€ (ë‚´ê°€ ì†Œìœ ì)
  async function inviteFriendByEmailOrUid(input){
    const v = (input||'').trim();
    if(!v) throw new Error('ì´ë©”ì¼ ë˜ëŠ” UIDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    if(v === me.uid) throw new Error('ë³¸ì¸ UIDëŠ” ì´ˆëŒ€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    let friendUid = null, friendName = null, friendEmail=null;

    if(v.includes('@')){
      const q = await db.collection('users').where('emailLower','==', lower(v)).limit(1).get();
      if(q.empty) throw new Error('í•´ë‹¹ ì´ë©”ì¼ ì‚¬ìš©ìë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¨¼ì € ìƒëŒ€ê°€ ë¡œê·¸ì¸í•´ì•¼ í•´ìš”.');
      const doc = q.docs[0]; const u = doc.data();
      friendUid = u.uid; friendName = u.displayName||'ìµëª…'; friendEmail=u.email||null;
    }else{
      const doc = await db.collection('users').doc(v).get();
      if(!doc.exists) throw new Error('UIDë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¨¼ì € ìƒëŒ€ê°€ ë¡œê·¸ì¸í•´ì•¼ í•´ìš”.');
      const u = doc.data(); friendUid = u.uid; friendName=u.displayName||'ìµëª…'; friendEmail=u.email||null;
    }

    const id = `${me.uid}_${friendUid}`;
    const ref = db.collection('friends').doc(id);
    await ref.set({
      ownerUid: me.uid,
      friendUid,
      friendName,
      friendEmailLower: lower(friendEmail),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }

  async function loadMyFriends(){
    const box = $('#my-friends'); box.innerHTML = '<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      const snap = await db.collection('friends')
        .where('ownerUid','==', me.uid)
        .orderBy('createdAt','desc').get();
      box.innerHTML = '';
      if(snap.empty){ box.innerHTML = '<div class="muted">ì•„ì§ ê³µìœ í•œ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      snap.forEach(d=>{
        const f = d.data();
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div><strong>${esc(f.friendName||'ì¹œêµ¬')}</strong></div>
              <div class="muted">${esc(f.friendUid)}${f.friendEmailLower?' Â· '+esc(f.friendEmailLower):''}</div>
            </div>
            <div class="row" style="gap:8px">
              <a class="ghost" href="u.html?uid=${encodeURIComponent(me.uid)}" aria-label="ë‚´ í˜ì´ì§€ ì—´ê¸°">ë‚´ í˜ì´ì§€ ì—´ê¸°</a>
              <button data-id="${d.id}" class="ghost" aria-label="ê³µìœ  í•´ì œ">ê³µìœ  í•´ì œ</button>
            </div>
          </div>`;
        row.querySelector('button[data-id]').onclick = async (ev)=>{
          if(!confirm('ì´ ì¹œêµ¬ì˜ ê¶Œí•œì„ í•´ì œí• ê¹Œìš”?')) return;
          try { await db.collection('friends').doc(ev.target.dataset.id).delete(); loadMyFriends(); }
          catch(e){ logError(e,'friend-unshare'); alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message); }
        };
        box.appendChild(row);
      });
    }catch(e){ logError(e,'loadMyFriends'); box.innerHTML = `<div class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(e.message)}</div>`; }
  }

  async function loadSharedToMe(){
    const box = $('#shared-to-me'); box.innerHTML = '<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      const snap = await db.collection('friends')
        .where('friendUid','==', me.uid)
        .orderBy('createdAt','desc').get();
      box.innerHTML = '';
      if(snap.empty){ box.innerHTML = '<div class="muted">ì•„ì§ ê³µìœ ë°›ì€ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      snap.forEach(d=>{
        const f = d.data();
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="muted">ownerUid</div>
              <div><strong>${esc(f.ownerUid)}</strong></div>
            </div>
            <div class="row" style="gap:8px">
              <a class="ghost" href="u.html?uid=${encodeURIComponent(f.ownerUid)}" aria-label="í˜ì´ì§€ ì—´ê¸°">í˜ì´ì§€ ì—´ê¸°</a>
            </div>
          </div>`;
        box.appendChild(row);
      });
    }catch(e){ logError(e,'loadSharedToMe'); box.innerHTML = `<div class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(e.message)}</div>`; }
  }

  $('#btn-invite').onclick = async ()=>{
    try{
      const v = $('#friend-input').value;
      await inviteFriendByEmailOrUid(v);
      $('#friend-input').value='';
      loadMyFriends();
      alert('ê³µìœ ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }catch(e){ logError(e,'invite'); alert(e.message); }
  };

  auth.onAuthStateChanged(async u=>{
    me = u;
    if(!u){
      $('#user-line').textContent='ë¡œê·¸ì¸ í•„ìš”';
      $('#btn-login').style.display='';
      $('#btn-logout').style.display='none';
      $('#btn-my').style.display='none';
      $('#share-box').style.display='none';
      $('#invite-box').style.display='none';
      $('#my-friends').innerHTML='';
      $('#shared-to-me').innerHTML='';
      return;
    }
    try{ isAdmin = (await db.collection('roles').doc(u.uid).get()).exists; }catch{ isAdmin=false; }
    await ensureUserDoc(u);

    $('#user-line').textContent = `${u.displayName||'ìµëª…'} (${u.email||''})${isAdmin?' Â· ê´€ë¦¬ì':''}`;
    $('#btn-login').style.display='none';
    $('#btn-logout').style.display='';
    $('#btn-my').style.display='';

    const link = `${location.origin}${location.pathname.replace(/index\.html?$/,'')}u.html?uid=${encodeURIComponent(u.uid)}`;
    $('#share-url').value = link;
    $('#share-box').style.display='';
    $('#invite-box').style.display='';

    loadMyFriends();
    loadSharedToMe();
  });
</script>
</body>
</html>
