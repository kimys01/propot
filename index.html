<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="https://kimys01.github.io/propot/">
<title>프로젝트 허브 · 메인</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  /* === 로그인 페이지와 일관된 스타일 테마 === */
  :root {
    --primary-color: #6a5acd; /* 브랜드 색상 (보라색 계열) */
    --button-hover-color: #5a4ab9;
    --background-color: #f0f2f5; /* 페이지 전체 배경 */
    --container-bg-color: #ffffff; /* 카드, 헤더 등 컨텐츠 배경 */
    --text-color: #333; /* 기본 텍스트 */
    --text-muted-color: #666; /* 보조 텍스트 */
    --border-color: #e0e0e0; /* 테두리 색상 */
  }

  /* === 기본 스타일 초기화 및 설정 === */
  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:var(--background-color);
    color:var(--text-color);
    font:16px/1.5 'Noto Sans KR', system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Malgun Gothic,sans-serif;
  }
  a{color:var(--primary-color); text-decoration:none}
  a:hover{text-decoration:underline}

  /* === 헤더 스타일 === */
  .hdr{
    position:sticky;
    top:0;
    background:var(--container-bg-color);
    border-bottom:1px solid var(--border-color);
    backdrop-filter:blur(8px);
    z-index:10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .hdr strong {
    color: var(--primary-color);
  }

  /* === 레이아웃 헬퍼 클래스 === */
  .wrap{max-width:1024px;margin:0 auto;padding:14px 18px}
  .row{display:flex;gap:10px;align-items:center}
  .row.space{justify-content:space-between}
  .row.gap8{gap:8px}
  .row.ml-auto{margin-left:auto}
  .row.wrap{flex-wrap:wrap}
  .pad16{padding:16px 18px}
  .mt10{margin-top:10px}.mt12{margin-top:12px}.mt14{margin-top:14px}.mt8{margin-top:8px}.mt2{margin-top:2px}

  /* === 카드 및 콘텐츠 스타일 === */
  .card{
    background:var(--container-bg-color);
    border: none;
    border-radius:12px;
    padding:24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
  }
  .list{display:grid;gap:10px}
  .item{
    background: #f9f9f9;
    border:1px solid var(--border-color);
    border-radius:10px;
    padding:16px;
  }
  .item strong { color: var(--text-color); }
  .chip{
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    background-color: #ebebeb;
    color: var(--text-muted-color);
  }
  .muted{color:var(--text-muted-color)}
  .ttl{
    margin:0 0 12px;
    color: var(--primary-color);
    font-weight: 700;
    font-size: 22px;
  }

  /* === 버튼 및 입력창 스타일 === */
  button,input{font:inherit}
  
  button, a.ghost {
    padding:10px 16px;
    border:none;
    border-radius:8px;
    font-size: 14px;
    font-weight:500;
    cursor:pointer;
    transition: all 0.2s;
    display: inline-flex;
    justify-content: center;
    align-items: center;
  }

  button{ /* 기본 버튼 (Primary) */
    background-color:var(--primary-color);
    color:white;
  }
  button:hover {
    background-color: var(--button-hover-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  button.secondary{ /* 보조 버튼 (Secondary) */
    background-color:#f0f0f0;
    color:var(--text-color);
    border:1px solid var(--border-color);
  }
  button.secondary:hover {
    background-color: #e5e5e5;
  }
  
  button.ghost, a.ghost{ /* 고스트 버튼 */
    background:transparent;
    color: var(--text-muted-color);
    border:1px solid var(--border-color);
  }
  button.ghost:hover, a.ghost:hover {
    background: rgba(106, 90, 205, 0.05);
    color: var(--primary-color);
    border-color: var(--primary-color);
  }
  
  .inp{
    width:100%;
    background:#ffffff;
    color:var(--text-color);
    border:1px solid var(--border-color);
    border-radius:8px;
    padding:12px 14px;
    transition: all 0.2s;
  }
  .inp:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.2);
  }

  /* === 그리드 및 반응형 === */
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:860px){.grid.cols-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="hdr">
  <div class="wrap row">
    <div class="row gap8">
      <strong>📁 Propot</strong><span class="chip">Beta</span>
    </div>
    <div class="row ml-auto gap8">
      <span id="user-line" class="muted">로그인 필요</span>
      <button id="btn-login" class="secondary">로그인</button>
      <button id="btn-logout" class="ghost" style="display:none">로그아웃</button>
      <button id="btn-my" class="secondary" style="display:none">내 포트폴리오</button>
      <a id="btn-admin" class="ghost" href="admin.html" style="display:none">관리자</a>
    </div>
  </div>
</header>

<main class="wrap pad16">
  <div class="grid cols-2">
    <section class="card">
      <h2 class="ttl">시작하기</h2>
      <p class="muted">로그인하면 내 개인 포트폴리오 페이지가 생성되고, 공유 링크로 다른 사용자를 초대할 수 있습니다.</p>

      <div id="share-box" class="grid" style="display:none">
        <label class="muted" style="margin-top: 12px; font-weight: 500;">내 공유 링크</label>
        <div class="row gap8">
          <input id="share-url" class="inp" readonly/>
          <button id="btn-copy" class="secondary">복사</button>
        </div>
      </div>

      <div id="invite-box" class="grid mt12" style="display:none">
        <h3 class="ttl" style="font-size:18px; margin-top:12px;">친구 초대</h3>
        <p class="muted">친구의 이메일 또는 UID를 입력하여 내 페이지에 글쓰기 권한을 부여하세요.</p>
        <div class="row gap8">
          <input id="friend-input" class="inp" placeholder="친구 이메일 또는 UID"/>
          <button id="btn-invite">권한 부여</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 class="ttl">내가 공유한 친구</h2>
      <div id="my-friends" class="list"></div>
    </section>
  </div>

  <section class="card mt14">
    <h2 class="ttl">나에게 공유된 페이지</h2>
    <div id="shared-to-me" class="list"></div>
  </section>

  <section class="card mt14">
    <h2 class="ttl">도움말</h2>
    <ol class="muted" style="padding-left: 20px;">
      <li>로그인 후 ‘내 포트폴리오’를 클릭하여 개인 페이지로 이동하세요.</li>
      <li>친구를 초대하면 해당 친구는 내 페이지에 글과 파일을 업로드할 수 있습니다.</li>
      <li>'내가 공유한 친구' 목록에서 언제든지 공유를 해제(삭제)할 수 있습니다.</li>
    </ol>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig={apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",authDomain:"propot-cc6bf.firebaseapp.com",projectId:"propot-cc6bf",appId:"1:30940698980:web:1729f30e68d3beb24ac271"};
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(), db=firebase.firestore();

  const $=s=>document.querySelector(s);
  const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const lower=s=>String(s||'').trim().toLowerCase();
  let me=null,isAdmin=false;

  // 로그인 버튼 클릭 시 login.html로 이동
  $('#btn-login').onclick = () => { location.href = 'login.html'; };

  $('#btn-logout').onclick=()=>auth.signOut();
  $('#btn-my').onclick=()=>{if(me)location.href=`u.html?uid=${encodeURIComponent(me.uid)}`};
  $('#btn-copy').onclick=async()=>{
    try {
      await navigator.clipboard.writeText($('#share-url').value);
      alert('복사 완료!');
    } catch (err) {
      alert('복사에 실패했습니다.');
    }
  };

  async function ensureUserDoc(u){
    const ref=db.collection('users').doc(u.uid); const snap=await ref.get();
    const data={uid:u.uid,displayName:u.displayName||'익명',email:u.email||null,emailLower:lower(u.email),photoURL:u.photoURL||null,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
    if(!snap.exists) data.createdAt=firebase.firestore.FieldValue.serverTimestamp();
    await ref.set(data,{merge:true});
  }

  async function inviteFriendByEmailOrUid(input){
    const v=(input||'').trim(); if(!v) throw new Error('이메일 또는 UID를 입력하세요.'); if(v===me.uid) throw new Error('자기 자신은 초대할 수 없습니다.');
    let friendUid=null, friendName=null, friendEmail=null;
    if(v.includes('@')){
      const q=await db.collection('users').where('emailLower','==',lower(v)).limit(1).get();
      if(q.empty) throw new Error('해당 이메일 사용자를 찾을 수 없습니다. 초대할 친구가 먼저 로그인해야 합니다.');
      const u=q.docs[0].data(); friendUid=u.uid; friendName=u.displayName||'익명'; friendEmail=u.email||null;
    }else{
      const doc=await db.collection('users').doc(v).get(); if(!doc.exists) throw new Error('해당 UID를 찾을 수 없습니다. 초대할 친구가 먼저 로그인해야 합니다.');
      const u=doc.data(); friendUid=u.uid; friendName=u.displayName||'익명'; friendEmail=u.email||null;
    }
    const id=`${me.uid}_${friendUid}`;
    await db.collection('friends').doc(id).set({
      ownerUid:me.uid, ownerName: me.displayName, friendUid, friendName, friendEmailLower:lower(friendEmail),
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }

  async function loadMyFriends(){
    const box=$('#my-friends'); box.innerHTML='<div class="muted">불러오는 중…</div>';
    try{
      let snap; try{
        snap=await db.collection('friends').where('ownerUid','==',me.uid).orderBy('createdAt','desc').get();
      }catch{ snap=await db.collection('friends').where('ownerUid','==',me.uid).get(); }
      box.innerHTML=''; if(snap.empty){ box.innerHTML='<div class="muted" style="text-align:center; padding: 20px 0;">아직 공유한 친구가 없습니다.</div>'; return; }
      snap.docs.forEach(d=>{
        const f=d.data();
        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`<div class="row space"><div><div><strong>${esc(f.friendName||'친구')}</strong></div><div class="muted" style="font-size:12px;">${esc(f.friendUid)}</div></div><div class="row gap8"><button class="ghost" data-id="${d.id}">공유 해제</button></div></div>`;
        row.querySelector('button[data-id]').onclick=async(ev)=>{ if(!confirm(`'${f.friendName}' 친구의 공유를 해제할까요?`))return; await db.collection('friends').doc(ev.target.dataset.id).delete(); loadMyFriends(); };
        box.appendChild(row);
      });
    }catch(e){ box.innerHTML=`<div class="muted">목록을 불러오는 데 실패했습니다: ${esc(e.message)}</div>`; }
  }

  async function loadSharedToMe(){
    const box=$('#shared-to-me'); box.innerHTML='<div class="muted">불러오는 중…</div>';
    try{
      let snap; try{
        snap=await db.collection('friends').where('friendUid','==',me.uid).orderBy('createdAt','desc').get();
      }catch{ snap=await db.collection('friends').where('friendUid','==',me.uid).get(); }
      box.innerHTML=''; if(snap.empty){ box.innerHTML='<div class="muted" style="text-align:center; padding: 20px 0;">아직 공유받은 페이지가 없습니다.</div>'; return; }
      snap.docs.forEach(d=>{
        const f=d.data();
        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`<div class="row space"><div><div><strong>${esc(f.ownerName||'소유자')}</strong>님의 포트폴리오</div><div class="muted" style="font-size:12px;">${esc(f.ownerUid)}</div></div><div class="row gap8"><a class="ghost" href="u.html?uid=${encodeURIComponent(f.ownerUid)}" style="padding: 8px 12px; font-weight: 700;">페이지 열기</a></div></div>`;
        box.appendChild(row);
      });
    }catch(e){ box.innerHTML=`<div class="muted">목록을 불러오는 데 실패했습니다: ${esc(e.message)}</div>`; }
  }

  $('#btn-invite').onclick=async()=>{ try{ await inviteFriendByEmailOrUid($('#friend-input').value); $('#friend-input').value=''; loadMyFriends(); alert('공유가 추가되었습니다.'); }catch(e){ alert(e.message);} };

  auth.onAuthStateChanged(async u=>{
    me=u;
    if(!u){
      $('#user-line').textContent='로그인 필요';
      $('#btn-login').style.display=''; $('#btn-logout').style.display='none'; $('#btn-my').style.display='none'; $('#btn-admin').style.display='none';
      $('#share-box').style.display='none'; $('#invite-box').style.display='none';
      $('#my-friends').innerHTML='<div class="muted" style="text-align:center; padding: 20px 0;">로그인 후 이용해주세요.</div>';
      $('#shared-to-me').innerHTML='<div class="muted" style="text-align:center; padding: 20px 0;">로그인 후 이용해주세요.</div>';
      return;
    }
    try{ isAdmin=(await db.collection('roles').doc(u.uid).get()).exists; }catch{ isAdmin=false; }
    await ensureUserDoc(u);
    $('#user-line').innerHTML=`<span style="font-weight:500;">${u.displayName||'익명'}</span><span class="muted" style="font-size:12px; margin-left: 4px;">${isAdmin?'(관리자)':''}</span>`;
    $('#btn-login').style.display='none'; $('#btn-logout').style.display=''; $('#btn-my').style.display=''; $('#btn-admin').style.display=isAdmin?'':'none';
    const link=`${location.origin}${location.pathname.replace(/index\.html?$/,'')}u.html?uid=${encodeURIComponent(u.uid)}`; $('#share-url').value=link;
    $('#share-box').style.display='grid'; $('#invite-box').style.display='grid';
    loadMyFriends(); loadSharedToMe();
  });
</script>
</body>
</html>

