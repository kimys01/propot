<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="https://kimys01.github.io/propot/">
<title>í”„ë¡œì íŠ¸ í—ˆë¸Œ Â· ë©”ì¸</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-color: #6a5acd;
    --button-hover-color: #5a4ab9;
    --background-color: #f0f2f5;
    --container-bg-color: #ffffff;
    --text-color: #333;
    --text-muted-color: #666;
    --border-color: #e0e0e0;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:var(--background-color);
    color:var(--text-color);
    font:16px/1.5 'Noto Sans KR', system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Malgun Gothic,sans-serif;
  }
  a{color:var(--primary-color); text-decoration:none}
  a:hover{text-decoration:underline}
  .hdr{
    position:sticky;
    top:0;
    background:var(--container-bg-color);
    border-bottom:1px solid var(--border-color);
    backdrop-filter:blur(8px);
    z-index:10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .hdr strong {
    color: var(--primary-color);
  }
  .wrap{max-width:1024px;margin:0 auto;padding:14px 18px}
  .row{display:flex;gap:10px;align-items:center}
  .row.space{justify-content:space-between}
  .row.gap8{gap:8px}
  .row.ml-auto{margin-left:auto}
  .row.wrap{flex-wrap:wrap}
  .pad16{padding:16px 18px}
  .mt10{margin-top:10px}.mt12{margin-top:12px}.mt14{margin-top:14px}.mt8{margin-top:8px}
  .card{
    background:var(--container-bg-color);
    border: none;
    border-radius:12px;
    padding:24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
  }
  .list{display:grid;gap:10px}
  .item{
    background: #f9f9f9;
    border:1px solid var(--border-color);
    border-radius:12px;
    padding:12px;
  }
  .chip{
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    background-color: #ebebeb;
    color: var(--text-muted-color);
  }
  .muted{color:var(--text-muted-color)}
  .ttl{
    margin:0 0 12px;
    color: var(--primary-color);
    font-weight: 700;
  }
  button,input,a.secondary,a.ghost{font:inherit}
  button, a.secondary, a.ghost {
    padding:8px 14px;
    border:none;
    border-radius:8px;
    font-size: 14px;
    font-weight:500;
    cursor:pointer;
    transition: all 0.2s;
    display: inline-flex;
    justify-content: center;
    align-items: center;
  }
  button{
    background-color:var(--primary-color);
    color:white;
  }
  button:hover {
    background-color: var(--button-hover-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  button.secondary, a.secondary{
    background-color:#f0f0f0;
    color:var(--text-color);
    border:1px solid var(--border-color);
  }
  button.secondary:hover, a.secondary:hover {
    background-color: #e5e5e5;
  }
  button.ghost, a.ghost{
    background:transparent;
    color: var(--text-muted-color);
    border:1px solid var(--border-color);
  }
  button.ghost:hover, a.ghost:hover {
    background: rgba(106, 90, 205, 0.05);
    color: var(--primary-color);
    border-color: var(--primary-color);
  }
  .inp{
    width:100%;
    background:#ffffff;
    color:var(--text-color);
    border:1px solid var(--border-color);
    border-radius:8px;
    padding:10px 12px;
    transition: all 0.2s;
  }
  .inp:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.2);
  }
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:860px){.grid.cols-2{grid-template-columns:1fr}}

  .profile-img {
      border-radius: 50%;
      object-fit: cover;
      background-color: #eee;
  }
  .profile-img-header {
      width: 28px;
      height: 28px;
  }
  .profile-img-list {
      width: 40px;
      height: 40px;
  }
</style>
</head>
<body>
<header class="hdr">
  <div class="wrap row">
    <div class="row gap8">
      <strong>ğŸ“ í”„ë¡œì íŠ¸ í—ˆë¸Œ</strong><span class="chip">Propot</span>
    </div>
    <div class="row ml-auto gap8">
      <img id="user-img" class="profile-img profile-img-header" style="display:none;">
      <span id="user-line" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
      <button id="btn-login" class="secondary">ë¡œê·¸ì¸</button>
      <a id="btn-settings" class="secondary" href="settings.html" style="display:none">ì„¤ì •</a>
      <button id="btn-logout" class="ghost" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      <button id="btn-my" class="secondary" style="display:none">ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ë¡œ</button>
      <a id="btn-admin" class="ghost" href="admin.html" style="display:none">ê´€ë¦¬ì</a>
    </div>
  </div>
</header>

<main class="wrap pad16">
  <div class="grid cols-2">
    <section class="card">
      <h2 class="ttl">ì‹œì‘í•˜ê¸°</h2>
      <p class="muted">ë¡œê·¸ì¸í•˜ë©´ ë‚´ ê°œì¸ í¬íŠ¸í´ë¦¬ì˜¤ í˜ì´ì§€ê°€ ìƒì„±ë˜ê³ , ê³µìœ  ë§í¬ë¡œ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ë‚´ ì‘ì—…ì„ ë³´ì—¬ì¤„ ìˆ˜ ìˆì–´ìš”.</p>

      <div id="share-box" class="grid" style="display:none">
        <label class="muted">ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ ê³µìœ  ë§í¬</label>
        <div class="row gap8">
          <input id="share-url" class="inp" readonly/>
          <button id="btn-copy" class="secondary">ë³µì‚¬</button>
        </div>
      </div>

      <div id="invite-box" class="grid mt12" style="display:none">
        <h3 class="ttl" style="font-size:18px">ì¹œêµ¬ ì¶”ê°€</h3>
        <p class="muted">ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ë©´ ì„œë¡œì˜ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë°©ë¬¸í•˜ê³  ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div class="row gap8">
          <input id="friend-input" class="inp" placeholder="ì¹œêµ¬ ì´ë©”ì¼ ë˜ëŠ” UID"/>
          <button id="btn-invite">ì¹œêµ¬ ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 class="ttl">ì¹œêµ¬ ëª©ë¡</h2>
      <div id="friend-list" class="list"></div>
    </section>
  </div>

  <section class="card mt14">
    <h2 class="ttl">ë„ì›€ë§</h2>
    <ol class="muted">
      <li>ë¡œê·¸ì¸ â†’ â€œë‚´ í¬íŠ¸í´ë¦¬ì˜¤ë¡œâ€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìì‹ ì˜ í¬íŠ¸í´ë¦¬ì˜¤ í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”.</li>
      <li>ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ë©´ ì„œë¡œì˜ í¬íŠ¸í´ë¦¬ì˜¤ì— ì ‘ê·¼í•˜ê³  í”„ë¡œì íŠ¸ë¥¼ í•¨ê»˜ ìˆ˜ì •í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì´ ìƒê¹ë‹ˆë‹¤.</li>
      <li>'ì¹œêµ¬ ëª©ë¡'ì—ì„œ ì–¸ì œë“ ì§€ ì¹œêµ¬ ê´€ê³„ë¥¼ ëŠì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
    </ol>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig={apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",authDomain:"propot-cc6bf.firebaseapp.com",projectId:"propot-cc6bf",appId:"1:30940698980:web:1729f30e68d3beb24ac271"};
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(), db=firebase.firestore();

  const $=s=>document.querySelector(s);
  const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const lower=s=>String(s||'').trim().toLowerCase();
  let me=null,isAdmin=false;

  $('#btn-login').onclick=()=>location.href='login.html';
  $('#btn-logout').onclick=()=>auth.signOut();
  $('#btn-my').onclick=()=>{
    if (me && me.uid) {
      location.href = `u.html?uid=${encodeURIComponent(me.uid)}`;
    } else {
      alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
  };
  $('#btn-copy').onclick=async()=>{ try { await navigator.clipboard.writeText($('#share-url').value); alert('ë³µì‚¬ ì™„ë£Œ!'); } catch(e) { alert('ë³µì‚¬ ì‹¤íŒ¨'); } };

  async function ensureUserDoc(u){
    const userRef = db.collection('users').doc(u.uid);
    const userSnap = await userRef.get();
    
    const isNewUser = !userSnap.exists;

    const userData = {
      uid:u.uid,
      displayName:u.displayName||'ìµëª…',
      email:u.email||null,
      emailLower:lower(u.email),
      photoURL:u.photoURL||null,
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    };

    if(isNewUser) {
      userData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
      userData.jobRole = [];
    }
    await userRef.set(userData, {merge:true});

    if (isNewUser) {
        await db.collection('projects').add({
            ownerUid: u.uid,
            authorUid: u.uid,
            authorName: u.displayName || 'ìµëª…',
            title: 'ë‚˜ì˜ ì²« ë²ˆì§¸ í”„ë¡œì íŠ¸',
            desc: 'ì´ í”„ë¡œì íŠ¸ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•˜ê³  ë‹¹ì‹ ì˜ ë©‹ì§„ ì‘ì—…ë¬¼ì„ ì±„ì›Œë³´ì„¸ìš”!',
            tags: ['ìƒ˜í”Œ', 'ì‹œì‘í•˜ê¸°'],
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            mainFile: null
        });
    }
  }

  async function addFriend(input){
    const v=(input||'').trim(); if(!v) throw new Error('ì´ë©”ì¼ ë˜ëŠ” UIDë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); if(v===me.uid) throw new Error('ìê¸° ìì‹ ì„ ì¹œêµ¬ë¡œ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    let friendUid=null;
    if(v.includes('@')){
      const q=await db.collection('users').where('emailLower','==',lower(v)).limit(1).get();
      if(q.empty) throw new Error('í•´ë‹¹ ì´ë©”ì¼ì˜ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒëŒ€ë°©ì´ ë¨¼ì € Propotì— ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.');
      friendUid=q.docs[0].data().uid;
    }else{
      const doc=await db.collection('users').doc(v).get(); if(!doc.exists) throw new Error('í•´ë‹¹ UIDì˜ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      friendUid=doc.data().uid;
    }
    
    const batch = db.batch();
    const time = firebase.firestore.FieldValue.serverTimestamp();

    const ref1 = db.collection('friends').doc(`${me.uid}_${friendUid}`);
    batch.set(ref1, { ownerUid: me.uid, friendUid: friendUid, createdAt: time });
    
    const ref2 = db.collection('friends').doc(`${friendUid}_${me.uid}`);
    batch.set(ref2, { ownerUid: friendUid, friendUid: me.uid, createdAt: time });

    await batch.commit();
  }

  async function loadFriends(){
    const box=$('#friend-list'); box.innerHTML='<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      const snap = await db.collection('friends').where('ownerUid','==',me.uid).orderBy('createdAt','desc').get();
      if(snap.empty){ box.innerHTML='<div class="muted">ì•„ì§ ì¶”ê°€ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

      const friendUids = snap.docs.map(doc => doc.data().friendUid).filter(Boolean);
      if (friendUids.length === 0) {
          box.innerHTML='<div class="muted">ì•„ì§ ì¶”ê°€ëœ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return;
      }
      
      const usersSnap = await db.collection('users').where('uid', 'in', friendUids).get();
      const friendsInfo = {};
      usersSnap.forEach(doc => {
          friendsInfo[doc.id] = doc.data();
      });
      
      box.innerHTML='';
      snap.docs.forEach(d=>{
        const f=d.data();
        const friendInfo = friendsInfo[f.friendUid];
        if (!friendInfo) return;

        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`<div class="row space">
            <a href="u.html?uid=${encodeURIComponent(f.friendUid)}" class="row gap8" style="flex: 1;">
                <img src="${friendInfo.photoURL || 'https://via.placeholder.com/40'}" class="profile-img profile-img-list">
                <strong>${esc(friendInfo.displayName||'ì¹œêµ¬')}</strong>
            </a>
            <div class="row gap8">
                <button class="ghost" data-friend-uid="${f.friendUid}">ì¹œêµ¬ ëŠê¸°</button>
            </div>
        </div>`;
        row.querySelector('button').onclick=async(ev)=>{ 
            if(!confirm('ì´ ì¹œêµ¬ì™€ì˜ ê´€ê³„ë¥¼ ëŠìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const friendUid = ev.target.dataset.friendUid;
            const batch = db.batch();
            batch.delete(db.collection('friends').doc(`${me.uid}_${friendUid}`));
            batch.delete(db.collection('friends').doc(`${friendUid}_${me.uid}`));
            await batch.commit();
            loadFriends(); 
        };
        box.appendChild(row);
      });
    }catch(e){ console.error(e); box.innerHTML=`<div class="muted">ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${esc(e.message)}</div>`; }
  }


  $('#btn-invite').onclick=async()=>{ try{ await addFriend($('#friend-input').value); $('#friend-input').value=''; loadFriends(); alert('ì¹œêµ¬ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'); }catch(e){ alert(e.message);} };

  auth.onAuthStateChanged(async u=>{
    me=u;
    const settingsBtn = $('#btn-settings');
    const userImg = $('#user-img');
    if(!u){
      $('#user-line').textContent='ë¡œê·¸ì¸ í•„ìš”';
      $('#btn-login').style.display='';
      $('#btn-logout').style.display='none';
      $('#btn-my').style.display='none';
      $('#btn-admin').style.display='none';
      settingsBtn.style.display='none';
      userImg.style.display='none';
      $('#share-box').style.display='none';
      $('#invite-box').style.display='none';
      $('#friend-list').innerHTML='';
      return;
    }

    await ensureUserDoc(u);
    
    try{ isAdmin=(await db.collection('roles').doc(u.uid).get()).exists; }catch{ isAdmin=false; }
    
    userImg.src = u.photoURL || `https://via.placeholder.com/28?text=${(u.displayName||'P').charAt(0)}`;
    userImg.style.display = '';
    $('#user-line').textContent=`${u.displayName||'ìµëª…'}`;
    $('#btn-login').style.display='none';
    $('#btn-logout').style.display='';
    $('#btn-my').style.display='';
    $('#btn-admin').style.display=isAdmin?'':'none';
    settingsBtn.style.display='';
    const link=`${location.origin}${location.pathname.replace(/index\.html?$/,'')}u.html?uid=${encodeURIComponent(u.uid)}`; $('#share-url').value=link;
    $('#share-box').style.display='';
    $('#invite-box').style.display='';
    loadFriends();
  });
</script>
</body>
</html>

