<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="https://kimys01.github.io/propot/">
<title>í”„ë¡œì íŠ¸ í—ˆë¸Œ Â· ë©”ì¸</title>
<style>
  :root{--bg:#0b1020;--card:#121a33;--muted:#8aa0c7;--text:#e9f0ff;--accent:#6da7ff;--accent2:#8cffda;--danger:#ff6c6c;--bd:#1d274b}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Malgun Gothic,sans-serif}
  a{color:var(--accent2);text-decoration:none} a:hover{text-decoration:underline}
  .hdr{position:sticky;top:0;background:#0b1020cc;border-bottom:1px solid #1e2a55;backdrop-filter:blur(8px);z-index:10}
  .wrap{max-width:1024px;margin:0 auto;padding:14px 18px}
  .row{display:flex;gap:10px;align-items:center}
  .row.space{justify-content:space-between}
  .row.gap8{gap:8px}
  .row.ml-auto{margin-left:auto}
  .row.wrap{flex-wrap:wrap}
  .pad16{padding:16px 18px}
  .mt10{margin-top:10px}.mt12{margin-top:12px}.mt14{margin-top:14px}.mt8{margin-top:8px}.mt2{margin-top:2px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:16px}
  .list{display:grid;gap:10px}
  .item{background:#0f1731;border:1px solid #23305d;border-radius:12px;padding:12px}
  .chip{font-size:12px;padding:2px 8px;border:1px solid #2b3a78;border-radius:999px;color:#bcd0ff}
  .muted{color:var(--muted)} .ttl{margin:0 0 8px}
  button,input{font:inherit}
  button{background:linear-gradient(135deg,var(--accent),#4f7fe0);color:#081225;border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
  button.secondary{background:#1b2750;color:#e9f0ff;border:1px solid #2b3a78}
  button.ghost{background:transparent;color:#e9f0ff;border:1px solid #2b3a78}
  .inp{width:100%;background:#0d152e;color:var(--text);border:1px solid #23305d;border-radius:12px;padding:10px 12px}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:860px){.grid.cols-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="hdr">
  <div class="wrap row">
    <div class="row gap8">
      <strong>ğŸ“ í”„ë¡œì íŠ¸ í—ˆë¸Œ</strong><span class="chip">GitHub Pages + Firebase</span>
    </div>
    <div class="row ml-auto gap8">
      <span id="user-line" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
      <button id="btn-login" class="secondary">Google ë¡œê·¸ì¸</button>
      <button id="btn-logout" class="ghost" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      <button id="btn-my" class="secondary" style="display:none">ë‚´ í¬íŠ¸í´ë¦¬ì˜¤ë¡œ</button>
      <a id="btn-admin" class="ghost" href="admin.html" style="display:none">ê´€ë¦¬ì</a>
    </div>
  </div>
</header>

<main class="wrap pad16">
  <div class="grid cols-2">
    <section class="card">
      <h2 class="ttl">ì‹œì‘í•˜ê¸°</h2>
      <p class="muted">ë¡œê·¸ì¸í•˜ë©´ ë‚´ ê°œì¸ í¬íŠ¸í´ë¦¬ì˜¤ í˜ì´ì§€ê°€ ìƒì„±ë˜ê³ , ê³µìœ  ë§í¬ë¡œ ì¹œêµ¬ë¥¼ ì´ˆëŒ€í•  ìˆ˜ ìˆì–´ìš”.</p>

      <div id="share-box" class="grid" style="display:none">
        <label class="muted">ë‚´ ê³µìœ  ë§í¬</label>
        <div class="row gap8">
          <input id="share-url" class="inp" readonly/>
          <button id="btn-copy" class="secondary">ë³µì‚¬</button>
        </div>
      </div>

      <div id="invite-box" class="grid mt12" style="display:none">
        <h3 class="ttl" style="font-size:18px">ì¹œêµ¬ ì´ˆëŒ€</h3>
        <p class="muted">ì¹œêµ¬ ì´ë©”ì¼ ë˜ëŠ” UIDë¥¼ ì…ë ¥í•˜ë©´ ë‚´ í˜ì´ì§€ì— ê¸€ì“°ê¸° ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.</p>
        <div class="row gap8">
          <input id="friend-input" class="inp" placeholder="ì¹œêµ¬ ì´ë©”ì¼ ë˜ëŠ” UID"/>
          <button id="btn-invite">ê³µìœ  ì¶”ê°€</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 class="ttl">ë‚´ê°€ ê³µìœ í•œ ì¹œêµ¬</h2>
      <div id="my-friends" class="list"></div>
    </section>
  </div>

  <section class="card mt14">
    <h2 class="ttl">ë‚˜ì—ê²Œ ê³µìœ í•´ì¤€ í˜ì´ì§€</h2>
    <div id="shared-to-me" class="list"></div>
  </section>

  <section class="card mt14">
    <h2 class="ttl">ë„ì›€ë§</h2>
    <ol class="muted">
      <li>ë¡œê·¸ì¸ â†’ â€œë‚´ í¬íŠ¸í´ë¦¬ì˜¤ë¡œâ€ë¥¼ ëˆŒëŸ¬ <code>u.html?uid=ë‚´UID</code> ë¡œ ì´ë™</li>
      <li>ì¹œêµ¬ ì´ˆëŒ€ ì‹œ ê·¸ ì¹œêµ¬ëŠ” ë‚´ í˜ì´ì§€ì— ê¸€/íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥</li>
      <li>ì•„ë˜ ëª©ë¡ì—ì„œ ê³µìœ  í•´ì œ(ì‚­ì œ) ê°€ëŠ¥</li>
    </ol>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig={apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",authDomain:"propot-cc6bf.firebaseapp.com",projectId:"propot-cc6bf",appId:"1:30940698980:web:1729f30e68d3beb24ac271"};
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(), db=firebase.firestore();

  const $=s=>document.querySelector(s);
  const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const lower=s=>String(s||'').trim().toLowerCase();
  let me=null,isAdmin=false;

  $('#btn-login').onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message));
  $('#btn-logout').onclick=()=>auth.signOut();
  $('#btn-my').onclick=()=>{if(me)location.href=`u.html?uid=${encodeURIComponent(me.uid)}`};
  $('#btn-copy').onclick=async()=>{await navigator.clipboard.writeText($('#share-url').value);alert('ë³µì‚¬ ì™„ë£Œ!')};

  async function ensureUserDoc(u){
    const ref=db.collection('users').doc(u.uid); const snap=await ref.get();
    const data={uid:u.uid,displayName:u.displayName||'ìµëª…',email:u.email||null,emailLower:lower(u.email),photoURL:u.photoURL||null,updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
    if(!snap.exists) data.createdAt=firebase.firestore.FieldValue.serverTimestamp();
    await ref.set(data,{merge:true});
  }

  async function inviteFriendByEmailOrUid(input){
    const v=(input||'').trim(); if(!v) throw new Error('ì´ë©”ì¼ ë˜ëŠ” UIDë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); if(v===me.uid) throw new Error('ë³¸ì¸ UIDëŠ” ì´ˆëŒ€ ë¶ˆê°€');
    let friendUid=null, friendName=null, friendEmail=null;
    if(v.includes('@')){
      const q=await db.collection('users').where('emailLower','==',lower(v)).limit(1).get();
      if(q.empty) throw new Error('ì´ë©”ì¼ ì‚¬ìš©ìë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¨¼ì € ìƒëŒ€ê°€ ë¡œê·¸ì¸í•´ì•¼ í•´ìš”.');
      const u=q.docs[0].data(); friendUid=u.uid; friendName=u.displayName||'ìµëª…'; friendEmail=u.email||null;
    }else{
      const doc=await db.collection('users').doc(v).get(); if(!doc.exists) throw new Error('UIDë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¨¼ì € ìƒëŒ€ê°€ ë¡œê·¸ì¸í•´ì•¼ í•´ìš”.');
      const u=doc.data(); friendUid=u.uid; friendName=u.displayName||'ìµëª…'; friendEmail=u.email||null;
    }
    const id=`${me.uid}_${friendUid}`;
    await db.collection('friends').doc(id).set({
      ownerUid:me.uid, friendUid, friendName, friendEmailLower:lower(friendEmail),
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }

  async function loadMyFriends(){
    const box=$('#my-friends'); box.innerHTML='<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      let snap; try{
        snap=await db.collection('friends').where('ownerUid','==',me.uid).orderBy('createdAt','desc').get();
      }catch{ snap=await db.collection('friends').where('ownerUid','==',me.uid).get(); }
      box.innerHTML=''; if(snap.empty){ box.innerHTML='<div class="muted">ì•„ì§ ê³µìœ í•œ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      snap.docs.sort((a,b)=>(b.data().createdAt?.toMillis?.()||0)-(a.data().createdAt?.toMillis?.()||0)).forEach(d=>{
        const f=d.data();
        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`<div class="row space"><div><div><strong>${esc(f.friendName||'ì¹œêµ¬')}</strong></div><div class="muted">${esc(f.friendUid)}${f.friendEmailLower?' Â· '+esc(f.friendEmailLower):''}</div></div><div class="row gap8"><a class="ghost" href="u.html?uid=${encodeURIComponent(me.uid)}">ë‚´ í˜ì´ì§€ ì—´ê¸°</a><button class="ghost" data-id="${d.id}">ê³µìœ  í•´ì œ</button></div></div>`;
        row.querySelector('button[data-id]').onclick=async(ev)=>{ if(!confirm('ì´ ì¹œêµ¬ì˜ ê¶Œí•œì„ í•´ì œí• ê¹Œìš”?'))return; await db.collection('friends').doc(ev.target.dataset.id).delete(); loadMyFriends(); };
        box.appendChild(row);
      });
    }catch(e){ box.innerHTML=`<div class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(e.message)}</div>`; }
  }

  async function loadSharedToMe(){
    const box=$('#shared-to-me'); box.innerHTML='<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      let snap; try{
        snap=await db.collection('friends').where('friendUid','==',me.uid).orderBy('createdAt','desc').get();
      }catch{ snap=await db.collection('friends').where('friendUid','==',me.uid).get(); }
      box.innerHTML=''; if(snap.empty){ box.innerHTML='<div class="muted">ì•„ì§ ê³µìœ ë°›ì€ í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      snap.docs.sort((a,b)=>(b.data().createdAt?.toMillis?.()||0)-(a.data().createdAt?.toMillis?.()||0)).forEach(d=>{
        const f=d.data();
        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`<div class="row space"><div><div class="muted">ownerUid</div><div><strong>${esc(f.ownerUid)}</strong></div></div><div class="row gap8"><a class="ghost" href="u.html?uid=${encodeURIComponent(f.ownerUid)}">í˜ì´ì§€ ì—´ê¸°</a></div></div>`;
        box.appendChild(row);
      });
    }catch(e){ box.innerHTML=`<div class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(e.message)}</div>`; }
  }

  $('#btn-invite').onclick=async()=>{ try{ await inviteFriendByEmailOrUid($('#friend-input').value); $('#friend-input').value=''; loadMyFriends(); alert('ê³µìœ ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.'); }catch(e){ alert(e.message);} };

  auth.onAuthStateChanged(async u=>{
    me=u;
    if(!u){
      $('#user-line').textContent='ë¡œê·¸ì¸ í•„ìš”';
      $('#btn-login').style.display=''; $('#btn-logout').style.display='none'; $('#btn-my').style.display='none'; $('#btn-admin').style.display='none';
      $('#share-box').style.display='none'; $('#invite-box').style.display='none'; $('#my-friends').innerHTML=''; $('#shared-to-me').innerHTML='';
      return;
    }
    try{ isAdmin=(await db.collection('roles').doc(u.uid).get()).exists; }catch{ isAdmin=false; }
    await ensureUserDoc(u);
    $('#user-line').textContent=`${u.displayName||'ìµëª…'} (${u.email||''})${isAdmin?' Â· ê´€ë¦¬ì':''}`;
    $('#btn-login').style.display='none'; $('#btn-logout').style.display=''; $('#btn-my').style.display=''; $('#btn-admin').style.display=isAdmin?'':'none';
    const link=`${location.origin}${location.pathname.replace(/index\.html?$/,'')}u.html?uid=${encodeURIComponent(u.uid)}`; $('#share-url').value=link;
    $('#share-box').style.display=''; $('#invite-box').style.display='';
    loadMyFriends(); loadSharedToMe();
  });
</script>
</body>
</html>
