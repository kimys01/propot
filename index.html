<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>프로젝트 허브 | 개인 포트폴리오</title>
<style>
  :root{--bg:#0b1020;--card:#121a33;--muted:#8aa0c7;--text:#e9f0ff;--accent:#6da7ff;--accent-2:#8cffda;--danger:#ff6c6c}
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  a{color:var(--accent-2);text-decoration:none} a:hover{text-decoration:underline}
  header{position:sticky;top:0;backdrop-filter:blur(8px);background:#0b1020cc;border-bottom:1px solid #1e2a55;z-index:10}
  .wrap{max-width:1024px;margin:0 auto;padding:16px 20px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:800;letter-spacing:.2px}
  .tag{font-size:12px;color:var(--muted);border:1px solid #253159;padding:2px 8px;border-radius:999px}
  button,input,textarea,select{font:inherit}
  button{background:linear-gradient(135deg,var(--accent),#4f7fe0);color:#081225;border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
  button.secondary{background:#1b2750;color:var(--text);border:1px solid #2b3a78}
  button.ghost{background:transparent;color:var(--text);border:1px solid #2b3a78}
  button.danger{background:#2a0f14;color:#ffc7c7;border:1px solid #5a1e25}
  button.mini{padding:6px 10px;border-radius:10px;font-size:12px}
  .card{background:var(--card);border:1px solid #1d274b;border-radius:16px;padding:16px}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
  .muted{color:var(--muted)}
  label{display:block;font-weight:700;margin-bottom:6px;color:#b7c6eb}
  input[type="text"],textarea{width:100%;background:#0d152e;color:var(--text);border:1px solid #23305d;border-radius:12px;padding:10px 12px}
  textarea{min-height:90px;resize:vertical}
  .list{display:grid;gap:12px}
  .project{border:1px solid #23305d;border-radius:16px;padding:14px;background:#0f1731}
  .project h3{margin:0 0 4px}
  .badges{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{font-size:12px;padding:2px 8px;border:1px solid #2b3a78;border-radius:999px;color:#bcd0ff}
  .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:18px 0 8px}
  .comment{border-left:2px solid #334388;padding-left:10px;margin:8px 0}
  .file-row{display:flex;justify-content:space-between;align-items:center;gap:8px;background:#0c142c;border:1px solid #23305d;border-radius:12px;padding:8px 10px}
  .right{text-align:right}
  footer{color:#8aa0c7;padding:32px 0;text-align:center}
  .hint{font-size:12px;color:var(--muted)}
  .flex{display:flex;gap:8px;align-items:center}
  .thumb{width:160px;height:100px;border-radius:10px;object-fit:cover;border:1px solid #23305d}
  /* 우상단 액션 */
  .right-wrap{position:relative;min-width:240px}
  .manage{position:absolute;top:-6px;right:-6px;display:flex;gap:6px;z-index:1}
  .badges.has-actions{padding-right:190px}
  @media (max-width:560px){.right-wrap{position:static}.manage{position:static;margin-top:6px}.badges.has-actions{padding-right:0}}
  /* 선택 모드 체크박스 */
  .select-cb{display:none}
  .selecting .select-cb{display:inline-block}
  /* 랜딩 히어로 */
  .hero{display:grid;gap:14px;place-items:center;text-align:center;padding:40px 10px}
  /* 친구 목록 아이템 */
  .friend-row{display:flex;justify-content:space-between;align-items:center;gap:10px;background:#0c142c;border:1px solid #23305d;border-radius:12px;padding:10px}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="row" style="gap:10px;">
      <span class="brand">📁 프로젝트 허브</span>
      <span class="tag">GitHub Pages + Firebase</span>
    </div>
    <div class="row" style="margin-left:auto;">
      <span id="user-info" class="muted">로그인 필요</span>
      <button id="btn-login" class="secondary">Google 로그인</button>
      <button id="btn-logout" class="ghost" style="display:none;">로그아웃</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:18px;">
  <!-- 랜딩 -->
  <section id="landing" class="card">
    <div class="hero">
      <h2>나만의 포트폴리오 페이지 만들기</h2>
      <p class="muted">로그인하면 <strong>내 전용 URL</strong>이 만들어지고, 링크를 공유하면 친구들도 내 페이지에 글/댓글/파일을 올릴 수 있어요.</p>
      <div class="row">
        <button id="btn-go-my" style="display:none;">내 페이지 열기</button>
        <button id="btn-need-login" class="secondary">로그인부터 하기</button>
      </div>
      <div class="hint">내 페이지 URL 형식: <code>?u=&lt;내 UID&gt;</code></div>
    </div>
  </section>

  <!-- 포트폴리오 헤더 -->
  <section id="portfolio-head" class="card" style="display:none;">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div>
        <h2 id="owner-title" style="margin:0 0 6px;">누군가의 포트폴리오</h2>
        <div class="muted" id="owner-sub">이 페이지에 글을 올리려면 로그인하세요.</div>
      </div>
      <div class="row" style="gap:8px;">
        <button id="btn-copy-link" class="ghost">공유 링크 복사</button>
        <button id="btn-add-friend" class="ghost" style="display:none;">이 페이지 저장</button>
        <button id="btn-open-my" class="secondary" style="display:none;">내 페이지로</button>
      </div>
    </div>
  </section>

  <!-- 새 프로젝트 등록 -->
  <section id="section-add" class="card" aria-labelledby="add-project-title" style="display:none;">
    <h3 id="add-project-title">새 프로젝트 등록</h3>
    <p class="muted" style="margin-top:-4px;">이 페이지의 소유자 포트폴리오에 등록됩니다. (작성자는 로그인 필요)</p>
    <form id="form-project" class="grid" style="gap:10px;">
      <div>
        <label for="p-title">프로젝트 제목</label>
        <input id="p-title" type="text" placeholder="예: 스마트 도어락" required />
      </div>
      <div>
        <label for="p-desc">설명</label>
        <textarea id="p-desc" placeholder="핵심 기능, 사용 기술 등을 간단히 적으세요." required></textarea>
      </div>
      <div>
        <label for="p-mainfile">대표 첨부파일 (선택)</label>
        <input id="p-mainfile" type="file" />
        <div class="hint">* 비워도 등록됩니다. 나중에 편집에서 교체/삭제 가능</div>
      </div>
      <div>
        <label for="p-tags">태그(쉼표 구분)</label>
        <input id="p-tags" type="text" placeholder="예: ar, firebase, esp32" />
      </div>
      <div class="row">
        <button type="submit">프로젝트 추가</button>
        <button type="reset" class="secondary">초기화</button>
      </div>
    </form>
  </section>

  <!-- 목록 -->
  <section id="section-list" class="card" style="display:none;" aria-labelledby="list-title">
    <div class="section-title">
      <h3 id="list-title">프로젝트 목록</h3>
      <div class="row" style="gap:8px;flex-wrap:wrap;">
        <input id="search-input" type="text" placeholder="검색: 키워드 또는 #태그" style="min-width:220px;padding:8px 10px;">
        <button id="btn-refresh" class="secondary">새로고침</button>
      </div>
    </div>
    <div id="project-list" class="list" aria-live="polite"></div>
  </section>

  <!-- 친구 목록 -->
  <section id="friends-card" class="card" style="display:none;" aria-labelledby="friends-title">
    <div class="section-title">
      <h3 id="friends-title">공유받은 친구 목록</h3>
      <div class="row">
        <button id="btn-friends-refresh" class="secondary">새로고침</button>
      </div>
    </div>
    <form id="form-friend-add" class="row" style="gap:8px;flex-wrap:wrap;">
      <input id="friend-input" type="text" placeholder="친구의 공유 링크 또는 UID" style="min-width:240px;padding:8px 10px;">
      <input id="friend-label" type="text" placeholder="표시 이름 (선택)" style="min-width:200px;padding:8px 10px;">
      <button type="submit">추가</button>
    </form>
    <div class="hint" style="margin-top:6px;">예) https://username.github.io/portfolio/?u=FRIEND_UID</div>
    <div id="friends-list" class="list" style="margin-top:10px;"></div>
  </section>

  <section class="card" style="margin-top:16px;" aria-labelledby="dev-title">
    <h3 id="dev-title">개발자 모드</h3>
    <div id="dev-log" class="muted" style="white-space:pre-wrap;"></div>
  </section>
</main>

<footer>
  <div class="wrap">© <span id="year"></span> 프로젝트 허브</div>
</footer>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<script>
/* ===== 유틸 ===== */
const $ = (sel, el=document) => el.querySelector(sel);
const log = (...a)=>{ console.log(...a); const box=$('#dev-log'); if(box){ box.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ') + "\\n"; } };
const fmtDate = ts => { if(!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); }
const escHtml = (s='') => String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const escAttr = (s='') => String(s).replace(/["']/g, c=>({"\"":"&quot;","'":"&#39;"}[c]));
function parseTags(str=''){ return String(str).split(/[,\s]+/).map(s=>s.trim().replace(/^#/,'').toLowerCase()).filter(Boolean).slice(0,10); }

/* ===== Firebase ===== */
const firebaseConfig = { apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00", authDomain:"propot-cc6bf.firebaseapp.com", projectId:"propot-cc6bf", storageBucket:"propot-cc6bf.firebasestorage.app", appId:"1:30940698980:web:1729f30e68d3beb24ac271" };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(); const db = firebase.firestore(); const storage = firebase.storage();

/* ===== 상태 ===== */
let currentUser = null, isAdmin = false;
let pageUid = null;
let loadedProjects = [];
const rolesRef = db.collection('roles');

/* ===== 인증 ===== */
const provider = new firebase.auth.GoogleAuthProvider();
$('#btn-login').addEventListener('click', async()=>{ try{ await auth.signInWithPopup(provider); }catch(e){ alert('로그인 실패: '+e.message);} });
$('#btn-logout').addEventListener('click', async()=>{ await auth.signOut(); });

auth.onAuthStateChanged(async user=>{
  currentUser = user;
  if(user){
    try{ const r = await rolesRef.doc(user.uid).get(); isAdmin = r.exists; }catch{ isAdmin=false; }
    $('#user-info').textContent = `${user.displayName} (${user.email})${isAdmin?' · 관리자':''}`;
    $('#btn-login').style.display='none'; $('#btn-logout').style.display='';
    $('#btn-go-my').style.display=''; $('#btn-need-login').style.display='none'; $('#btn-open-my').style.display='';
    $('#friends-card').style.display=''; // 로그인 시 친구 목록 노출
    loadFriends(); // 로그인/계정 변경 시 갱신
  }else{
    isAdmin=false;
    $('#user-info').textContent='로그인 필요';
    $('#btn-login').style.display=''; $('#btn-logout').style.display='none';
    $('#btn-go-my').style.display='none'; $('#btn-need-login').style.display=''; $('#btn-open-my').style.display='none';
    $('#friends-card').style.display='none';
  }
  reflectRoute();
});

/* ===== 라우팅 ===== */
function getQuery(key){ return new URLSearchParams(location.search).get(key); }

function showLanding(){
  $('#landing').style.display='';
  $('#portfolio-head').style.display='none';
  $('#section-add').style.display='none';
  $('#section-list').style.display='none';
}

function showPortfolio(){
  $('#landing').style.display='none';
  $('#portfolio-head').style.display='';
  $('#section-add').style.display='';
  $('#section-list').style.display='';
}

async function reflectRoute(){
  pageUid = getQuery('u');
  if(!pageUid){ showLanding(); return; }

  const mine = currentUser && currentUser.uid === pageUid;
  $('#owner-title').textContent = mine ? '내 포트폴리오' : '사용자 포트폴리오';
  $('#owner-sub').textContent   = mine ? '이 URL을 공유하면 친구들이 내 페이지에 글을 쓸 수 있어요.' : '이 페이지에 글을 올리려면 로그인하세요.';
  $('#btn-open-my').style.display = mine ? 'none' : (currentUser ? '' : 'none');
  showPortfolio();
  updateAddFriendButtonState(); // 이 페이지 저장 버튼 상태
  await loadProjects();
}

window.addEventListener('popstate', reflectRoute);
$('#btn-go-my').addEventListener('click', ()=>{ if(currentUser) location.search = `?u=${currentUser.uid}`; });
$('#btn-need-login').addEventListener('click', ()=>$('#btn-login').click());
$('#btn-open-my').addEventListener('click', ()=>{ if(currentUser) location.search=`?u=${currentUser.uid}`; });
$('#btn-copy-link').addEventListener('click', async ()=>{
  if(!pageUid){ return alert('페이지 UID가 없습니다.'); }
  const url = `${location.origin}${location.pathname}?u=${encodeURIComponent(pageUid)}`;
  try{ await navigator.clipboard.writeText(url); alert('공유 링크를 복사했어요!\n' + url); }catch{ prompt('복사해서 공유하세요:', url); }
});

/* ===== "이 페이지 저장" (친구목록에 추가) ===== */
function friendsCol(){ return currentUser ? db.collection('users').doc(currentUser.uid).collection('friends') : null; }

async function updateAddFriendButtonState(){
  const btn = $('#btn-add-friend');
  if(!btn){return;}
  if(!currentUser || !pageUid || (currentUser.uid===pageUid)){
    btn.style.display = 'none';
    return;
  }
  try{
    const doc = await friendsCol().doc(pageUid).get();
    btn.style.display = '';
    btn.textContent = doc.exists ? '저장됨' : '이 페이지 저장';
    btn.disabled = doc.exists;
  }catch{ btn.style.display=''; btn.textContent='이 페이지 저장'; btn.disabled=false; }
}
$('#btn-add-friend').addEventListener('click', async ()=>{
  if(!currentUser) return alert('로그인이 필요합니다.');
  if(!pageUid) return;
  try{
    await friendsCol().doc(pageUid).set({
      friendUid: pageUid,
      label: null,
      addedAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastVisitedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    updateAddFriendButtonState();
    loadFriends();
    alert('친구 목록에 저장했어요!');
  }catch(e){ alert('저장 실패: '+e.message); }
});

/* ===== 새 글 등록 ===== */
$('#form-project').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!pageUid) return alert('페이지가 정해지지 않았어요. 먼저 URL에 ?u=... 형태로 접근하세요.');
  const user = auth.currentUser; if(!user) return alert('로그인이 필요합니다.');
  const title = $('#p-title').value.trim(); const desc = $('#p-desc').value.trim(); if(!title||!desc) return alert('제목/설명을 입력하세요.');
  const tags = parseTags($('#p-tags')?.value||'');
  const mainFile = $('#p-mainfile')?.files?.[0] || null;

  try{
    const ref = await db.collection('projects').add({
      ownerUid: pageUid,
      title, desc, tags, mainFile:null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      authorUid: user.uid, authorName: user.displayName || '익명', authorEmail: user.email || null
    });
    if(mainFile){
      if(mainFile.size > 10*1024*1024) return alert('대표 첨부는 10MB 이하!');
      const p=`uploads/${ref.id}/main_${Date.now()}_${mainFile.name}`;
      const snap=await storage.ref().child(p).put(mainFile,{customMetadata:{ownerUid:user.uid}});
      const url=await snap.ref.getDownloadURL();
      await ref.update({ mainFile:{ name:mainFile.name,size:mainFile.size,contentType:mainFile.type,url,storagePath:p,uploadedAt:firebase.firestore.FieldValue.serverTimestamp(),ownerUid:user.uid } });
    }
    e.target.reset();
    loadProjects();
  }catch(err){ alert('등록 실패: '+err.message); }
});

/* ===== 목록 로드 ===== */
const listEl = $('#project-list');
$('#btn-refresh').addEventListener('click', loadProjects);
$('#search-input')?.addEventListener('input', applyFilter);

async function loadProjects(){
  if(!pageUid){ listEl.innerHTML=''; return; }
  listEl.innerHTML='<div class="muted">불러오는 중…</div>';
  try{
    const snap = await db.collection('projects').where('ownerUid','==',pageUid).orderBy('createdAt','desc').limit(100).get();
    loadedProjects = []; snap.forEach(d=>loadedProjects.push({id:d.id,data:d.data()}));
  }catch(e){
    log('인덱스 필요 혹은 쿼리 실패, 클라 정렬 fallback 사용:', e.message||e);
    const snap = await db.collection('projects').where('ownerUid','==',pageUid).limit(100).get();
    loadedProjects = []; snap.forEach(d=>loadedProjects.push({id:d.id,data:d.data()}));
    loadedProjects.sort((a,b)=> (b.data.createdAt?.toMillis?.()||0) - (a.data.createdAt?.toMillis?.()||0));
  }
  renderProjects(loadedProjects);
  applyFilter();
}

function applyFilter(){
  const input = $('#search-input'); if(!input){ renderProjects(loadedProjects); return; }
  const q = (input.value||'').trim(); if(!q){ renderProjects(loadedProjects); return; }
  const tokens=q.split(/\s+/);
  const tagFilt=tokens.filter(t=>t.startsWith('#')).map(t=>t.slice(1).toLowerCase());
  const kw=tokens.filter(t=>!t.startsWith('#')).map(t=>t.toLowerCase());
  const filtered = loadedProjects.filter(({data})=>{
    const hay=(data.title+' '+data.desc+' '+(data.authorName||'')+' '+(data.tags||[]).join(' ')).toLowerCase();
    const tags=(data.tags||[]).map(t=>String(t).toLowerCase());
    const okTags=tagFilt.length===0||tagFilt.every(t=>tags.includes(t));
    const okKw=kw.length===0||kw.every(k=>hay.includes(k));
    return okTags&&okKw;
  });
  renderProjects(filtered);
}

/* ===== 렌더 (프로젝트 카드 + 댓글/파일 섹션) ===== */
const selComments = new Map(); // pid -> Set(cid)
const selFiles = new Map();    // pid -> Set(fid)
const selectingC = new Set();
const selectingF = new Set();

function renderProjects(list){
  listEl.innerHTML='';
  if(!list||!list.length){ listEl.innerHTML='<div class="muted">아직 등록된 프로젝트가 없습니다.</div>'; return; }
  list.forEach(({id,data})=> renderProject(id,data));
}

function renderProject(id,data){
  const canManagePost = currentUser && (currentUser.uid===data.authorUid || currentUser.uid===data.ownerUid || isAdmin);
  const card = document.createElement('article'); card.className='project';
  card.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:flex-start;">
      <div>
        <div id="view-${id}-head"><h3>${escHtml(data.title)}</h3><div class="muted" style="margin-bottom:6px;">by ${escHtml(data.authorName||'익명')} · ${fmtDate(data.createdAt)}</div></div>
        <form id="edit-${id}-form" class="grid" style="gap:8px;display:none;">
          <input id="e-title-${id}" type="text" value="${escAttr(data.title)}" required />
          <textarea id="e-desc-${id}" required>${escHtml(data.desc)}</textarea>
          <div class="grid" style="gap:6px;">
            <div class="muted">대표 첨부: ${data.mainFile&&data.mainFile.name?escHtml(data.mainFile.name):'없음'}</div>
            <div class="row" style="gap:6px;flex-wrap:wrap;">
              <input type="file" id="e-mainfile-${id}" />
              ${data.mainFile&&data.mainFile.url?`<a class="chip" href="${escAttr(data.mainFile.url)}" target="_blank" rel="noopener">현재 첨부 열기</a>`:''}
              ${data.mainFile?`<button type="button" class="danger mini" id="e-mainfile-del-${id}">첨부 삭제</button>`:''}
              <button type="button" class="secondary mini" id="e-mainfile-up-${id}">첨부 교체 업로드</button>
            </div>
          </div>
        </form>
      </div>
      <div class="right-wrap">
        <div class="badges has-actions">
          ${data.mainFile&&data.mainFile.url?`<a class="chip" href="${escAttr(data.mainFile.url)}" target="_blank" rel="noopener">첨부 보기</a>`:''}
          ${data.mainFile&&data.mainFile.name?`<span class="chip">${escHtml(data.mainFile.name)}</span>`:''}
          <span class="chip">ID: ${id}</span>
        </div>
        ${canManagePost?`
        <div class="manage">
          <button class="ghost mini" id="btn-edit-${id}">수정</button>
          <button class="danger mini" id="btn-del-${id}">삭제</button>
          <button class="secondary mini" id="btn-save-${id}" style="display:none;">저장</button>
          <button class="ghost mini" id="btn-cancel-${id}" style="display:none;">취소</button>
        </div>`:''}
      </div>
    </div>
    <div id="view-${id}-desc"><p>${escHtml(data.desc)}</p></div>

    <div class="grid cols-2" style="margin-top:8px;">
      <div>
        <h4 style="margin:6px 0;">💬 댓글</h4>
        <div class="row" id="c-toolbar-${id}" style="gap:6px;flex-wrap:wrap;">
          <button class="ghost mini" id="c-enter-${id}">선택</button>
          <button class="secondary mini" id="c-edit-${id}" style="display:none;" disabled>선택 수정(1개)</button>
          <button class="danger mini" id="c-del-${id}" style="display:none;" disabled>선택 삭제</button>
          <span class="muted" id="c-count-${id}" style="display:none;">0개 선택</span>
          <button class="ghost mini" id="c-cancel-${id}" style="display:none;">취소</button>
        </div>
        <div class="list" id="comments-${id}"></div>
        <form class="grid" id="form-comment-${id}" style="gap:8px;margin-top:8px;">
          <label for="c-${id}" class="sr-only">댓글</label>
          <textarea id="c-${id}" placeholder="의견을 남겨주세요 (로그인 필요)" required></textarea>
          <div class="row"><button type="submit" class="secondary">댓글 등록</button></div>
        </form>
      </div>
      <div>
        <h4 style="margin:6px 0;">📎 파일 업로드</h4>
        <div class="row" id="f-toolbar-${id}" style="gap:6px;flex-wrap:wrap;">
          <button class="ghost mini" id="f-enter-${id}">선택</button>
          <button class="secondary mini" id="f-rename-${id}" style="display:none;" disabled>이름수정(1개)</button>
          <input type="file" id="f-repl-input-${id}" style="display:none;" />
          <button class="secondary mini" id="f-replace-${id}" style="display:none;" disabled>파일교체(1개)</button>
          <button class="danger mini" id="f-del-${id}" style="display:none;" disabled>선택 삭제</button>
          <span class="muted" id="f-count-${id}" style="display:none;">0개 선택</span>
          <button class="ghost mini" id="f-cancel-${id}" style="display:none;">취소</button>
        </div>
        <div class="list" id="files-${id}"></div>
        <form class="row" id="form-file-${id}" style="margin-top:8px;flex-wrap:wrap;">
          <input type="file" id="f-${id}" />
          <button type="submit">업로드</button>
        </form>
      </div>
    </div>`;
  listEl.appendChild(card);

  /* 게시글 수정/삭제 */
  if(canManagePost){
    const btnEdit=$(`#btn-edit-${id}`), btnDel=$(`#btn-del-${id}`), btnSave=$(`#btn-save-${id}`), btnCancel=$(`#btn-cancel-${id}`);
    const editForm=$(`#edit-${id}-form`), viewHead=$(`#view-${id}-head`), viewDesc=$(`#view-${id}-desc`);
    const enter=()=>{ editForm.style.display=''; viewHead.style.display='none'; viewDesc.style.display='none'; btnEdit.style.display='none'; btnDel.style.display='none'; btnSave.style.display=''; btnCancel.style.display=''; };
    const exit =()=>{ editForm.style.display='none'; viewHead.style.display=''; viewDesc.style.display=''; btnEdit.style.display=''; btnDel.style.display=''; btnSave.style.display='none'; btnCancel.style.display='none'; };
    const save =async()=>{ const t=$(`#e-title-${id}`).value.trim(), d=$(`#e-desc-${id}`).value.trim(); if(!t||!d) return alert('제목/설명을 입력하세요.');
      try{ await db.collection('projects').doc(id).update({ title:t, desc:d, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); loadProjects(); }catch(e){ alert('수정 실패: '+e.message); } };
    btnEdit?.addEventListener('click', enter); btnCancel?.addEventListener('click', exit); btnSave?.addEventListener('click', save);
    btnDel?.addEventListener('click', async()=>{
      if(!confirm('프로젝트를 삭제하면 댓글/파일도 함께 지워집니다. 진행할까요?')) return;
      try{
        const ref=db.collection('projects').doc(id);
        let cs=await ref.collection('comments').limit(500).get();
        while(!cs.empty){ const b=db.batch(); cs.docs.forEach(d=>b.delete(d.ref)); await b.commit(); cs=await ref.collection('comments').limit(500).get(); }
        const fs=await ref.collection('files').limit(500).get();
        for(const d of fs.docs){ const f=d.data(); if(f.storagePath){ try{ await storage.ref().child(f.storagePath).delete(); }catch(err){ log('스토리지 삭제 실패:',err.message||err);} } await d.ref.delete(); }
        if(data.mainFile&&data.mainFile.storagePath){ try{ await storage.ref().child(data.mainFile.storagePath).delete(); }catch(err){ log('대표 삭제 실패:',err.message||err);} }
        await ref.delete(); loadProjects();
      }catch(e){ alert('삭제 실패: '+e.message); }
    });
    // 대표 첨부 교체/삭제
    const mainInp=$(`#e-mainfile-${id}`), mainUp=$(`#e-mainfile-up-${id}`), mainDel=$(`#e-mainfile-del-${id}`);
    mainUp?.addEventListener('click', async()=>{
      const f=mainInp?.files?.[0]; if(!f) return alert('파일을 선택하세요.'); if(f.size>10*1024*1024) return alert('10MB 이하만 업로드');
      try{ const p=`uploads/${id}/main_${Date.now()}_${f.name}`; const ref=storage.ref().child(p); await ref.put(f,{customMetadata:{ownerUid:(auth.currentUser&&auth.currentUser.uid)||''}}); const url=await ref.getDownloadURL();
        await db.collection('projects').doc(id).update({ mainFile:{name:f.name,size:f.size,contentType:f.type,url,storagePath:p,uploadedAt:firebase.firestore.FieldValue.serverTimestamp(),ownerUid:(auth.currentUser&&auth.currentUser.uid)||''}, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        if(data.mainFile?.storagePath){ try{ await storage.ref().child(data.mainFile.storagePath).delete(); }catch{} } loadProjects();
      }catch(e){ alert('첨부 교체 실패: '+e.message); }
    });
    mainDel?.addEventListener('click', async()=>{
      if(!confirm('대표 첨부를 삭제할까요?')) return;
      try{ if(data.mainFile?.storagePath){ try{ await storage.ref().child(data.mainFile.storagePath).delete(); }catch{} }
        await db.collection('projects').doc(id).update({ mainFile:null, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); loadProjects();
      }catch(e){ alert('첨부 삭제 실패: '+e.message); }
    });
  }

  // 댓글/파일 툴바와 목록
  setupCommentToolbar(id); loadComments(id);
  setupFileToolbar(id);    loadFiles(id);
  $(`#form-comment-${id}`)?.addEventListener('submit', ev=>addComment(ev,id));
  $(`#form-file-${id}`)?.addEventListener('submit', ev=>uploadFile(ev,id));
}

/* ===== 선택 모드 툴바 ===== */
function setupCommentToolbar(pid){
  const enter  = document.getElementById(`c-enter-${pid}`);
  const edit   = document.getElementById(`c-edit-${pid}`);
  const del    = document.getElementById(`c-del-${pid}`);
  const cancel = document.getElementById(`c-cancel-${pid}`);
  const count  = document.getElementById(`c-count-${pid}`);
  selComments.set(pid, new Set());
  const updateUI = ()=>{ const n=selComments.get(pid).size; if(count) count.textContent=`${n}개 선택`; if(edit) edit.disabled=(n!==1); if(del) del.disabled=(n===0); };
  enter?.addEventListener('click', ()=>{ document.getElementById(`comments-${pid}`)?.classList.add('selecting'); if(edit)edit.style.display=''; if(del)del.style.display=''; if(count)count.style.display=''; if(cancel)cancel.style.display=''; if(enter)enter.style.display='none'; updateUI(); });
  cancel?.addEventListener('click', ()=>{ selComments.set(pid,new Set()); const list=document.getElementById(`comments-${pid}`); list?.classList.remove('selecting'); list?.querySelectorAll('.select-cb').forEach(cb=>cb.checked=false); if(edit)edit.style.display='none'; if(del)del.style.display='none'; if(count)count.style.display='none'; if(cancel)cancel.style.display='none'; if(enter)enter.style.display=''; updateUI(); });
  edit?.addEventListener('click', async ()=>{ const set=selComments.get(pid); if(set.size!==1) return; const cid=[...set][0]; let cur=''; try{ const d=await db.collection('projects').doc(pid).collection('comments').doc(cid).get(); cur=(d.data()&&d.data().text)||'';}catch{} const next=prompt('새 댓글 내용', cur); if(next==null) return; const nv=(next||'').trim(); if(!nv) return alert('내용을 입력하세요.'); try{ await db.collection('projects').doc(pid).collection('comments').doc(cid).update({ text:nv, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); loadComments(pid); }catch(e){ alert('댓글 수정 실패: '+e.message);} });
  del?.addEventListener('click', async ()=>{ const set=selComments.get(pid); if(set.size===0) return; if(!confirm(`${set.size}개 댓글을 삭제할까요?`)) return; try{ const b=db.batch(); set.forEach(cid=>b.delete(db.collection('projects').doc(pid).collection('comments').doc(cid))); await b.commit(); loadComments(pid);}catch(e){ alert('댓글 삭제 실패: '+e.message);} });
  enter && (enter._update = updateUI);
}
function setupFileToolbar(pid){
  const enter=document.getElementById(`f-enter-${pid}`), ren=document.getElementById(`f-rename-${pid}`), repIn=document.getElementById(`f-repl-input-${pid}`), rep=document.getElementById(`f-replace-${pid}`), del=document.getElementById(`f-del-${pid}`), cancel=document.getElementById(`f-cancel-${pid}`), count=document.getElementById(`f-count-${pid}`);
  selFiles.set(pid,new Set());
  const updateUI=()=>{ const n=selFiles.get(pid).size; if(count)count.textContent=`${n}개 선택`; if(ren)ren.disabled=(n!==1); if(rep)rep.disabled=(n!==1); if(del)del.disabled=(n===0); if(repIn)repIn.style.display=(n===1)?'':'none'; };
  enter?.addEventListener('click', ()=>{ document.getElementById(`files-${pid}`)?.classList.add('selecting'); if(ren)ren.style.display=''; if(rep)rep.style.display=''; if(del)del.style.display=''; if(count)count.style.display=''; if(cancel)cancel.style.display=''; if(enter)enter.style.display='none'; updateUI(); });
  cancel?.addEventListener('click', ()=>{ selFiles.set(pid,new Set()); const list=document.getElementById(`files-${pid}`); list?.classList.remove('selecting'); list?.querySelectorAll('.select-cb').forEach(cb=>cb.checked=false); if(ren)ren.style.display='none'; if(rep)rep.style.display='none'; if(del)del.style.display='none'; if(count)count.style.display='none'; if(cancel)cancel.style.display='none'; if(enter)enter.style.display=''; if(repIn)repIn.style.display='none'; updateUI(); });
  ren?.addEventListener('click', async ()=>{ const set=selFiles.get(pid); if(set.size!==1) return; const fid=[...set][0]; let cur=''; try{ const d=await db.collection('projects').doc(pid).collection('files').doc(fid).get(); cur=(d.data()&&d.data().name)||'';}catch{} const next=prompt('새 파일 이름(표시용)', cur); if(next==null) return; try{ await db.collection('projects').doc(pid).collection('files').doc(fid).update({ name:(next.trim()||cur), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); loadFiles(pid);}catch(e){ alert('파일 이름 수정 실패: '+e.message);} });
  rep?.addEventListener('click', async ()=>{ const set=selFiles.get(pid); if(set.size!==1) return; const fid=[...set][0]; const nf=repIn?.files&&repIn.files[0]; if(!nf) return alert('교체할 새 파일을 선택하세요.'); if(nf.size>10*1024*1024) return alert('10MB 이하만 업로드'); try{ const doc=await db.collection('projects').doc(pid).collection('files').doc(fid).get(); const old=doc.data(); const path=`uploads/${pid}/${Date.now()}_${nf.name}`; const ref=storage.ref().child(path); await ref.put(nf,{customMetadata:{ownerUid:(old&&old.ownerUid)||(currentUser&&currentUser.uid)||''}}); const url=await ref.getDownloadURL(); await db.collection('projects').doc(pid).collection('files').doc(fid).update({ name:nf.name,size:nf.size,contentType:nf.type,url,storagePath:path,updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); if(old&&old.storagePath){ try{ await storage.ref().child(old.storagePath).delete(); }catch(err){ log('이전 파일 삭제 실패:',err.message||err);} } loadFiles(pid); repIn.value=''; }catch(e){ alert('파일 교체 실패: '+e.message);} });
  del?.addEventListener('click', async ()=>{ const set=selFiles.get(pid); if(set.size===0) return; if(!confirm(`${set.size}개 파일을 삭제할까요?`)) return; try{ for(const fid of set){ const doc=await db.collection('projects').doc(pid).collection('files').doc(fid).get(); const f=doc.data(); if(f?.storagePath){ try{ await storage.ref().child(f.storagePath).delete(); }catch(err){ log('스토리지 삭제 실패:',err.message||err);} } await db.collection('projects').doc(pid).collection('files').doc(fid).delete(); } loadFiles(pid); }catch(e){ alert('파일 삭제 실패: '+e.message);} });
  enter && (enter._update=updateUI);
}

/* ===== 댓글/파일 목록 ===== */
async function loadComments(pid){
  const box = document.getElementById('comments-'+pid);
  box.innerHTML='<div class="muted">불러오는 중…</div>';
  const snap = await db.collection('projects').doc(pid).collection('comments').orderBy('createdAt','desc').limit(100).get();
  box.innerHTML='';
  const set = selComments.get(pid)||new Set();
  snap.forEach(doc=>{
    const c=doc.data(); const cid=doc.id;
    const can = currentUser && (currentUser.uid===c.authorUid || currentUser.uid===pageUid || isAdmin);
    const idS = `${pid}-${cid}`;
    const el=document.createElement('div'); el.className='comment'; el.id='comment-'+idS;
    el.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:flex-start;">
        <div style="flex:1">
          <div class="muted" style="font-size:12px;">${escHtml(c.authorName||'익명')} · ${fmtDate(c.createdAt)}${c.updatedAt?' (수정됨)':''}</div>
          <div>${escHtml(c.text)}</div>
        </div>
        <div><input type="checkbox" class="select-cb" ${can?'':'disabled'} id="c-cb-${idS}" data-cid="${cid}"></div>
      </div>`;
    box.appendChild(el);
    const cb=el.querySelector(`#c-cb-${idS}`); if(cb){ cb.checked=set.has(cid); cb.addEventListener('change', ()=>{ const S=selComments.get(pid); if(cb.checked) S.add(cid); else S.delete(cid); const btn=document.getElementById(`c-enter-${pid}`); btn&&btn._update&&btn._update(); }); }
  });
  const btn=document.getElementById(`c-enter-${pid}`); btn&&btn._update&&btn._update();
}

async function addComment(e,pid){
  e.preventDefault(); const user=auth.currentUser; if(!user) return alert('로그인이 필요합니다.');
  const ta=document.getElementById('c-'+pid); const text=(ta.value||'').trim(); if(!text) return;
  try{ await db.collection('projects').doc(pid).collection('comments').add({ text, createdAt: firebase.firestore.FieldValue.serverTimestamp(), authorUid:user.uid, authorName:user.displayName||'익명' }); ta.value=''; loadComments(pid);}catch(e){ alert('댓글 실패: '+e.message); }
}

async function loadFiles(pid){
  const box=document.getElementById('files-'+pid);
  box.innerHTML='<div class="muted">불러오는 중…</div>';
  const snap=await db.collection('projects').doc(pid).collection('files').orderBy('createdAt','desc').limit(100).get();
  box.innerHTML='';
  const set=selFiles.get(pid)||new Set();
  snap.forEach(doc=>{
    const f=doc.data(); const fid=doc.id; const can=currentUser&&(currentUser.uid===f.ownerUid || currentUser.uid===pageUid || isAdmin);
    const idS=`${pid}-${fid}`; const isImg=(f.contentType||'').startsWith('image/');
    const row=document.createElement('div'); row.className='file-row'; row.id='file-'+idS;
    row.innerHTML=`
      <div class="flex" style="flex:1;gap:10px;">
        ${isImg?`<img class="thumb" src="${escAttr(f.url)}" alt="${escAttr(f.name||'image')}">`:''}
        <div>
          <div class="muted">${escHtml(f.name||'파일')} (${f.size||0}B)</div>
          <a href="${escAttr(f.url)}" target="_blank" rel="noopener">${isImg?'원본 열기':'다운로드'}</a>
          ${f.updatedAt?`<span class="chip" style="margin-left:6px;">수정됨</span>`:''}
        </div>
      </div>
      <div><input type="checkbox" class="select-cb" ${can?'':'disabled'} id="f-cb-${idS}" data-fid="${fid}"></div>`;
    box.appendChild(row);
    const cb=row.querySelector(`#f-cb-${idS}`); if(cb){ cb.checked=set.has(fid); cb.addEventListener('change', ()=>{ const S=selFiles.get(pid); if(cb.checked) S.add(fid); else S.delete(fid); const btn=document.getElementById(`f-enter-${pid}`); btn&&btn._update&&btn._update(); }); }
  });
  const btn=document.getElementById(`f-enter-${pid}`); btn&&btn._update&&btn._update();
}

async function uploadFile(e,pid){
  e.preventDefault(); const user=auth.currentUser; if(!user) return alert('로그인이 필요합니다.');
  const input=document.getElementById('f-'+pid); const file=input.files&&input.files[0]; if(!file) return alert('파일을 선택하세요.'); if(file.size>10*1024*1024) return alert('파일은 최대 10MB');
  try{ const path=`uploads/${pid}/${Date.now()}_${file.name}`; const ref=storage.ref().child(path); const snap=await ref.put(file,{customMetadata:{ownerUid:user.uid,ownerEmail:user.email||''}}); const url=await snap.ref.getDownloadURL();
    await db.collection('projects').doc(pid).collection('files').add({ name:file.name,size:file.size,contentType:file.type,url,storagePath:path,createdAt: firebase.firestore.FieldValue.serverTimestamp(), ownerUid:user.uid, ownerName:user.displayName||'익명' });
    input.value=''; loadFiles(pid);
  }catch(e){ alert('업로드 실패: '+e.message); }
}

/* ===== 친구 목록 (공유받음) ===== */
function parseFriendTarget(text){
  text = (text||'').trim();
  if(!text) return null;
  try{
    const url = new URL(text);
    const u = new URLSearchParams(url.search).get('u');
    if(u) return u;
  }catch(_){}
  const m = text.match(/[?&]u=([^&]+)/);
  if(m) return decodeURIComponent(m[1]);
  return text; // UID 로 간주
}

$('#form-friend-add').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!currentUser) return alert('로그인이 필요합니다.');
  const raw = $('#friend-input').value;
  const uid = parseFriendTarget(raw);
  if(!uid) return alert('올바른 링크/UID를 입력하세요.');
  const label = ($('#friend-label').value||'').trim() || null;
  try{
    await friendsCol().doc(uid).set({
      friendUid: uid,
      label,
      addedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    $('#friend-input').value=''; $('#friend-label').value='';
    loadFriends();
  }catch(e){ alert('추가 실패: '+e.message); }
});

$('#btn-friends-refresh').addEventListener('click', loadFriends);

async function loadFriends(){
  const box = $('#friends-list'); if(!box) return;
  if(!currentUser){ box.innerHTML = '<div class="muted">로그인하면 친구 목록을 볼 수 있어요.</div>'; return; }
  box.innerHTML = '<div class="muted">불러오는 중…</div>';
  try{
    const snap = await friendsCol().orderBy('addedAt','desc').limit(200).get();
    if(snap.empty){ box.innerHTML = '<div class="muted">아직 저장한 친구가 없습니다. 링크나 UID를 추가해보세요.</div>'; return; }
    box.innerHTML = '';
    snap.forEach(doc=>{
      const f = doc.data(); const friendUid = doc.id;
      const row = document.createElement('div'); row.className='friend-row';
      row.innerHTML = `
        <div style="flex:1;">
          <div><strong>${escHtml(f.label||'이름 미지정')}</strong></div>
          <div class="muted" style="font-size:12px;">UID: ${friendUid}${f.addedAt? ' · '+fmtDate(f.addedAt):''}</div>
        </div>
        <div class="row" style="gap:6px;">
          <button class="secondary mini" data-open>열기</button>
          <button class="ghost mini" data-rename>이름변경</button>
          <button class="danger mini" data-del>삭제</button>
        </div>`;
      box.appendChild(row);

      row.querySelector('[data-open]')?.addEventListener('click', async ()=>{
        // 방문 기록 업데이트(선택)
        try{ await friendsCol().doc(friendUid).set({ lastVisitedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true}); }catch{}
        location.search = `?u=${encodeURIComponent(friendUid)}`;
      });
      row.querySelector('[data-rename]')?.addEventListener('click', async ()=>{
        const cur = f.label || '';
        const next = prompt('표시 이름', cur);
        if(next===null) return;
        try{ await friendsCol().doc(friendUid).set({ label: (next.trim()||null) }, {merge:true}); loadFriends(); }catch(e){ alert('이름 변경 실패: '+e.message); }
      });
      row.querySelector('[data-del]')?.addEventListener('click', async ()=>{
        if(!confirm('이 친구를 목록에서 삭제할까요?')) return;
        try{ await friendsCol().doc(friendUid).delete(); loadFriends(); }catch(e){ alert('삭제 실패: '+e.message); }
      });
    });
  }catch(e){
    box.innerHTML = '<div class="muted">목록을 불러오지 못했습니다.</div>';
    log('loadFriends error', e.message||e);
  }
}

/* ===== 초기 ===== */
window.addEventListener('DOMContentLoaded', ()=>{ $('#year').textContent=new Date().getFullYear(); reflectRoute(); });
</script>

<!-- Firestore / Storage 규칙 예시 (페이지 소유자 권한 + 친구목록 보호) -->
<!--
Firestore:
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() { return request.auth != null && exists(/databases/$(database)/documents/roles/$(request.auth.uid)); }

    // 프로젝트/댓글/파일 (이전과 동일, ownerUid 포함)
    match /projects/{pid} {
      allow read: if true;
      allow create: if request.auth != null
                    && request.resource.data.authorUid == request.auth.uid
                    && request.resource.data.ownerUid is string;
      allow update, delete: if request.auth != null
                            && (resource.data.authorUid == request.auth.uid
                                || resource.data.ownerUid == request.auth.uid
                                || isAdmin());
      match /comments/{cid} {
        allow read: if true;
        allow create: if request.auth != null
                      && request.resource.data.authorUid == request.auth.uid
                      && request.resource.data.text.size() > 0
                      && request.resource.data.text.size() <= 2000;
        allow update, delete: if request.auth != null
                              && (resource.data.authorUid == request.auth.uid
                                  || get(/databases/$(database)/documents/projects/$(pid)).data.ownerUid == request.auth.uid
                                  || isAdmin());
      }
      match /files/{fid} {
        allow read: if true;
        allow create: if request.auth != null
                      && request.resource.data.ownerUid == request.auth.uid
                      && request.resource.data.size <= 10 * 1024 * 1024;
        allow update, delete: if request.auth != null
                              && (resource.data.ownerUid == request.auth.uid
                                  || get(/databases/$(database)/documents/projects/$(pid)).data.ownerUid == request.auth.uid
                                  || isAdmin());
      }
    }

    // 친구 목록(공유받음): 본인만 읽기/쓰기
    match /users/{uid}/friends/{fid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    match /roles/{uid} { allow read: if request.auth != null; allow write: if false; }
  }
}

Storage:
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /uploads/{pid}/{filename=**} {
      allow read: if true;
      allow write: if request.auth != null && request.resource.size < 10 * 1024 * 1024;
      // 업로더만 삭제로 제한하려면:
      // allow delete: if request.auth != null && request.auth.uid == resource.metadata.ownerUid;
    }
  }
}
-->
</body>
</html>
