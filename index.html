<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>í”„ë¡œì íŠ¸ í—ˆë¸Œ | ê°œì¸ í¬íŠ¸í´ë¦¬ì˜¤</title>
<style>
  :root{--bg:#0b1020;--card:#121a33;--muted:#8aa0c7;--text:#e9f0ff;--accent:#6da7ff;--accent-2:#8cffda;--danger:#ff6c6c}
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  a{color:var(--accent-2);text-decoration:none} a:hover{text-decoration:underline}
  header{position:sticky;top:0;backdrop-filter:blur(8px);background:#0b1020cc;border-bottom:1px solid #1e2a55;z-index:10}
  .wrap{max-width:1024px;margin:0 auto;padding:16px 20px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .brand{font-weight:800;letter-spacing:.2px}
  .tag{font-size:12px;color:var(--muted);border:1px solid #253159;padding:2px 8px;border-radius:999px}
  button,input,textarea,select{font:inherit}
  button{background:linear-gradient(135deg,var(--accent),#4f7fe0);color:#081225;border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
  button.secondary{background:#1b2750;color:var(--text);border:1px solid #2b3a78}
  button.ghost{background:transparent;color:var(--text);border:1px solid #2b3a78}
  button.danger{background:#2a0f14;color:#ffc7c7;border:1px solid #5a1e25}
  button.mini{padding:6px 10px;border-radius:10px;font-size:12px}
  .card{background:var(--card);border:1px solid #1d274b;border-radius:16px;padding:16px}
  .grid{display:grid;gap:16px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
  .muted{color:var(--muted)}
  label{display:block;font-weight:700;margin-bottom:6px;color:#b7c6eb}
  input[type="text"],textarea{width:100%;background:#0d152e;color:var(--text);border:1px solid #23305d;border-radius:12px;padding:10px 12px}
  textarea{min-height:90px;resize:vertical}
  .list{display:grid;gap:12px}
  .project{border:1px solid #23305d;border-radius:16px;padding:14px;background:#0f1731}
  .project h3{margin:0 0 4px}
  .badges{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{font-size:12px;padding:2px 8px;border:1px solid #2b3a78;border-radius:999px;color:#bcd0ff}
  .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:18px 0 8px}
  .comment{border-left:2px solid #334388;padding-left:10px;margin:8px 0}
  .file-row{display:flex;justify-content:space-between;align-items:center;gap:8px;background:#0c142c;border:1px solid #23305d;border-radius:12px;padding:8px 10px}
  .right{text-align:right}
  footer{color:#8aa0c7;padding:32px 0;text-align:center}
  .hint{font-size:12px;color:var(--muted)}
  .flex{display:flex;gap:8px;align-items:center}
  .thumb{width:160px;height:100px;border-radius:10px;object-fit:cover;border:1px solid #23305d}
  /* ìš°ìƒë‹¨ ì•¡ì…˜ */
  .right-wrap{position:relative;min-width:240px}
  .manage{position:absolute;top:-6px;right:-6px;display:flex;gap:6px;z-index:1}
  .badges.has-actions{padding-right:190px}
  @media (max-width:560px){.right-wrap{position:static}.manage{position:static;margin-top:6px}.badges.has-actions{padding-right:0}}
  /* ì„ íƒ ëª¨ë“œ ì²´í¬ë°•ìŠ¤ */
  .select-cb{display:none}
  .selecting .select-cb{display:inline-block}
  /* ëœë”© íˆì–´ë¡œ */
  .hero{display:grid;gap:14px;place-items:center;text-align:center;padding:40px 10px}
  /* ì¹œêµ¬ ëª©ë¡ ì•„ì´í…œ */
  .friend-row{display:flex;justify-content:space-between;align-items:center;gap:10px;background:#0c142c;border:1px solid #23305d;border-radius:12px;padding:10px}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="row" style="gap:10px;">
      <span class="brand">ğŸ“ í”„ë¡œì íŠ¸ í—ˆë¸Œ</span>
      <span class="tag">GitHub Pages + Firebase</span>
    </div>
    <div class="row" style="margin-left:auto;">
      <span id="user-info" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
      <button id="btn-login" class="secondary">Google ë¡œê·¸ì¸</button>
      <button id="btn-logout" class="ghost" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:18px;">
  <!-- ëœë”© -->
  <section id="landing" class="card">
    <div class="hero">
      <h2>ë‚˜ë§Œì˜ í¬íŠ¸í´ë¦¬ì˜¤ í˜ì´ì§€ ë§Œë“¤ê¸°</h2>
      <p class="muted">ë¡œê·¸ì¸í•˜ë©´ <strong>ë‚´ ì „ìš© URL</strong>ì´ ë§Œë“¤ì–´ì§€ê³ , ë§í¬ë¥¼ ê³µìœ í•˜ë©´ ì¹œêµ¬ë“¤ë„ ë‚´ í˜ì´ì§€ì— ê¸€/ëŒ“ê¸€/íŒŒì¼ì„ ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”.</p>
      <div class="row">
        <button id="btn-go-my" style="display:none;">ë‚´ í˜ì´ì§€ ì—´ê¸°</button>
        <button id="btn-need-login" class="secondary">ë¡œê·¸ì¸ë¶€í„° í•˜ê¸°</button>
      </div>
      <div class="hint">ë‚´ í˜ì´ì§€ URL í˜•ì‹: <code>?u=&lt;ë‚´ UID&gt;</code></div>
    </div>
  </section>

  <!-- í¬íŠ¸í´ë¦¬ì˜¤ í—¤ë” -->
  <section id="portfolio-head" class="card" style="display:none;">
    <div class="row" style="justify-content:space-between;align-items:center;">
      <div>
        <h2 id="owner-title" style="margin:0 0 6px;">ëˆ„êµ°ê°€ì˜ í¬íŠ¸í´ë¦¬ì˜¤</h2>
        <div class="muted" id="owner-sub">ì´ í˜ì´ì§€ì— ê¸€ì„ ì˜¬ë¦¬ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</div>
      </div>
      <div class="row" style="gap:8px;">
        <button id="btn-copy-link" class="ghost">ê³µìœ  ë§í¬ ë³µì‚¬</button>
        <button id="btn-add-friend" class="ghost" style="display:none;">ì´ í˜ì´ì§€ ì €ì¥</button>
        <button id="btn-open-my" class="secondary" style="display:none;">ë‚´ í˜ì´ì§€ë¡œ</button>
      </div>
    </div>
  </section>

  <!-- ìƒˆ í”„ë¡œì íŠ¸ ë“±ë¡ -->
  <section id="section-add" class="card" aria-labelledby="add-project-title" style="display:none;">
    <h3 id="add-project-title">ìƒˆ í”„ë¡œì íŠ¸ ë“±ë¡</h3>
    <p class="muted" style="margin-top:-4px;">ì´ í˜ì´ì§€ì˜ ì†Œìœ ì í¬íŠ¸í´ë¦¬ì˜¤ì— ë“±ë¡ë©ë‹ˆë‹¤. (ì‘ì„±ìëŠ” ë¡œê·¸ì¸ í•„ìš”)</p>
    <form id="form-project" class="grid" style="gap:10px;">
      <div>
        <label for="p-title">í”„ë¡œì íŠ¸ ì œëª©</label>
        <input id="p-title" type="text" placeholder="ì˜ˆ: ìŠ¤ë§ˆíŠ¸ ë„ì–´ë½" required />
      </div>
      <div>
        <label for="p-desc">ì„¤ëª…</label>
        <textarea id="p-desc" placeholder="í•µì‹¬ ê¸°ëŠ¥, ì‚¬ìš© ê¸°ìˆ  ë“±ì„ ê°„ë‹¨íˆ ì ìœ¼ì„¸ìš”." required></textarea>
      </div>
      <div>
        <label for="p-mainfile">ëŒ€í‘œ ì²¨ë¶€íŒŒì¼ (ì„ íƒ)</label>
        <input id="p-mainfile" type="file" />
        <div class="hint">* ë¹„ì›Œë„ ë“±ë¡ë©ë‹ˆë‹¤. ë‚˜ì¤‘ì— í¸ì§‘ì—ì„œ êµì²´/ì‚­ì œ ê°€ëŠ¥</div>
      </div>
      <div>
        <label for="p-tags">íƒœê·¸(ì‰¼í‘œ êµ¬ë¶„)</label>
        <input id="p-tags" type="text" placeholder="ì˜ˆ: ar, firebase, esp32" />
      </div>
      <div class="row">
        <button type="submit">í”„ë¡œì íŠ¸ ì¶”ê°€</button>
        <button type="reset" class="secondary">ì´ˆê¸°í™”</button>
      </div>
    </form>
  </section>

  <!-- ëª©ë¡ -->
  <section id="section-list" class="card" style="display:none;" aria-labelledby="list-title">
    <div class="section-title">
      <h3 id="list-title">í”„ë¡œì íŠ¸ ëª©ë¡</h3>
      <div class="row" style="gap:8px;flex-wrap:wrap;">
        <input id="search-input" type="text" placeholder="ê²€ìƒ‰: í‚¤ì›Œë“œ ë˜ëŠ” #íƒœê·¸" style="min-width:220px;padding:8px 10px;">
        <button id="btn-refresh" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div id="project-list" class="list" aria-live="polite"></div>
  </section>

  <!-- ì¹œêµ¬ ëª©ë¡ -->
  <section id="friends-card" class="card" style="display:none;" aria-labelledby="friends-title">
    <div class="section-title">
      <h3 id="friends-title">ê³µìœ ë°›ì€ ì¹œêµ¬ ëª©ë¡</h3>
      <div class="row">
        <button id="btn-friends-refresh" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <form id="form-friend-add" class="row" style="gap:8px;flex-wrap:wrap;">
      <input id="friend-input" type="text" placeholder="ì¹œêµ¬ì˜ ê³µìœ  ë§í¬ ë˜ëŠ” UID" style="min-width:240px;padding:8px 10px;">
      <input id="friend-label" type="text" placeholder="í‘œì‹œ ì´ë¦„ (ì„ íƒ)" style="min-width:200px;padding:8px 10px;">
      <button type="submit">ì¶”ê°€</button>
    </form>
    <div class="hint" style="margin-top:6px;">ì˜ˆ) https://username.github.io/portfolio/?u=FRIEND_UID</div>
    <div id="friends-list" class="list" style="margin-top:10px;"></div>
  </section>

  <section class="card" style="margin-top:16px;" aria-labelledby="dev-title">
    <h3 id="dev-title">ê°œë°œì ëª¨ë“œ</h3>
    <div id="dev-log" class="muted" style="white-space:pre-wrap;"></div>
  </section>
</main>

<footer>
  <div class="wrap">Â© <span id="year"></span> í”„ë¡œì íŠ¸ í—ˆë¸Œ</div>
</footer>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<script>
/* ===== ìœ í‹¸ ===== */
const $ = (sel, el=document) => el.querySelector(sel);
const log = (...a)=>{ console.log(...a); const box=$('#dev-log'); if(box){ box.textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ') + "\\n"; } };
const fmtDate = ts => { if(!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); }
const escHtml = (s='') => String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const escAttr = (s='') => String(s).replace(/["']/g, c=>({"\"":"&quot;","'":"&#39;"}[c]));
function parseTags(str=''){ return String(str).split(/[,\s]+/).map(s=>s.trim().replace(/^#/,'').toLowerCase()).filter(Boolean).slice(0,10); }

/* ===== Firebase ===== */
const firebaseConfig = { apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00", authDomain:"propot-cc6bf.firebaseapp.com", projectId:"propot-cc6bf", storageBucket:"propot-cc6bf.firebasestorage.app", appId:"1:30940698980:web:1729f30e68d3beb24ac271" };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(); const db = firebase.firestore(); const storage = firebase.storage();

/* ===== ìƒíƒœ ===== */
let currentUser = null, isAdmin = false;
let pageUid = null;
let loadedProjects = [];
const rolesRef = db.collection('roles');

/* ===== ì¸ì¦ ===== */
const provider = new firebase.auth.GoogleAuthProvider();
$('#btn-login').addEventListener('click', async()=>{ try{ await auth.signInWithPopup(provider); }catch(e){ alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.message);} });
$('#btn-logout').addEventListener('click', async()=>{ await auth.signOut(); });

auth.onAuthStateChanged(async user=>{
  currentUser = user;
  if(user){
    try{ const r = await rolesRef.doc(user.uid).get(); isAdmin = r.exists; }catch{ isAdmin=false; }
    $('#user-info').textContent = `${user.displayName} (${user.email})${isAdmin?' Â· ê´€ë¦¬ì':''}`;
    $('#btn-login').style.display='none'; $('#btn-logout').style.display='';
    $('#btn-go-my').style.display=''; $('#btn-need-login').style.display='none'; $('#btn-open-my').style.display='';
    $('#friends-card').style.display=''; // ë¡œê·¸ì¸ ì‹œ ì¹œêµ¬ ëª©ë¡ ë…¸ì¶œ
    loadFriends(); // ë¡œê·¸ì¸/ê³„ì • ë³€ê²½ ì‹œ ê°±ì‹ 
  }else{
    isAdmin=false;
    $('#user-info').textContent='ë¡œê·¸ì¸ í•„ìš”';
    $('#btn-login').style.display=''; $('#btn-logout').style.display='none';
    $('#btn-go-my').style.display='none'; $('#btn-need-login').style.display=''; $('#btn-open-my').style.display='none';
    $('#friends-card').style.display='none';
  }
  reflectRoute();
});

/* ===== ë¼ìš°íŒ… ===== */
function getQuery(key){ return new URLSearchParams(location.search).get(key); }

function showLanding(){
  $('#landing').style.display='';
  $('#portfolio-head').style.display='none';
  $('#section-add').style.display='none';
  $('#section-list').style.display='none';
}

function showPortfolio(){
  $('#landing').style.display='none';
  $('#portfolio-head').style.display='';
  $('#section-add').style.display='';
  $('#section-list').style.display='';
}

async function reflectRoute(){
  pageUid = getQuery('u');
  if(!pageUid){ showLanding(); return; }

  const mine = currentUser && currentUser.uid === pageUid;
  $('#owner-title').textContent = mine ? 'ë‚´ í¬íŠ¸í´ë¦¬ì˜¤' : 'ì‚¬ìš©ì í¬íŠ¸í´ë¦¬ì˜¤';
  $('#owner-sub').textContent   = mine ? 'ì´ URLì„ ê³µìœ í•˜ë©´ ì¹œêµ¬ë“¤ì´ ë‚´ í˜ì´ì§€ì— ê¸€ì„ ì“¸ ìˆ˜ ìˆì–´ìš”.' : 'ì´ í˜ì´ì§€ì— ê¸€ì„ ì˜¬ë¦¬ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.';
  $('#btn-open-my').style.display = mine ? 'none' : (currentUser ? '' : 'none');
  showPortfolio();
  updateAddFriendButtonState(); // ì´ í˜ì´ì§€ ì €ì¥ ë²„íŠ¼ ìƒíƒœ
  await loadProjects();
}

window.addEventListener('popstate', reflectRoute);
$('#btn-go-my').addEventListener('click', ()=>{ if(currentUser) location.search = `?u=${currentUser.uid}`; });
$('#btn-need-login').addEventListener('click', ()=>$('#btn-login').click());
$('#btn-open-my').addEventListener('click', ()=>{ if(currentUser) location.search=`?u=${currentUser.uid}`; });
$('#btn-copy-link').addEventListener('click', async ()=>{
  if(!pageUid){ return alert('í˜ì´ì§€ UIDê°€ ì—†ìŠµë‹ˆë‹¤.'); }
  const url = `${location.origin}${location.pathname}?u=${encodeURIComponent(pageUid)}`;
  try{ await navigator.clipboard.writeText(url); alert('ê³µìœ  ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”!\n' + url); }catch{ prompt('ë³µì‚¬í•´ì„œ ê³µìœ í•˜ì„¸ìš”:', url); }
});

/* ===== "ì´ í˜ì´ì§€ ì €ì¥" (ì¹œêµ¬ëª©ë¡ì— ì¶”ê°€) ===== */
function friendsCol(){ return currentUser ? db.collection('users').doc(currentUser.uid).collection('friends') : null; }

async function updateAddFriendButtonState(){
  const btn = $('#btn-add-friend');
  if(!btn){return;}
  if(!currentUser || !pageUid || (currentUser.uid===pageUid)){
    btn.style.display = 'none';
    return;
  }
  try{
    const doc = await friendsCol().doc(pageUid).get();
    btn.style.display = '';
    btn.textContent = doc.exists ? 'ì €ì¥ë¨' : 'ì´ í˜ì´ì§€ ì €ì¥';
    btn.disabled = doc.exists;
  }catch{ btn.style.display=''; btn.textContent='ì´ í˜ì´ì§€ ì €ì¥'; btn.disabled=false; }
}
$('#btn-add-friend').addEventListener('click', async ()=>{
  if(!currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  if(!pageUid) return;
  try{
    await friendsCol().doc(pageUid).set({
      friendUid: pageUid,
      label: null,
      addedAt: firebase.firestore.FieldValue.serverTimestamp(),
      lastVisitedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    updateAddFriendButtonState();
    loadFriends();
    alert('ì¹œêµ¬ ëª©ë¡ì— ì €ì¥í–ˆì–´ìš”!');
  }catch(e){ alert('ì €ì¥ ì‹¤íŒ¨: '+e.message); }
});

/* ===== ìƒˆ ê¸€ ë“±ë¡ ===== */
$('#form-project').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!pageUid) return alert('í˜ì´ì§€ê°€ ì •í•´ì§€ì§€ ì•Šì•˜ì–´ìš”. ë¨¼ì € URLì— ?u=... í˜•íƒœë¡œ ì ‘ê·¼í•˜ì„¸ìš”.');
  const user = auth.currentUser; if(!user) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  const title = $('#p-title').value.trim(); const desc = $('#p-desc').value.trim(); if(!title||!desc) return alert('ì œëª©/ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
  const tags = parseTags($('#p-tags')?.value||'');
  const mainFile = $('#p-mainfile')?.files?.[0] || null;

  try{
    const ref = await db.collection('projects').add({
      ownerUid: pageUid,
      title, desc, tags, mainFile:null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      authorUid: user.uid, authorName: user.displayName || 'ìµëª…', authorEmail: user.email || null
    });
    if(mainFile){
      if(mainFile.size > 10*1024*1024) return alert('ëŒ€í‘œ ì²¨ë¶€ëŠ” 10MB ì´í•˜!');
      const p=`uploads/${ref.id}/main_${Date.now()}_${mainFile.name}`;
      const snap=await storage.ref().child(p).put(mainFile,{customMetadata:{ownerUid:user.uid}});
      const url=await snap.ref.getDownloadURL();
      await ref.update({ mainFile:{ name:mainFile.name,size:mainFile.size,contentType:mainFile.type,url,storagePath:p,uploadedAt:firebase.firestore.FieldValue.serverTimestamp(),ownerUid:user.uid } });
    }
    e.target.reset();
    loadProjects();
  }catch(err){ alert('ë“±ë¡ ì‹¤íŒ¨: '+err.message); }
});

/* ===== ëª©ë¡ ë¡œë“œ ===== */
const listEl = $('#project-list');
$('#btn-refresh').addEventListener('click', loadProjects);
$('#search-input')?.addEventListener('input', applyFilter);

async function loadProjects(){
  if(!pageUid){ listEl.innerHTML=''; return; }
  listEl.innerHTML='<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
  try{
    const snap = await db.collection('projects').where('ownerUid','==',pageUid).orderBy('createdAt','desc').limit(100).get();
    loadedProjects = []; snap.forEach(d=>loadedProjects.push({id:d.id,data:d.data()}));
  }catch(e){
    log('ì¸ë±ìŠ¤ í•„ìš” í˜¹ì€ ì¿¼ë¦¬ ì‹¤íŒ¨, í´ë¼ ì •ë ¬ fallback ì‚¬ìš©:', e.message||e);
    const snap = await db.collection('projects').where('ownerUid','==',pageUid).limit(100).get();
    loadedProjects = []; snap.forEach(d=>loadedProjects.push({id:d.id,data:d.data()}));
    loadedProjects.sort((a,b)=> (b.data.createdAt?.toMillis?.()||0) - (a.data.createdAt?.toMillis?.()||0));
  }
  renderProjects(loadedProjects);
  applyFilter();
}

function applyFilter(){
  const input = $('#search-input'); if(!input){ renderProjects(loadedProjects); return; }
  const q = (input.value||'').trim(); if(!q){ renderProjects(loadedProjects); return; }
  const tokens=q.split(/\s+/);
  const tagFilt=tokens.filter(t=>t.startsWith('#')).map(t=>t.slice(1).toLowerCase());
  const kw=tokens.filter(t=>!t.startsWith('#')).map(t=>t.toLowerCase());
  const filtered = loadedProjects.filter(({data})=>{
    const hay=(data.title+' '+data.desc+' '+(data.authorName||'')+' '+(data.tags||[]).join(' ')).toLowerCase();
    const tags=(data.tags||[]).map(t=>String(t).toLowerCase());
    const okTags=tagFilt.length===0||tagFilt.every(t=>tags.includes(t));
    const okKw=kw.length===0||kw.every(k=>hay.includes(k));
    return okTags&&okKw;
  });
  renderProjects(filtered);
}

/* ===== ë Œë” (í”„ë¡œì íŠ¸ ì¹´ë“œ + ëŒ“ê¸€/íŒŒì¼ ì„¹ì…˜) ===== */
const selComments = new Map(); // pid -> Set(cid)
const selFiles = new Map();    // pid -> Set(fid)
const selectingC = new Set();
const selectingF = new Set();

function renderProjects(list){
  listEl.innerHTML='';
  if(!list||!list.length){ listEl.innerHTML='<div class="muted">ì•„ì§ ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  list.forEach(({id,data})=> renderProject(id,data));
}

function renderProject(id,data){
  const canManagePost = currentUser && (currentUser.uid===data.authorUid || currentUser.uid===data.ownerUid || isAdmin);
  const card = document.createElement('article'); card.className='project';
  card.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:flex-start;">
      <div>
        <div id="view-${id}-head"><h3>${escHtml(data.title)}</h3><div class="muted" style="margin-bottom:6px;">by ${escHtml(data.authorName||'ìµëª…')} Â· ${fmtDate(data.createdAt)}</div></div>
        <form id="edit-${id}-form" class="grid" style="gap:8px;display:none;">
          <input id="e-title-${id}" type="text" value="${escAttr(data.title)}" required />
          <textarea id="e-desc-${id}" required>${escHtml(data.desc)}</textarea>
          <div class="grid" style="gap:6px;">
            <div class="muted">ëŒ€í‘œ ì²¨ë¶€: ${data.mainFile&&data.mainFile.name?escHtml(data.mainFile.name):'ì—†ìŒ'}</div>
            <div class="row" style="gap:6px;flex-wrap:wrap;">
              <input type="file" id="e-mainfile-${id}" />
              ${data.mainFile&&data.mainFile.url?`<a class="chip" href="${escAttr(data.mainFile.url)}" target="_blank" rel="noopener">í˜„ì¬ ì²¨ë¶€ ì—´ê¸°</a>`:''}
              ${data.mainFile?`<button type="button" class="danger mini" id="e-mainfile-del-${id}">ì²¨ë¶€ ì‚­ì œ</button>`:''}
              <button type="button" class="secondary mini" id="e-mainfile-up-${id}">ì²¨ë¶€ êµì²´ ì—…ë¡œë“œ</button>
            </div>
          </div>
        </form>
      </div>
      <div class="right-wrap">
        <div class="badges has-actions">
          ${data.mainFile&&data.mainFile.url?`<a class="chip" href="${escAttr(data.mainFile.url)}" target="_blank" rel="noopener">ì²¨ë¶€ ë³´ê¸°</a>`:''}
          ${data.mainFile&&data.mainFile.name?`<span class="chip">${escHtml(data.mainFile.name)}</span>`:''}
          <span class="chip">ID: ${id}</span>
        </div>
        ${canManagePost?`
        <div class="manage">
          <button class="ghost mini" id="btn-edit-${id}">ìˆ˜ì •</button>
          <button class="danger mini" id="btn-del-${id}">ì‚­ì œ</button>
          <button class="secondary mini" id="btn-save-${id}" style="display:none;">ì €ì¥</button>
          <button class="ghost mini" id="btn-cancel-${id}" style="display:none;">ì·¨ì†Œ</button>
        </div>`:''}
      </div>
    </div>
    <div id="view-${id}-desc"><p>${escHtml(data.desc)}</p></div>

    <div class="grid cols-2" style="margin-top:8px;">
      <div>
        <h4 style="margin:6px 0;">ğŸ’¬ ëŒ“ê¸€</h4>
        <div class="row" id="c-toolbar-${id}" style="gap:6px;flex-wrap:wrap;">
          <button class="ghost mini" id="c-enter-${id}">ì„ íƒ</button>
          <button class="secondary mini" id="c-edit-${id}" style="display:none;" disabled>ì„ íƒ ìˆ˜ì •(1ê°œ)</button>
          <button class="danger mini" id="c-del-${id}" style="display:none;" disabled>ì„ íƒ ì‚­ì œ</button>
          <span class="muted" id="c-count-${id}" style="display:none;">0ê°œ ì„ íƒ</span>
          <button class="ghost mini" id="c-cancel-${id}" style="display:none;">ì·¨ì†Œ</button>
        </div>
        <div class="list" id="comments-${id}"></div>
        <form class="grid" id="form-comment-${id}" style="gap:8px;margin-top:8px;">
          <label for="c-${id}" class="sr-only">ëŒ“ê¸€</label>
          <textarea id="c-${id}" placeholder="ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš” (ë¡œê·¸ì¸ í•„ìš”)" required></textarea>
          <div class="row"><button type="submit" class="secondary">ëŒ“ê¸€ ë“±ë¡</button></div>
        </form>
      </div>
      <div>
        <h4 style="margin:6px 0;">ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</h4>
        <div class="row" id="f-toolbar-${id}" style="gap:6px;flex-wrap:wrap;">
          <button class="ghost mini" id="f-enter-${id}">ì„ íƒ</button>
          <button class="secondary mini" id="f-rename-${id}" style="display:none;" disabled>ì´ë¦„ìˆ˜ì •(1ê°œ)</button>
          <input type="file" id="f-repl-input-${id}" style="display:none;" />
          <button class="secondary mini" id="f-replace-${id}" style="display:none;" disabled>íŒŒì¼êµì²´(1ê°œ)</button>
          <button class="danger mini" id="f-del-${id}" style="display:none;" disabled>ì„ íƒ ì‚­ì œ</button>
          <span class="muted" id="f-count-${id}" style="display:none;">0ê°œ ì„ íƒ</span>
          <button class="ghost mini" id="f-cancel-${id}" style="display:none;">ì·¨ì†Œ</button>
        </div>
        <div class="list" id="files-${id}"></div>
        <form class="row" id="form-file-${id}" style="margin-top:8px;flex-wrap:wrap;">
          <input type="file" id="f-${id}" />
          <button type="submit">ì—…ë¡œë“œ</button>
        </form>
      </div>
    </div>`;
  listEl.appendChild(card);

  /* ê²Œì‹œê¸€ ìˆ˜ì •/ì‚­ì œ */
  if(canManagePost){
    const btnEdit=$(`#btn-edit-${id}`), btnDel=$(`#btn-del-${id}`), btnSave=$(`#btn-save-${id}`), btnCancel=$(`#btn-cancel-${id}`);
    const editForm=$(`#edit-${id}-form`), viewHead=$(`#view-${id}-head`), viewDesc=$(`#view-${id}-desc`);
    const enter=()=>{ editForm.style.display=''; viewHead.style.display='none'; viewDesc.style.display='none'; btnEdit.style.display='none'; btnDel.style.display='none'; btnSave.style.display=''; btnCancel.style.display=''; };
    const exit =()=>{ editForm.style.display='none'; viewHead.style.display=''; viewDesc.style.display=''; btnEdit.style.display=''; btnDel.style.display=''; btnSave.style.display='none'; btnCancel.style.display='none'; };
    const save =async()=>{ const t=$(`#e-title-${id}`).value.trim(), d=$(`#e-desc-${id}`).value.trim(); if(!t||!d) return alert('ì œëª©/ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
      try{ await db.collection('projects').doc(id).update({ title:t, desc:d, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); loadProjects(); }catch(e){ alert('ìˆ˜ì • ì‹¤íŒ¨: '+e.message); } };
    btnEdit?.addEventListener('click', enter); btnCancel?.addEventListener('click', exit); btnSave?.addEventListener('click', save);
    btnDel?.addEventListener('click', async()=>{
      if(!confirm('í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ë©´ ëŒ“ê¸€/íŒŒì¼ë„ í•¨ê»˜ ì§€ì›Œì§‘ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?')) return;
      try{
        const ref=db.collection('projects').doc(id);
        let cs=await ref.collection('comments').limit(500).get();
        while(!cs.empty){ const b=db.batch(); cs.docs.forEach(d=>b.delete(d.ref)); await b.commit(); cs=await ref.collection('comments').limit(500).get(); }
        const fs=await ref.collection('files').limit(500).get();
        for(const d of fs.docs){ const f=d.data(); if(f.storagePath){ try{ await storage.ref().child(f.storagePath).delete(); }catch(err){ log('ìŠ¤í† ë¦¬ì§€ ì‚­ì œ ì‹¤íŒ¨:',err.message||err);} } await d.ref.delete(); }
        if(data.mainFile&&data.mainFile.storagePath){ try{ await storage.ref().child(data.mainFile.storagePath).delete(); }catch(err){ log('ëŒ€í‘œ ì‚­ì œ ì‹¤íŒ¨:',err.message||err);} }
        await ref.delete(); loadProjects();
      }catch(e){ alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
    });
    // ëŒ€í‘œ ì²¨ë¶€ êµì²´/ì‚­ì œ
    const mainInp=$(`#e-mainfile-${id}`), mainUp=$(`#e-mainfile-up-${id}`), mainDel=$(`#e-mainfile-del-${id}`);
    mainUp?.addEventListener('click', async()=>{
      const f=mainInp?.files?.[0]; if(!f) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); if(f.size>10*1024*1024) return alert('10MB ì´í•˜ë§Œ ì—…ë¡œë“œ');
      try{ const p=`uploads/${id}/main_${Date.now()}_${f.name}`; const ref=storage.ref().child(p); await ref.put(f,{customMetadata:{ownerUid:(auth.currentUser&&auth.currentUser.uid)||''}}); const url=await ref.getDownloadURL();
        await db.collection('projects').doc(id).update({ mainFile:{name:f.name,size:f.size,contentType:f.type,url,storagePath:p,uploadedAt:firebase.firestore.FieldValue.serverTimestamp(),ownerUid:(auth.currentUser&&auth.currentUser.uid)||''}, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        if(data.mainFile?.storagePath){ try{ await storage.ref().child(data.mainFile.storagePath).delete(); }catch{} } loadProjects();
      }catch(e){ alert('ì²¨ë¶€ êµì²´ ì‹¤íŒ¨: '+e.message); }
    });
    mainDel?.addEventListener('click', async()=>{
      if(!confirm('ëŒ€í‘œ ì²¨ë¶€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
      try{ if(data.mainFile?.storagePath){ try{ await storage.ref().child(data.mainFile.storagePath).delete(); }catch{} }
        await db.collection('projects').doc(id).update({ mainFile:null, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); loadProjects();
      }catch(e){ alert('ì²¨ë¶€ ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
    });
  }

  // ëŒ“ê¸€/íŒŒì¼ íˆ´ë°”ì™€ ëª©ë¡
  setupCommentToolbar(id); loadComments(id);
  setupFileToolbar(id);    loadFiles(id);
  $(`#form-comment-${id}`)?.addEventListener('submit', ev=>addComment(ev,id));
  $(`#form-file-${id}`)?.addEventListener('submit', ev=>uploadFile(ev,id));
}

/* ===== ì„ íƒ ëª¨ë“œ íˆ´ë°” ===== */
function setupCommentToolbar(pid){
  const enter  = document.getElementById(`c-enter-${pid}`);
  const edit   = document.getElementById(`c-edit-${pid}`);
  const del    = document.getElementById(`c-del-${pid}`);
  const cancel = document.getElementById(`c-cancel-${pid}`);
  const count  = document.getElementById(`c-count-${pid}`);
  selComments.set(pid, new Set());
  const updateUI = ()=>{ const n=selComments.get(pid).size; if(count) count.textContent=`${n}ê°œ ì„ íƒ`; if(edit) edit.disabled=(n!==1); if(del) del.disabled=(n===0); };
  enter?.addEventListener('click', ()=>{ document.getElementById(`comments-${pid}`)?.classList.add('selecting'); if(edit)edit.style.display=''; if(del)del.style.display=''; if(count)count.style.display=''; if(cancel)cancel.style.display=''; if(enter)enter.style.display='none'; updateUI(); });
  cancel?.addEventListener('click', ()=>{ selComments.set(pid,new Set()); const list=document.getElementById(`comments-${pid}`); list?.classList.remove('selecting'); list?.querySelectorAll('.select-cb').forEach(cb=>cb.checked=false); if(edit)edit.style.display='none'; if(del)del.style.display='none'; if(count)count.style.display='none'; if(cancel)cancel.style.display='none'; if(enter)enter.style.display=''; updateUI(); });
  edit?.addEventListener('click', async ()=>{ const set=selComments.get(pid); if(set.size!==1) return; const cid=[...set][0]; let cur=''; try{ const d=await db.collection('projects').doc(pid).collection('comments').doc(cid).get(); cur=(d.data()&&d.data().text)||'';}catch{} const next=prompt('ìƒˆ ëŒ“ê¸€ ë‚´ìš©', cur); if(next==null) return; const nv=(next||'').trim(); if(!nv) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); try{ await db.collection('projects').doc(pid).collection('comments').doc(cid).update({ text:nv, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); loadComments(pid); }catch(e){ alert('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨: '+e.message);} });
  del?.addEventListener('click', async ()=>{ const set=selComments.get(pid); if(set.size===0) return; if(!confirm(`${set.size}ê°œ ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?`)) return; try{ const b=db.batch(); set.forEach(cid=>b.delete(db.collection('projects').doc(pid).collection('comments').doc(cid))); await b.commit(); loadComments(pid);}catch(e){ alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨: '+e.message);} });
  enter && (enter._update = updateUI);
}
function setupFileToolbar(pid){
  const enter=document.getElementById(`f-enter-${pid}`), ren=document.getElementById(`f-rename-${pid}`), repIn=document.getElementById(`f-repl-input-${pid}`), rep=document.getElementById(`f-replace-${pid}`), del=document.getElementById(`f-del-${pid}`), cancel=document.getElementById(`f-cancel-${pid}`), count=document.getElementById(`f-count-${pid}`);
  selFiles.set(pid,new Set());
  const updateUI=()=>{ const n=selFiles.get(pid).size; if(count)count.textContent=`${n}ê°œ ì„ íƒ`; if(ren)ren.disabled=(n!==1); if(rep)rep.disabled=(n!==1); if(del)del.disabled=(n===0); if(repIn)repIn.style.display=(n===1)?'':'none'; };
  enter?.addEventListener('click', ()=>{ document.getElementById(`files-${pid}`)?.classList.add('selecting'); if(ren)ren.style.display=''; if(rep)rep.style.display=''; if(del)del.style.display=''; if(count)count.style.display=''; if(cancel)cancel.style.display=''; if(enter)enter.style.display='none'; updateUI(); });
  cancel?.addEventListener('click', ()=>{ selFiles.set(pid,new Set()); const list=document.getElementById(`files-${pid}`); list?.classList.remove('selecting'); list?.querySelectorAll('.select-cb').forEach(cb=>cb.checked=false); if(ren)ren.style.display='none'; if(rep)rep.style.display='none'; if(del)del.style.display='none'; if(count)count.style.display='none'; if(cancel)cancel.style.display='none'; if(enter)enter.style.display=''; if(repIn)repIn.style.display='none'; updateUI(); });
  ren?.addEventListener('click', async ()=>{ const set=selFiles.get(pid); if(set.size!==1) return; const fid=[...set][0]; let cur=''; try{ const d=await db.collection('projects').doc(pid).collection('files').doc(fid).get(); cur=(d.data()&&d.data().name)||'';}catch{} const next=prompt('ìƒˆ íŒŒì¼ ì´ë¦„(í‘œì‹œìš©)', cur); if(next==null) return; try{ await db.collection('projects').doc(pid).collection('files').doc(fid).update({ name:(next.trim()||cur), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); loadFiles(pid);}catch(e){ alert('íŒŒì¼ ì´ë¦„ ìˆ˜ì • ì‹¤íŒ¨: '+e.message);} });
  rep?.addEventListener('click', async ()=>{ const set=selFiles.get(pid); if(set.size!==1) return; const fid=[...set][0]; const nf=repIn?.files&&repIn.files[0]; if(!nf) return alert('êµì²´í•  ìƒˆ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); if(nf.size>10*1024*1024) return alert('10MB ì´í•˜ë§Œ ì—…ë¡œë“œ'); try{ const doc=await db.collection('projects').doc(pid).collection('files').doc(fid).get(); const old=doc.data(); const path=`uploads/${pid}/${Date.now()}_${nf.name}`; const ref=storage.ref().child(path); await ref.put(nf,{customMetadata:{ownerUid:(old&&old.ownerUid)||(currentUser&&currentUser.uid)||''}}); const url=await ref.getDownloadURL(); await db.collection('projects').doc(pid).collection('files').doc(fid).update({ name:nf.name,size:nf.size,contentType:nf.type,url,storagePath:path,updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); if(old&&old.storagePath){ try{ await storage.ref().child(old.storagePath).delete(); }catch(err){ log('ì´ì „ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:',err.message||err);} } loadFiles(pid); repIn.value=''; }catch(e){ alert('íŒŒì¼ êµì²´ ì‹¤íŒ¨: '+e.message);} });
  del?.addEventListener('click', async ()=>{ const set=selFiles.get(pid); if(set.size===0) return; if(!confirm(`${set.size}ê°œ íŒŒì¼ì„ ì‚­ì œí• ê¹Œìš”?`)) return; try{ for(const fid of set){ const doc=await db.collection('projects').doc(pid).collection('files').doc(fid).get(); const f=doc.data(); if(f?.storagePath){ try{ await storage.ref().child(f.storagePath).delete(); }catch(err){ log('ìŠ¤í† ë¦¬ì§€ ì‚­ì œ ì‹¤íŒ¨:',err.message||err);} } await db.collection('projects').doc(pid).collection('files').doc(fid).delete(); } loadFiles(pid); }catch(e){ alert('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: '+e.message);} });
  enter && (enter._update=updateUI);
}

/* ===== ëŒ“ê¸€/íŒŒì¼ ëª©ë¡ ===== */
async function loadComments(pid){
  const box = document.getElementById('comments-'+pid);
  box.innerHTML='<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
  const snap = await db.collection('projects').doc(pid).collection('comments').orderBy('createdAt','desc').limit(100).get();
  box.innerHTML='';
  const set = selComments.get(pid)||new Set();
  snap.forEach(doc=>{
    const c=doc.data(); const cid=doc.id;
    const can = currentUser && (currentUser.uid===c.authorUid || currentUser.uid===pageUid || isAdmin);
    const idS = `${pid}-${cid}`;
    const el=document.createElement('div'); el.className='comment'; el.id='comment-'+idS;
    el.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:flex-start;">
        <div style="flex:1">
          <div class="muted" style="font-size:12px;">${escHtml(c.authorName||'ìµëª…')} Â· ${fmtDate(c.createdAt)}${c.updatedAt?' (ìˆ˜ì •ë¨)':''}</div>
          <div>${escHtml(c.text)}</div>
        </div>
        <div><input type="checkbox" class="select-cb" ${can?'':'disabled'} id="c-cb-${idS}" data-cid="${cid}"></div>
      </div>`;
    box.appendChild(el);
    const cb=el.querySelector(`#c-cb-${idS}`); if(cb){ cb.checked=set.has(cid); cb.addEventListener('change', ()=>{ const S=selComments.get(pid); if(cb.checked) S.add(cid); else S.delete(cid); const btn=document.getElementById(`c-enter-${pid}`); btn&&btn._update&&btn._update(); }); }
  });
  const btn=document.getElementById(`c-enter-${pid}`); btn&&btn._update&&btn._update();
}

async function addComment(e,pid){
  e.preventDefault(); const user=auth.currentUser; if(!user) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  const ta=document.getElementById('c-'+pid); const text=(ta.value||'').trim(); if(!text) return;
  try{ await db.collection('projects').doc(pid).collection('comments').add({ text, createdAt: firebase.firestore.FieldValue.serverTimestamp(), authorUid:user.uid, authorName:user.displayName||'ìµëª…' }); ta.value=''; loadComments(pid);}catch(e){ alert('ëŒ“ê¸€ ì‹¤íŒ¨: '+e.message); }
}

async function loadFiles(pid){
  const box=document.getElementById('files-'+pid);
  box.innerHTML='<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
  const snap=await db.collection('projects').doc(pid).collection('files').orderBy('createdAt','desc').limit(100).get();
  box.innerHTML='';
  const set=selFiles.get(pid)||new Set();
  snap.forEach(doc=>{
    const f=doc.data(); const fid=doc.id; const can=currentUser&&(currentUser.uid===f.ownerUid || currentUser.uid===pageUid || isAdmin);
    const idS=`${pid}-${fid}`; const isImg=(f.contentType||'').startsWith('image/');
    const row=document.createElement('div'); row.className='file-row'; row.id='file-'+idS;
    row.innerHTML=`
      <div class="flex" style="flex:1;gap:10px;">
        ${isImg?`<img class="thumb" src="${escAttr(f.url)}" alt="${escAttr(f.name||'image')}">`:''}
        <div>
          <div class="muted">${escHtml(f.name||'íŒŒì¼')} (${f.size||0}B)</div>
          <a href="${escAttr(f.url)}" target="_blank" rel="noopener">${isImg?'ì›ë³¸ ì—´ê¸°':'ë‹¤ìš´ë¡œë“œ'}</a>
          ${f.updatedAt?`<span class="chip" style="margin-left:6px;">ìˆ˜ì •ë¨</span>`:''}
        </div>
      </div>
      <div><input type="checkbox" class="select-cb" ${can?'':'disabled'} id="f-cb-${idS}" data-fid="${fid}"></div>`;
    box.appendChild(row);
    const cb=row.querySelector(`#f-cb-${idS}`); if(cb){ cb.checked=set.has(fid); cb.addEventListener('change', ()=>{ const S=selFiles.get(pid); if(cb.checked) S.add(fid); else S.delete(fid); const btn=document.getElementById(`f-enter-${pid}`); btn&&btn._update&&btn._update(); }); }
  });
  const btn=document.getElementById(`f-enter-${pid}`); btn&&btn._update&&btn._update();
}

async function uploadFile(e,pid){
  e.preventDefault(); const user=auth.currentUser; if(!user) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  const input=document.getElementById('f-'+pid); const file=input.files&&input.files[0]; if(!file) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); if(file.size>10*1024*1024) return alert('íŒŒì¼ì€ ìµœëŒ€ 10MB');
  try{ const path=`uploads/${pid}/${Date.now()}_${file.name}`; const ref=storage.ref().child(path); const snap=await ref.put(file,{customMetadata:{ownerUid:user.uid,ownerEmail:user.email||''}}); const url=await snap.ref.getDownloadURL();
    await db.collection('projects').doc(pid).collection('files').add({ name:file.name,size:file.size,contentType:file.type,url,storagePath:path,createdAt: firebase.firestore.FieldValue.serverTimestamp(), ownerUid:user.uid, ownerName:user.displayName||'ìµëª…' });
    input.value=''; loadFiles(pid);
  }catch(e){ alert('ì—…ë¡œë“œ ì‹¤íŒ¨: '+e.message); }
}

/* ===== ì¹œêµ¬ ëª©ë¡ (ê³µìœ ë°›ìŒ) ===== */
function parseFriendTarget(text){
  text = (text||'').trim();
  if(!text) return null;
  try{
    const url = new URL(text);
    const u = new URLSearchParams(url.search).get('u');
    if(u) return u;
  }catch(_){}
  const m = text.match(/[?&]u=([^&]+)/);
  if(m) return decodeURIComponent(m[1]);
  return text; // UID ë¡œ ê°„ì£¼
}

$('#form-friend-add').addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!currentUser) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  const raw = $('#friend-input').value;
  const uid = parseFriendTarget(raw);
  if(!uid) return alert('ì˜¬ë°”ë¥¸ ë§í¬/UIDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  const label = ($('#friend-label').value||'').trim() || null;
  try{
    await friendsCol().doc(uid).set({
      friendUid: uid,
      label,
      addedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    $('#friend-input').value=''; $('#friend-label').value='';
    loadFriends();
  }catch(e){ alert('ì¶”ê°€ ì‹¤íŒ¨: '+e.message); }
});

$('#btn-friends-refresh').addEventListener('click', loadFriends);

async function loadFriends(){
  const box = $('#friends-list'); if(!box) return;
  if(!currentUser){ box.innerHTML = '<div class="muted">ë¡œê·¸ì¸í•˜ë©´ ì¹œêµ¬ ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆì–´ìš”.</div>'; return; }
  box.innerHTML = '<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
  try{
    const snap = await friendsCol().orderBy('addedAt','desc').limit(200).get();
    if(snap.empty){ box.innerHTML = '<div class="muted">ì•„ì§ ì €ì¥í•œ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë§í¬ë‚˜ UIDë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>'; return; }
    box.innerHTML = '';
    snap.forEach(doc=>{
      const f = doc.data(); const friendUid = doc.id;
      const row = document.createElement('div'); row.className='friend-row';
      row.innerHTML = `
        <div style="flex:1;">
          <div><strong>${escHtml(f.label||'ì´ë¦„ ë¯¸ì§€ì •')}</strong></div>
          <div class="muted" style="font-size:12px;">UID: ${friendUid}${f.addedAt? ' Â· '+fmtDate(f.addedAt):''}</div>
        </div>
        <div class="row" style="gap:6px;">
          <button class="secondary mini" data-open>ì—´ê¸°</button>
          <button class="ghost mini" data-rename>ì´ë¦„ë³€ê²½</button>
          <button class="danger mini" data-del>ì‚­ì œ</button>
        </div>`;
      box.appendChild(row);

      row.querySelector('[data-open]')?.addEventListener('click', async ()=>{
        // ë°©ë¬¸ ê¸°ë¡ ì—…ë°ì´íŠ¸(ì„ íƒ)
        try{ await friendsCol().doc(friendUid).set({ lastVisitedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true}); }catch{}
        location.search = `?u=${encodeURIComponent(friendUid)}`;
      });
      row.querySelector('[data-rename]')?.addEventListener('click', async ()=>{
        const cur = f.label || '';
        const next = prompt('í‘œì‹œ ì´ë¦„', cur);
        if(next===null) return;
        try{ await friendsCol().doc(friendUid).set({ label: (next.trim()||null) }, {merge:true}); loadFriends(); }catch(e){ alert('ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨: '+e.message); }
      });
      row.querySelector('[data-del]')?.addEventListener('click', async ()=>{
        if(!confirm('ì´ ì¹œêµ¬ë¥¼ ëª©ë¡ì—ì„œ ì‚­ì œí• ê¹Œìš”?')) return;
        try{ await friendsCol().doc(friendUid).delete(); loadFriends(); }catch(e){ alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
      });
    });
  }catch(e){
    box.innerHTML = '<div class="muted">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
    log('loadFriends error', e.message||e);
  }
}

/* ===== ì´ˆê¸° ===== */
window.addEventListener('DOMContentLoaded', ()=>{ $('#year').textContent=new Date().getFullYear(); reflectRoute(); });
</script>

<!-- Firestore / Storage ê·œì¹™ ì˜ˆì‹œ (í˜ì´ì§€ ì†Œìœ ì ê¶Œí•œ + ì¹œêµ¬ëª©ë¡ ë³´í˜¸) -->
<!--
Firestore:
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() { return request.auth != null && exists(/databases/$(database)/documents/roles/$(request.auth.uid)); }

    // í”„ë¡œì íŠ¸/ëŒ“ê¸€/íŒŒì¼ (ì´ì „ê³¼ ë™ì¼, ownerUid í¬í•¨)
    match /projects/{pid} {
      allow read: if true;
      allow create: if request.auth != null
                    && request.resource.data.authorUid == request.auth.uid
                    && request.resource.data.ownerUid is string;
      allow update, delete: if request.auth != null
                            && (resource.data.authorUid == request.auth.uid
                                || resource.data.ownerUid == request.auth.uid
                                || isAdmin());
      match /comments/{cid} {
        allow read: if true;
        allow create: if request.auth != null
                      && request.resource.data.authorUid == request.auth.uid
                      && request.resource.data.text.size() > 0
                      && request.resource.data.text.size() <= 2000;
        allow update, delete: if request.auth != null
                              && (resource.data.authorUid == request.auth.uid
                                  || get(/databases/$(database)/documents/projects/$(pid)).data.ownerUid == request.auth.uid
                                  || isAdmin());
      }
      match /files/{fid} {
        allow read: if true;
        allow create: if request.auth != null
                      && request.resource.data.ownerUid == request.auth.uid
                      && request.resource.data.size <= 10 * 1024 * 1024;
        allow update, delete: if request.auth != null
                              && (resource.data.ownerUid == request.auth.uid
                                  || get(/databases/$(database)/documents/projects/$(pid)).data.ownerUid == request.auth.uid
                                  || isAdmin());
      }
    }

    // ì¹œêµ¬ ëª©ë¡(ê³µìœ ë°›ìŒ): ë³¸ì¸ë§Œ ì½ê¸°/ì“°ê¸°
    match /users/{uid}/friends/{fid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    match /roles/{uid} { allow read: if request.auth != null; allow write: if false; }
  }
}

Storage:
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /uploads/{pid}/{filename=**} {
      allow read: if true;
      allow write: if request.auth != null && request.resource.size < 10 * 1024 * 1024;
      // ì—…ë¡œë”ë§Œ ì‚­ì œë¡œ ì œí•œí•˜ë ¤ë©´:
      // allow delete: if request.auth != null && request.auth.uid == resource.metadata.ownerUid;
    }
  }
}
-->
</body>
</html>
