<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="https://kimys01.github.io/propot/">
<title>ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-color: #6a5acd;
    --button-hover-color: #5a4ab9;
    --background-color: #f0f2f5;
    --container-bg-color: #ffffff;
    --text-color: #333;
    --text-muted-color: #666;
    --border-color: #e0e0e0;
    --danger-bg-color: #fee2e2;
    --danger-text-color: #b91c1c;
    --danger-border-color: #fecaca;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:var(--background-color);
    color:var(--text-color);
    font:16px/1.5 'Noto Sans KR', system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Malgun Gothic,sans-serif;
  }
  a{color:var(--primary-color); text-decoration:none}
  a:hover{text-decoration:underline}
  .hdr{
    position:sticky;
    top:0;
    background:var(--container-bg-color);
    border-bottom:1px solid var(--border-color);
    backdrop-filter:blur(8px);
    z-index:10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .hdr strong { color: var(--primary-color); }
  .wrap{max-width:1024px;margin:0 auto;padding:14px 18px}
  .row{display:flex;gap:10px;align-items:center}
  .row.space{justify-content:space-between}
  .row.gap8{gap:8px}
  .row.wrap{flex-wrap:wrap}
  .pad16{padding:16px 18px}
  .mt10{margin-top:10px}.mt14{margin-top:14px}.mt8{margin-top:8px}
  .card{
    background:var(--container-bg-color);
    border: none;
    border-radius:12px;
    padding:24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
  }
  .list{display:grid;gap:12px}
  .chip{
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    background-color: #ebebeb;
    color: var(--text-muted-color);
  }
  .muted{color:var(--text-muted-color)}
  .ttl{
    margin:0 0 12px;
    color: var(--primary-color);
    font-weight: 700;
    font-size: 22px;
  }
  button,input,textarea,a.secondary,a.ghost{font:inherit}
  textarea{min-height:120px;resize:vertical}
  button, a.secondary, a.ghost {
    padding:9px 14px;
    border:none;
    border-radius:8px;
    font-size: 14px;
    font-weight:500;
    cursor:pointer;
    transition: all 0.2s;
    display: inline-flex;
    justify-content: center;
    align-items: center;
  }
  button{
    background-color:var(--primary-color);
    color:white;
  }
  button:hover {
    background-color: var(--button-hover-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  button.secondary, a.secondary{
    background-color:#f0f0f0;
    color:var(--text-color);
    border:1px solid var(--border-color);
  }
  button.secondary:hover, a.secondary:hover {
    background-color: #e5e5e5;
  }
  button.ghost, a.ghost{
    background:transparent;
    color: var(--text-muted-color);
    border:1px solid var(--border-color);
  }
  button.ghost:hover, a.ghost:hover {
    background: rgba(106, 90, 205, 0.05);
    color: var(--primary-color);
    border-color: var(--primary-color);
  }
  .inp{
    width:100%;
    background:#ffffff;
    color:var(--text-color);
    border:1px solid var(--border-color);
    border-radius:8px;
    padding:12px 14px;
    transition: all 0.2s;
  }
  .inp:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.2);
  }
</style>
</head>
<body>
<header class="hdr">
  <div class="wrap row">
    <div class="row"><strong>ğŸ“„ í¬íŠ¸í´ë¦¬ì˜¤</strong><span id="owner-chip" class="chip"></span></div>
    <div class="row ml-auto gap8">
      <span id="user-line" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
      <button id="btn-login" class="secondary">ë¡œê·¸ì¸</button>
      <button id="btn-logout" class="secondary" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      <a id="btn-home" class="secondary" href="index.html">ë©”ì¸</a>
      <button id="btn-copy" class="secondary">ê³µìœ  ë§í¬ ë³µì‚¬</button>
    </div>
  </div>
</header>

<main class="wrap pad16">
  
  <section id="project-section" class="card">
    <!-- í”„ë¡œì íŠ¸ ë³´ê¸° ëª¨ë“œ -->
    <div id="project-view">
      <div class="row space wrap">
          <h2 id="p-view-title" class="ttl">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>
          <button id="btn-edit" class="ghost" style="display:none;">ìˆ˜ì •</button>
      </div>
      <p id="p-view-desc" class="muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
      <div id="p-view-tags" class="row wrap" style="gap:6px; margin-top:8px;"></div>
      <div id="p-view-file" class="mt14"></div>
    </div>

    <!-- í”„ë¡œì íŠ¸ ìˆ˜ì • ëª¨ë“œ (ê¸°ë³¸ ìˆ¨ê¹€) -->
    <form id="project-edit-form" class="list" style="display:none;">
      <h2 class="ttl">í”„ë¡œì íŠ¸ ìˆ˜ì •</h2>
      <input id="p-edit-title" class="inp" placeholder="í”„ë¡œì íŠ¸ ì œëª©" required/>
      <textarea id="p-edit-desc" class="inp" placeholder="í”„ë¡œì íŠ¸ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…" required></textarea>
      <input id="p-edit-tags" class="inp" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)"/>
      <div class="row gap8">
          <button type="submit">ì €ì¥í•˜ê¸°</button>
          <button type="button" id="btn-cancel-edit" class="ghost">ì·¨ì†Œ</button>
      </div>
    </form>
  </section>

</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
  const cfg={apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",authDomain:"propot-cc6bf.firebaseapp.com",projectId:"propot-cc6bf",storageBucket:"propot-cc6bf.firebasestorage.app",appId:"1:30940698980:web:1729f30e68d3beb24ac271"};
  firebase.initializeApp(cfg);
  const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

  const $=s=>document.querySelector(s);
  const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const parseTags=v=>String(v||'').split(/[, \t]+/).map(x=>x.trim().replace(/^#/,'').toLowerCase()).filter(Boolean).slice(0,10);

  const params=new URLSearchParams(location.search);
  const ownerUid=params.get('uid');
  if(!ownerUid){
    alert('ì˜ëª»ëœ ì ‘ê·¼: ì‚¬ìš©ì UIDê°€ ì—†ìŠµë‹ˆë‹¤.');
    location.href='index.html';
  }

  let me=null;
  let isAdmin=false;
  let canWrite=false;
  let ownerData = {};

  async function initializePage() {
    await loadOwnerProfile();
    auth.onAuthStateChanged(async user => {
      me = user;
      updateHeaderUI();
      await computePermission();
      await loadAndRenderProject();
    });
  }

  function updateHeaderUI() {
    if (me) {
      $('#user-line').textContent = `${me.displayName || 'ìµëª…'}`;
      $('#btn-login').style.display = 'none';
      $('#btn-logout').style.display = '';
    } else {
      $('#user-line').textContent = 'ë¡œê·¸ì¸ í•„ìš”';
      $('#btn-login').style.display = '';
      $('#btn-logout').style.display = 'none';
    }
  }

  async function loadOwnerProfile() {
    try {
      const userDoc = await db.collection('users').doc(ownerUid).get();
      if (userDoc.exists) {
        ownerData = userDoc.data();
        $('#owner-chip').textContent = `ì†Œìœ ì: ${ownerData.displayName || 'ìµëª…'}`;
      } else {
        $('#owner-chip').textContent = `ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ì`;
      }
    } catch (e) {
      console.error("Owner profile load failed:", e);
      $('#owner-chip').textContent = `ì •ë³´ ë¡œë”© ì‹¤íŒ¨`;
    }
  }

  async function computePermission(){
    if(!me){ canWrite=false; return; }
    const isOwner = me.uid === ownerUid;
    let isFriend = false;
    if(!isOwner && !isAdmin){
      try{
        const friendDocId = `${ownerUid}_${me.uid}`;
        const friendDoc = await db.collection('friends').doc(friendDocId).get();
        isFriend = friendDoc.exists;
      }catch(e){ console.warn('ì¹œêµ¬ ê´€ê³„ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', e); }
    }
    canWrite = isOwner || isFriend || isAdmin;
    $('#btn-edit').style.display = canWrite ? '' : 'none';
  }
  
  // --- í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ í•¨ìˆ˜ ---
  async function loadAndRenderProject() {
    try {
      const projectRef = db.collection('projects').doc(ownerUid);
      const doc = await projectRef.get();

      if (doc.exists) {
        const data = doc.data();
        // ë³´ê¸° ëª¨ë“œ UI ì—…ë°ì´íŠ¸
        $('#p-view-title').textContent = data.title;
        $('#p-view-desc').textContent = data.desc;
        $('#p-view-tags').innerHTML = (data.tags || []).map(t => `<span class="chip">#${esc(t)}</span>`).join('');
        
        // ìˆ˜ì • í¼ì— ë°ì´í„° ì±„ìš°ê¸°
        $('#p-edit-title').value = data.title;
        $('#p-edit-desc').value = data.desc;
        $('#p-edit-tags').value = (data.tags || []).join(', ');

      } else {
        $('#p-view-title').textContent = 'í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
        $('#p-view-desc').textContent = 'ì•„ì§ ì‘ì„±ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
      }
    } catch (e) {
      console.error("Project load failed:", e);
      $('#p-view-title').textContent = 'í”„ë¡œì íŠ¸ ë¡œë”© ì‹¤íŒ¨';
      $('#p-view-desc').textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    }
  }

  // --- UI ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
  $('#btn-login').onclick=()=>location.href=`login.html`;
  $('#btn-logout').onclick=()=>auth.signOut();
  
  const shareUrl=`${location.origin}${location.pathname.replace('u.html', '')}u.html?uid=${encodeURIComponent(ownerUid)}`;
  $('#btn-copy').onclick=async()=>{ try { await navigator.clipboard.writeText(shareUrl); alert('ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); } catch(e) { alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); } };

  // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ
  $('#btn-edit').onclick = () => {
    $('#project-view').style.display = 'none';
    $('#project-edit-form').style.display = 'grid';
  };

  // ìˆ˜ì • ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ
  $('#btn-cancel-edit').onclick = () => {
    $('#project-view').style.display = 'block';
    $('#project-edit-form').style.display = 'none';
  };
  
  // ìˆ˜ì • í¼ ì œì¶œ ì‹œ
  $('#project-edit-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!canWrite) return alert('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
    
    const title = $('#p-edit-title').value.trim();
    const desc = $('#p-edit-desc').value.trim();
    const tags = parseTags($('#p-edit-tags').value);

    if (!title || !desc) {
      return alert('ì œëª©ê³¼ ì„¤ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
    }

    try {
      const projectRef = db.collection('projects').doc(ownerUid);
      await projectRef.update({
        title,
        desc,
        tags,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('í”„ë¡œì íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      $('#project-view').style.display = 'block';
      $('#project-edit-form').style.display = 'none';
      await loadAndRenderProject(); // ìˆ˜ì •ëœ ë‚´ìš© ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    } catch (e) {
      console.error("Project update failed:", e);
      alert('í”„ë¡œì íŠ¸ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  });

  // í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
  initializePage();
</script>
</body>
</html>

