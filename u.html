<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="https://kimys01.github.io/propot/">
<title>ÎÇ¥ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-color: #6a5acd;
    --button-hover-color: #5a4ab9;
    --background-color: #f0f2f5;
    --container-bg-color: #ffffff;
    --text-color: #333;
    --text-muted-color: #666;
    --border-color: #e0e0e0;
    --danger-color: #b91c1c;
    --danger-hover-bg: rgba(185, 28, 28, 0.05);
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:var(--background-color);
    color:var(--text-color);
    font:16px/1.5 'Noto Sans KR', system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Malgun Gothic,sans-serif;
  }
  a{color:var(--primary-color); text-decoration:none}
  a:hover{text-decoration:underline}
  .hdr{
    position:sticky;
    top:0;
    background:var(--container-bg-color);
    border-bottom:1px solid var(--border-color);
    backdrop-filter:blur(8px);
    z-index:10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .hdr strong { color: var(--primary-color); }
  .wrap{max-width:1024px;margin:0 auto;padding:14px 18px}
  .row{display:flex;gap:10px;align-items:center}
  .row.space{justify-content:space-between}
  .row.gap8{gap:8px}
  .row.wrap{flex-wrap:wrap}
  .pad16{padding:16px 18px}
  .mt10{margin-top:10px}.mt14{margin-top:14px}.mt8{margin-top:8px}
  .card{
    background:var(--container-bg-color);
    border: none;
    border-radius:12px;
    padding:24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
  }
  .list{display:grid;gap:12px}
  .project {
    background: var(--container-bg-color);
    border:1px solid var(--border-color);
    border-radius:12px;
    padding:16px;
  }
  .chip{
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    background-color: #ebebeb;
    color: var(--text-muted-color);
  }
  .muted{color:var(--text-muted-color)} .ttl{margin:0 0 12px; color: var(--primary-color); font-weight: 700;}
  button,input,textarea,a.secondary,a.ghost{font:inherit}
  button, a.secondary, a.ghost {
    padding:8px 14px;
    border:none;
    border-radius:8px;
    font-size: 14px;
    font-weight:500;
    cursor:pointer;
    transition: all 0.2s;
    display: inline-flex;
    justify-content: center;
    align-items: center;
  }
  button{
    background-color:var(--primary-color);
    color:white;
  }
   button:hover {
    background-color: var(--button-hover-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  button.secondary, a.secondary{
    background-color:#f0f0f0;
    color:var(--text-color);
    border:1px solid var(--border-color);
  }
  button.secondary:hover, a.secondary:hover {
    background-color: #e5e5e5;
  }
  button.ghost, a.ghost{
    background:transparent;
    color: var(--text-muted-color);
    border:1px solid var(--border-color);
  }
   button.ghost:hover, a.ghost:hover {
    background: rgba(106, 90, 205, 0.05);
    color: var(--primary-color);
    border-color: var(--primary-color);
  }
   button.danger {
    background:transparent;
    color: var(--danger-color);
    border:1px solid var(--danger-color);
  }
  button.danger:hover {
    background: var(--danger-hover-bg);
  }
  .inp{
    width:100%;
    background:#ffffff;
    color:var(--text-color);
    border:1px solid var(--border-color);
    border-radius:8px;
    padding:10px 12px;
    transition: all 0.2s;
  }
   .inp:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.2);
  }
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:860px){.grid.cols-2{grid-template-columns:1fr}}
  .manage{display:flex;gap:6px;}

  .gallery-view {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }
  .gallery-view .project { padding: 0; overflow: hidden; }
  .gallery-view .project .project-thumbnail {
    width: 100%; height: 200px; object-fit: cover; display: block;
  }
  .gallery-view .project .project-info { padding: 12px; }
  .showreel-container {
    position: relative; padding-bottom: 56.25%; height: 0;
    overflow: hidden; max-width: 100%; background: #000; border-radius: 8px;
  }
  .showreel-container iframe {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  }
  .article-item {
    padding: 12px; border: 1px solid var(--border-color);
    border-radius: 8px; transition: background-color 0.2s;
  }
  .article-item:hover { background-color: #f9f9f9; }

  .comments-section {
    border-top: 1px solid var(--border-color);
    padding-top: 16px;
    margin-top: 16px;
  }
  .comment-item {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  .comment-item:last-child {
    border-bottom: none;
  }
  .comment-item p {
    margin: 4px 0 0;
  }
  .mini{padding:6px 10px;border-radius:8px;font-size:12px}
  .file-display {
    margin-top: 10px;
    background-color: #f9f9f9;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: space-between;
  }
  .file-display-info {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 0;
  }
  .file-display-info img {
    width: 60px;
    height: 45px;
    object-fit: cover;
    border-radius: 4px;
    flex-shrink: 0;
  }
  .file-text-info {
    min-width: 0;
  }
  .file-name {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500;
  }
  .download-btn {
    flex-shrink: 0;
    background: transparent;
    color: var(--text-muted-color);
    border: 1px solid var(--border-color);
    width: 32px;
    height: 32px;
    padding: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .download-btn:hover {
    background: #f0f0f0;
    color: var(--primary-color);
    border-color: #ccc;
    text-decoration: none;
  }
</style>
</head>
<body>
<header class="hdr">
  <div class="wrap row">
    <div class="row gap8"><strong>üìÑ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§</strong><span id="owner-chip" class="chip"></span></div>
    <div class="row ml-auto gap8">
      <span id="user-line" class="muted">ÌôïÏù∏ Ï§ë...</span>
      <button id="btn-login" class="secondary" style="display:none;">Î°úÍ∑∏Ïù∏</button>
      <button id="btn-logout" class="secondary" style="display:none">Î°úÍ∑∏ÏïÑÏõÉ</button>
      <a id="btn-home" class="secondary" href="index.html">Î©îÏù∏</a>
      <button id="btn-copy" class="secondary">Í≥µÏú† ÎßÅÌÅ¨ Î≥µÏÇ¨</button>
    </div>
  </div>
</header>

<main class="wrap pad16">
  
  <div id="job-sections" class="grid" style="gap: 12px; margin-bottom: 12px;">
    <section id="developer-section" class="card" style="display:none;">
      <h3 class="ttl" style="font-size: 1.2em;">üíª Developer Profile</h3>
      <div id="developer-profile-view"></div>
      <form id="developer-edit-form" class="list mt14" style="display:none;">
          <input id="github-username" class="inp" placeholder="GitHub ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ (Ïòà: torvalds)"/>
          <div class="row"><button type="submit">GitHub Ï†ïÎ≥¥ Ï†ÄÏû•</button></div>
      </form>
    </section>

    <section id="creator-section" class="card" style="display:none;">
        <h3 class="ttl" style="font-size: 1.2em;">üé¨ Showreel</h3>
        <div id="creator-showreel-view"></div>
        <form id="creator-edit-form" class="list mt14" style="display:none;">
            <input id="showreel-url" class="inp" placeholder="YouTube ÎòêÎäî Vimeo ÏòÅÏÉÅ URL"/>
            <div class="row"><button type="submit">ÏáºÎ¶¥ Ï†ÄÏû•</button></div>
        </form>
    </section>

    <section id="writer-section" class="card" style="display:none;">
        <h3 class="ttl" style="font-size: 1.2em;">‚úçÔ∏è Featured Articles</h3>
        <div id="writer-articles" class="list"></div>
    </section>
  </div>

  <section class="card mt14">
    <div class="row space wrap">
      <h2 class="ttl">ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù</h2>
    </div>
    <div id="write-form-container"></div>
    <div id="list" class="list mt10"></div>
  </section>

</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
  const cfg={apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",authDomain:"propot-cc6bf.firebaseapp.com",projectId:"propot-cc6bf",storageBucket:"propot-cc6bf.firebasestorage.app",appId:"1:30940698980:web:1729f30e68d3beb24ac271"};
  firebase.initializeApp(cfg);
  const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

  const $=s=>document.querySelector(s);
  const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const fmt=ts=>{ if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString(); };
  const parseTags=v=>String(v||'').split(/[, \t]+/).map(x=>x.trim().replace(/^#/,'').toLowerCase()).filter(Boolean).slice(0,10);

  const params=new URLSearchParams(location.search);
  const ownerUid=params.get('uid');
  if(!ownerUid){
    alert('ÏûòÎ™ªÎêú Ï†ëÍ∑º: ÏÇ¨Ïö©Ïûê UIDÍ∞Ä ÏóÜÏäµÎãàÎã§.');
    location.href='index.html';
  }

  let me=null, isAdmin=false, canWrite=false;
  let ownerData = {}, loadedProjects = [];

  auth.onAuthStateChanged(async user => {
    me = user;
    updateHeaderUI();
    await loadOwnerProfile();
    await computePermission();
    setupJobSectionEditForms();
    await loadProjects();
  });
  
  function updateHeaderUI() {
    if (me) {
      $('#user-line').textContent = `${me.displayName || 'ÏùµÎ™Ö'}`;
      $('#btn-login').style.display = 'none';
      $('#btn-logout').style.display = '';
    } else {
      $('#user-line').textContent = 'Î°úÍ∑∏Ïù∏ ÌïÑÏöî';
      $('#btn-login').style.display = 'block';
      $('#btn-logout').style.display = 'none';
    }
  }

  async function loadOwnerProfile() {
    try {
      const userDoc = await db.collection('users').doc(ownerUid).get();
      if (userDoc.exists) {
        ownerData = userDoc.data();
        $('#owner-chip').textContent = `ÏÜåÏú†Ïûê: ${ownerData.displayName || 'ÏùµÎ™Ö'}`;
        renderJobSections();
      } else {
        $('#owner-chip').textContent = `Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî ÏÇ¨Ïö©Ïûê`;
      }
    } catch (e) {
      console.error("Owner profile load failed:", e);
      $('#owner-chip').textContent = `Ï†ïÎ≥¥ Î°úÎî© Ïã§Ìå®`;
    }
  }
  
  function renderJobSections() {
      const jobRoles = ownerData.jobRole || [];
      $('#developer-section').style.display = jobRoles.includes('developer') ? 'block' : 'none';
      $('#creator-section').style.display = jobRoles.includes('creator') ? 'block' : 'none';
      $('#writer-section').style.display = jobRoles.includes('writer') ? 'block' : 'none';

      if (jobRoles.includes('developer')) renderDeveloperProfile(ownerData);
      if (jobRoles.includes('creator')) renderCreatorShowreel(ownerData);
  }
  
  function renderDeveloperProfile(userData) {
      const view = $('#developer-profile-view');
      if (userData.githubUsername) {
          view.innerHTML = `<a href="https://github.com/${esc(userData.githubUsername)}" target="_blank" rel="noopener">
              <button class="secondary">üîó GitHub @${esc(userData.githubUsername)}</button>
          </a>`;
      } else {
          view.innerHTML = `<p class="muted">ÏïÑÏßÅ GitHub Ï†ïÎ≥¥Í∞Ä Îì±Î°ùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</p>`;
      }
  }

  function renderCreatorShowreel(userData) {
      const view = $('#creator-showreel-view');
      const url = userData.showreelUrl;
      if (url) {
          let embedUrl = '';
          if (url.includes('youtube.com/watch?v=')) {
              const videoId = url.split('v=')[1].split('&')[0];
              embedUrl = `https://www.youtube.com/embed/${videoId}`;
          } else if (url.includes('youtu.be/')) {
              const videoId = url.split('youtu.be/')[1].split('?')[0];
              embedUrl = `https://www.youtube.com/embed/${videoId}`;
          } else if (url.includes('vimeo.com/')) {
              const videoId = url.split('vimeo.com/')[1].split('?')[0];
              embedUrl = `https://player.vimeo.com/video/${videoId}`;
          }
          if (embedUrl) {
              view.innerHTML = `<div class="showreel-container"><iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe></div>`;
          } else {
              view.innerHTML = `<p class="muted">ÏßÄÏõêÎêòÏßÄ ÏïäÎäî ÏòÅÏÉÅ URL ÌòïÏãùÏûÖÎãàÎã§. (YouTube, Vimeo ÏßÄÏõê)</p>`;
          }
      } else {
          view.innerHTML = `<p class="muted">ÏïÑÏßÅ ÏáºÎ¶¥ ÏòÅÏÉÅÏù¥ Îì±Î°ùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</p>`;
      }
  }

  function renderWriterArticles(projects) {
      const container = $('#writer-articles');
      if (!container) return;
      container.innerHTML = '';
      if (projects.length === 0) {
          container.innerHTML = `<p class="muted">ÏïÑÏßÅ ÌëúÏãúÌï† Í∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</p>`;
          return;
      }
      projects.slice(0, 3).forEach(p => { // ÏµúÎåÄ 3Í∞úÎßå ÌëúÏãú
          const item = document.createElement('a');
          item.className = 'article-item';
          item.href = `#project-${p.id}`;
          item.innerHTML = `
              <h4 style="margin:0;">${esc(p.data.title)}</h4>
              <p class="muted small" style="margin:2px 0 0;">${esc(p.data.desc.substring(0, 80))}...</p>
          `;
          container.appendChild(item);
      });
  }


  async function computePermission(){
    if(!me){ canWrite=false; return; }
    const isOwner = me.uid === ownerUid;
    let isFriend = false;
    try { 
      isAdmin = (await db.collection('roles').doc(me.uid).get()).exists; 
    } catch { 
      isAdmin = false; 
    }
    if(!isOwner && !isAdmin){
      try{
        const friendDocId = `${ownerUid}_${me.uid}`;
        const friendDoc = await db.collection('friends').doc(friendDocId).get();
        isFriend = friendDoc.exists;
      }catch(e){ console.warn('ÏπúÍµ¨ Í¥ÄÍ≥Ñ ÌôïÏù∏ Ï§ë Ïò§Î•ò:', e); }
    }
    canWrite = isOwner || isFriend || isAdmin;
    setupWriteForm();
  }
  
  function setupJobSectionEditForms() {
      if (canWrite) {
          const devForm = $('#developer-edit-form');
          if(devForm && $('#developer-section').style.display === 'block') {
              devForm.style.display = 'grid';
              $('#github-username').value = ownerData.githubUsername || '';
              devForm.addEventListener('submit', async (e) => {
                  e.preventDefault();
                  const username = $('#github-username').value.trim();
                  await db.collection('users').doc(ownerUid).update({ githubUsername: username });
                  alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                  ownerData.githubUsername = username;
                  renderDeveloperProfile(ownerData);
              });
          }

          const creatorForm = $('#creator-edit-form');
          if(creatorForm && $('#creator-section').style.display === 'block') {
              creatorForm.style.display = 'grid';
              $('#showreel-url').value = ownerData.showreelUrl || '';
              creatorForm.addEventListener('submit', async (e) => {
                  e.preventDefault();
                  const url = $('#showreel-url').value.trim();
                  await db.collection('users').doc(ownerUid).update({ showreelUrl: url });
                  alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                  ownerData.showreelUrl = url;
                  renderCreatorShowreel(ownerData);
              });
          }
      }
  }

  function setupWriteForm() {
    const container = $('#write-form-container');
    if (!canWrite) {
      container.innerHTML = '';
      return;
    }
    container.innerHTML = `
      <div style="padding-bottom: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color);">
        <h3 class="ttl" style="font-size: 1.2em;">ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏûëÏÑ±</h3>
        <p class="muted">ÏÉàÎ°úÏö¥ ÌîÑÎ°úÏ†ùÌä∏Î•º Îì±Î°ùÌïòÏó¨ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§Î•º Ï±ÑÏõåÎ≥¥ÏÑ∏Ïöî.</p>
        <form id="form-new" class="list">
          <input id="p-title" class="inp" placeholder="ÌîÑÎ°úÏ†ùÌä∏ Ï†úÎ™©" required/>
          <textarea id="p-desc" class="inp" placeholder="ÌîÑÎ°úÏ†ùÌä∏Ïóê ÎåÄÌïú ÏÉÅÏÑ∏ ÏÑ§Î™Ö" required></textarea>
          <div class="grid cols-2">
            <input id="p-tags" class="inp" placeholder="ÌÉúÍ∑∏ (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ)"/>
            <input id="p-file" type="file" class="inp"/>
          </div>
          <div class="row"><button type="submit">Îì±Î°ùÌïòÍ∏∞</button></div>
        </form>
      </div>`;

    $('#form-new').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = $('#p-title').value.trim();
        const desc = $('#p-desc').value.trim();
        const tags = parseTags($('#p-tags').value);
        const file = $('#p-file').files[0];

        if (!title || !desc) return alert('Ï†úÎ™©Í≥º ÏÑ§Î™ÖÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.');

        try {
          const projectsRef = db.collection('projects');
          const docRef = await projectsRef.add({
            ownerUid: ownerUid,
            authorUid: me.uid,
            authorName: me.displayName || 'ÏùµÎ™Ö',
            title, desc, tags,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            mainFile: null
          });

          if (file) {
            if (file.size > 10 * 1024 * 1024) throw new Error('10MB Ïù¥Ìïò ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
            const storagePath = `uploads/${ownerUid}/${docRef.id}/${Date.now()}_${file.name}`;
            const fileRef = storage.ref(storagePath);
            const snap = await fileRef.put(file);
            const url = await snap.ref.getDownloadURL();
            await docRef.update({
              mainFile: { name: file.name, size: file.size, contentType: file.type, url, storagePath }
            });
          }
          e.target.reset();
          await loadProjects();
        } catch (err) {
          alert('ÌîÑÎ°úÏ†ùÌä∏ Îì±Î°ù Ïã§Ìå®: ' + err.message);
        }
    });
  }

  async function loadProjects() {
    const box=$('#list');
    box.innerHTML = '<div class="muted">ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
    try {
      const projectsRef = db.collection('projects');
      const snap = await projectsRef.where('ownerUid', '==', ownerUid).orderBy('createdAt', 'desc').get();
      
      loadedProjects = [];
      snap.forEach(doc => loadedProjects.push({ id: doc.id, data: doc.data() }));

      renderProjects(loadedProjects);
    } catch (e) {
      console.error("Projects load failed:", e);
      box.innerHTML = `<div class="muted">ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${esc(e.message)}</div>`;
    }
  }

  function renderProjects(list) {
    const listEl = $('#list');
    listEl.innerHTML = '';
    
    if (ownerData.jobRole && ownerData.jobRole.includes('designer')) {
      listEl.classList.add('gallery-view');
    } else {
      listEl.classList.remove('gallery-view');
    }

    if (!list || !list.length) {
      listEl.innerHTML = '<div class="muted">ÏïÑÏßÅ Îì±Î°ùÎêú ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
      return;
    }
    list.forEach(({ id, data }) => renderProjectCard(id, data, listEl));
    
    if (ownerData.jobRole && ownerData.jobRole.includes('writer')) {
        renderWriterArticles(list);
    }
  }

  function renderProjectCard(id, data, listEl) {
      // This function is defined in the full code block below
  }


  $('#btn-login').onclick=()=>location.href=`login.html`;
  $('#btn-logout').onclick=()=>auth.signOut();
  
  const shareUrl=`${location.origin}${location.pathname.replace('u.html', '')}u.html?uid=${encodeURIComponent(ownerUid)}`;
  $('#btn-copy').onclick=async()=>{ try { await navigator.clipboard.writeText(shareUrl); alert('Í≥µÏú† ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.'); } catch(e) { alert('Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.'); } };

  initializePage();
</script>
</body>
</html>

