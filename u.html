<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</title>
<style>
  :root{--bg:#0b1020;--card:#121a33;--muted:#8aa0c7;--text:#e9f0ff;--accent:#6da7ff;--danger:#ff6c6c}
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Malgun Gothic,sans-serif}
  a{color:#8cffda;text-decoration:none} a:hover{text-decoration:underline}
  header{position:sticky;top:0;background:#0b1020cc;border-bottom:1px solid #1e2a55;backdrop-filter:blur(8px)}
  .wrap{max-width:1024px;margin:0 auto;padding:14px 18px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .card{background:#121a33;border:1px solid #1d274b;border-radius:14px;padding:16px}
  .list{display:grid;gap:12px}
  .project{background:#0f1731;border:1px solid #23305d;border-radius:12px;padding:12px}
  .muted{color:var(--muted)}
  input,textarea{width:100%;background:#0d152e;color:#e9f0ff;border:1px solid #23305d;border-radius:10px;padding:9px 11px}
  textarea{min-height:80px;resize:vertical}
  button{font:inherit;background:linear-gradient(135deg,var(--accent),#4f7fe0);color:#081225;border:0;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  button.secondary{background:#1b2750;color:#e9f0ff;border:1px solid #2b3a78}
  button.danger{background:#2a0f14;color:#ffc7c7;border:1px solid #5a1e25}
  button.mini{padding:6px 10px;border-radius:8px;font-size:12px}
  .chip{font-size:12px;padding:2px 8px;border:1px solid #2b3a78;border-radius:999px;color:#bcd0ff}
  .thumb{width:160px;height:100px;border-radius:8px;object-fit:cover;border:1px solid #23305d}
  /* ì„ íƒ ëª¨ë“œ: ì²´í¬ë°•ìŠ¤ í‘œì‹œ */
  .select-cb{display:none}
  .selecting .select-cb{display:inline-block}
  /* ìƒë‹¨ ìš°ì¸¡ ê³ ì • ì•¡ì…˜ */
  .right-wrap{position:relative;min-width:240px}
  .manage{position:absolute;top:-6px;right:-6px;display:flex;gap:6px;z-index:1}
  @media (max-width:560px){.right-wrap{position:static}.manage{position:static;margin-top:6px}}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="row"><strong>ğŸ“„ í¬íŠ¸í´ë¦¬ì˜¤</strong><span id="owner-chip" class="chip"></span></div>
    <div class="row" style="margin-left:auto">
      <span id="user-line" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
      <button id="btn-login" class="secondary">Google ë¡œê·¸ì¸</button>
      <button id="btn-logout" class="secondary" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      <a id="btn-home" class="secondary" href="index.html">ë©”ì¸</a>
      <button id="btn-copy" class="secondary">ê³µìœ  ë§í¬</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding:16px 18px">
  <section class="card">
    <h2 style="margin:0 0 8px">í”„ë¡œì íŠ¸ ì‘ì„±</h2>
    <p id="write-hint" class="muted">ì´ í˜ì´ì§€ì˜ ì†Œìœ ì/ê´€ë¦¬ì/ì´ˆëŒ€ëœ ì¹œêµ¬ë§Œ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.</p>
    <form id="form-new" class="list" style="display:none">
      <input id="p-title" placeholder="ì œëª©" required/>
      <textarea id="p-desc" placeholder="ì„¤ëª…" required></textarea>
      <div class="row" style="gap:8px">
        <input id="p-tags" placeholder="íƒœê·¸(ì‰¼í‘œ êµ¬ë¶„) ì˜ˆ: ar, esp32" style="flex:1"/>
        <input id="p-mainfile" type="file" style="flex:1"/>
      </div>
      <div class="row"><button type="submit">ë“±ë¡</button></div>
    </form>
  </section>

  <section class="card" style="margin-top:14px">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">í”„ë¡œì íŠ¸ ëª©ë¡</h2>
      <button id="btn-refresh" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div id="list" class="list" style="margin-top:10px"></div>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
  // ===== Firebase =====
  const cfg = {
    apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",
    authDomain:"propot-cc6bf.firebaseapp.com",
    projectId:"propot-cc6bf",
    storageBucket:"propot-cc6bf.firebasestorage.app",
    appId:"1:30940698980:web:1729f30e68d3beb24ac271"
  };
  firebase.initializeApp(cfg);
  const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

  // ===== helpers =====
  const $ = s=>document.querySelector(s);
  const esc = s=>String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c]));
  const parseTags = v=>String(v||'').split(/[, \t]+/).map(x=>x.trim().replace(/^#/,'').toLowerCase()).filter(Boolean).slice(0,10);
  const fmt = ts => ts?.toDate ? ts.toDate().toLocaleString() : (ts? new Date(ts).toLocaleString() : '');

  // ===== route / owner =====
  const params = new URLSearchParams(location.search);
  const ownerUid = params.get('uid');
  if(!ownerUid){ alert('ì˜ëª»ëœ ì ‘ê·¼: uidê°€ ì—†ìŠµë‹ˆë‹¤.'); location.href='index.html'; }
  $('#owner-chip').textContent = `owner: ${ownerUid.slice(0,8)}â€¦`;

  // owner ì´ë¦„ ë³´ì´ê¸°(ì„ íƒ)
  (async ()=>{
    try{
      const u = await db.collection('users').doc(ownerUid).get();
      const strong = document.querySelector('header strong');
      if(u.exists && strong){ strong.textContent = `${(u.data().displayName||'í¬íŠ¸í´ë¦¬ì˜¤')}ì˜ í¬íŠ¸í´ë¦¬ì˜¤`; }
    }catch{}
  })();

  const shareUrl = `${location.origin}${location.pathname}?uid=${encodeURIComponent(ownerUid)}`;
  $('#btn-copy').onclick = async ()=>{ await navigator.clipboard.writeText(shareUrl); alert('ê³µìœ  ë§í¬ ë³µì‚¬ë¨'); };

  // ===== auth / permission =====
  let me=null, isAdmin=false, canWrite=false;
  $('#btn-login').onclick = ()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message));
  $('#btn-logout').onclick= ()=>auth.signOut();
  $('#btn-refresh').onclick= ()=>loadProjects();

  async function computePermission(){
    if(!me){ canWrite=false; $('#form-new').style.display='none'; return; }
    const isOwner = me.uid===ownerUid;
    let isFriend = false;
    if(!isOwner && !isAdmin){
      try{ isFriend = (await db.collection('friends').doc(`${ownerUid}_${me.uid}`).get()).exists; }catch{}
    }
    canWrite = isOwner || isFriend || isAdmin;
    $('#write-hint').textContent = canWrite ? 'ì‘ì„± ê°€ëŠ¥ ì‚¬ìš©ìì…ë‹ˆë‹¤.' : 'ì‘ì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
    $('#form-new').style.display = canWrite ? '' : 'none';
  }

  auth.onAuthStateChanged(async u=>{
    me=u;
    if(u){
      $('#user-line').textContent = `${u.displayName||'ìµëª…'} (${u.email||''})`;
      $('#btn-login').style.display='none'; $('#btn-logout').style.display='';
      try{ isAdmin=(await db.collection('roles').doc(u.uid).get()).exists; }catch{ isAdmin=false; }
    }else{
      $('#user-line').textContent='ë¡œê·¸ì¸ í•„ìš”';
      $('#btn-login').style.display=''; $('#btn-logout').style.display='none';
    }
    await computePermission();
    await loadProjects();
  });

  // ===== list & render =====
  async function loadProjects(){
    const box = $('#list'); box.innerHTML='<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      const snap = await db.collection('projects').where('ownerUid','==',ownerUid).orderBy('createdAt','desc').limit(100).get();
      box.innerHTML='';
      if(snap.empty){ box.innerHTML='<div class="muted">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      snap.forEach(doc=>renderProject(doc.id, doc.data()));
    }catch(e){
      // composite index ì—†ì„ ë•Œ í´ë°±
      const snap2 = await db.collection('projects').where('ownerUid','==',ownerUid).get();
      const list = snap2.docs.map(d=>({id:d.id, data:d.data()}))
        .sort((a,b)=>(b.data.createdAt?.toMillis?.()||0)-(a.data.createdAt?.toMillis?.()||0));
      box.innerHTML='';
      if(!list.length){ box.innerHTML='<div class="muted">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      list.forEach(({id,data})=>renderProject(id,data));
    }
  }

  // ì„ íƒ ìƒíƒœ ì €ì¥
  const selComments = new Map(); // pid -> Set(cid)
  const selFiles    = new Map(); // pid -> Set(fid)

  function renderProject(id, d){
    const mine = me && (me.uid===d.authorUid);
    const allowManagePost = me && (mine || isAdmin);

    const el = document.createElement('article');
    el.className='project';
    el.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div style="flex:1;">
          <div id="view-${id}-head">
            <h3 style="margin:0">${esc(d.title)}</h3>
            <div class="muted" style="margin:2px 0 8px">${esc(d.authorName||'ìµëª…')} Â· ${fmt(d.createdAt)}</div>
          </div>

          <form id="edit-${id}-form" class="list" style="display:none">
            <input id="e-title-${id}" type="text" value="${esc(d.title)}" required/>
            <textarea id="e-desc-${id}" required>${esc(d.desc)}</textarea>
            <input id="e-tags-${id}" type="text" value="${esc((d.tags||[]).join(', '))}" placeholder="íƒœê·¸(ì‰¼í‘œ êµ¬ë¶„) ì˜ˆ: ar, esp32"/>
            <div class="row" style="gap:8px;align-items:center">
              <input type="file" id="e-mainfile-${id}" style="flex:1"/>
              ${d.mainFile?.url ? `<a class="chip" href="${d.mainFile.url}" target="_blank" rel="noopener">í˜„ì¬ ì²¨ë¶€ ì—´ê¸°</a>`:''}
              ${d.mainFile ? `<button class="danger mini" type="button" id="e-mainfile-del-${id}">ì²¨ë¶€ ì‚­ì œ</button>`:''}
              <button class="secondary mini" type="button" id="e-mainfile-up-${id}">ì²¨ë¶€ êµì²´ ì—…ë¡œë“œ</button>
            </div>
          </form>

          <div id="view-${id}-desc">
            <p style="margin:0">${esc(d.desc)}</p>
            ${(d.tags&&d.tags.length)?`<div class="row" style="gap:6px;margin-top:6px">${d.tags.map(t=>`<span class="chip">#${esc(t)}</span>`).join('')}</div>`:''}
            ${d.mainFile?.url?`<div style="margin-top:6px"><a class="chip" href="${d.mainFile.url}" target="_blank" rel="noopener">ì²¨ë¶€ ë³´ê¸°</a></div>`:''}
          </div>
        </div>

        <div class="right-wrap">
          ${allowManagePost?`
          <div class="manage">
            <button class="ghost mini"    id="btn-edit-${id}">ìˆ˜ì •</button>
            <button class="danger mini"   id="btn-del-${id}">ì‚­ì œ</button>
            <button class="secondary mini" id="btn-save-${id}" style="display:none">ì €ì¥</button>
            <button class="ghost mini"     id="btn-cancel-${id}" style="display:none">ì·¨ì†Œ</button>
          </div>`:''}
        </div>
      </div>

      <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
      <div class="card" style="margin-top:10px; background:#0f1731; border-color:#23305d;">
        <h4 style="margin:0 0 8px">ğŸ’¬ ëŒ“ê¸€</h4>
        <div class="row" id="c-toolbar-${id}" style="gap:6px; flex-wrap:wrap;">
          <button class="ghost mini" id="c-enter-${id}">ì„ íƒ</button>
          <button class="secondary mini" id="c-edit-${id}" style="display:none;" disabled>ì„ íƒ ìˆ˜ì •(1ê°œ)</button>
          <button class="danger mini"    id="c-del-${id}"  style="display:none;" disabled>ì„ íƒ ì‚­ì œ</button>
          <span class="muted" id="c-count-${id}" style="display:none;">0ê°œ ì„ íƒ</span>
          <button class="ghost mini" id="c-cancel-${id}" style="display:none;">ì·¨ì†Œ</button>
        </div>
        <div id="comments-${id}" class="list" style="margin-top:8px"></div>
        <form class="list" id="form-comment-${id}" style="margin-top:6px">
          <textarea id="c-${id}" placeholder="ëŒ“ê¸€ ì…ë ¥(ë¡œê·¸ì¸ í•„ìš”)" required></textarea>
          <div class="row"><button type="submit" class="secondary">ëŒ“ê¸€ ë“±ë¡</button></div>
        </form>
      </div>

      <!-- íŒŒì¼ ì„¹ì…˜ -->
      <div class="card" style="margin-top:10px; background:#0f1731; border-color:#23305d;">
        <h4 style="margin:0 0 8px">ğŸ“ íŒŒì¼</h4>
        <div class="row" id="f-toolbar-${id}" style="gap:6px; flex-wrap:wrap;">
          <button class="ghost mini" id="f-enter-${id}">ì„ íƒ</button>
          <button class="secondary mini" id="f-rename-${id}"  style="display:none;" disabled>ì´ë¦„ìˆ˜ì •(1ê°œ)</button>
          <input type="file" id="f-repl-input-${id}" style="display:none"/>
          <button class="secondary mini" id="f-replace-${id}" style="display:none;" disabled>íŒŒì¼êµì²´(1ê°œ)</button>
          <button class="danger mini"    id="f-del-${id}"     style="display:none;" disabled>ì„ íƒ ì‚­ì œ</button>
          <span class="muted" id="f-count-${id}" style="display:none;">0ê°œ ì„ íƒ</span>
          <button class="ghost mini" id="f-cancel-${id}" style="display:none;">ì·¨ì†Œ</button>
        </div>
        <div id="files-${id}" class="list" style="margin-top:8px"></div>
        <form class="row" id="form-file-${id}" style="margin-top:8px; flex-wrap:wrap; gap:8px;">
          <input type="file" id="f-${id}"/>
          <button type="submit">ì—…ë¡œë“œ</button>
        </form>
      </div>
    `;
    $('#list').appendChild(el);

    // ===== ê²Œì‹œê¸€ ìˆ˜ì •/ì‚­ì œ (ì „ì²˜ëŸ¼: ë·° â†” í¼ í† ê¸€ + ì €ì¥/ì·¨ì†Œ) =====
    if(allowManagePost){
      const btnEdit   = document.getElementById(`btn-edit-${id}`);
      const btnDel    = document.getElementById(`btn-del-${id}`);
      const btnSave   = document.getElementById(`btn-save-${id}`);
      const btnCancel = document.getElementById(`btn-cancel-${id}`);
      const formE     = document.getElementById(`edit-${id}-form`);
      const headV     = document.getElementById(`view-${id}-head`);
      const descV     = document.getElementById(`view-${id}-desc`);

      const enterEdit = ()=>{
        formE.style.display=''; headV.style.display='none'; descV.style.display='none';
        btnEdit.style.display='none'; btnDel.style.display='none';
        btnSave.style.display=''; btnCancel.style.display='';
      };
      const exitEdit = ()=>{
        formE.style.display='none'; headV.style.display=''; descV.style.display='';
        btnEdit.style.display=''; btnDel.style.display='';
        btnSave.style.display='none'; btnCancel.style.display='none';
      };
      const saveEdit = async ()=>{
        const title = document.getElementById(`e-title-${id}`).value.trim();
        const desc  = document.getElementById(`e-desc-${id}`).value.trim();
        const tags  = parseTags(document.getElementById(`e-tags-${id}`).value||'');
        if(!title||!desc){ alert('ì œëª©/ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        try{
          await db.collection('projects').doc(id).update({
            title, desc, tags, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          await loadProjects();
        }catch(e){ alert('ìˆ˜ì • ì‹¤íŒ¨: '+e.message); }
      };

      btnEdit?.addEventListener('click', enterEdit);
      btnCancel?.addEventListener('click', exitEdit);
      btnSave?.addEventListener('click', saveEdit);

      btnDel?.addEventListener('click', async ()=>{
        if(!confirm('ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”? (ëŒ“ê¸€/íŒŒì¼ ê¸°ë¡ë„ ì‚­ì œë©ë‹ˆë‹¤)')) return;
        try{
          const ref = db.collection('projects').doc(id);
          // ì„œë¸Œì»¬ë ‰ì…˜ ì‚­ì œ
          const cs = await ref.collection('comments').get();
          const fs = await ref.collection('files').get();
          const batch = db.batch();
          cs.forEach(x=>batch.delete(x.ref));
          fs.forEach(x=>batch.delete(x.ref));
          await batch.commit();
          // ëŒ€í‘œ ì²¨ë¶€ ì‚­ì œ ì‹œë„
          if(d.mainFile?.storagePath){
            try{ await storage.ref().child(d.mainFile.storagePath).delete(); }catch(e){ console.warn('ëŒ€í‘œì²¨ë¶€ ì‚­ì œ ì‹¤íŒ¨', e); }
          }
          await ref.delete();
          loadProjects();
        }catch(e){ alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
      });

      // ëŒ€í‘œ ì²¨ë¶€ êµì²´/ì‚­ì œ
      const mainInp = document.getElementById(`e-mainfile-${id}`);
      const mainUp  = document.getElementById(`e-mainfile-up-${id}`);
      const mainDel = document.getElementById(`e-mainfile-del-${id}`);

      mainUp?.addEventListener('click', async ()=>{
        const f = mainInp?.files?.[0];
        if(!f){ alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
        if(f.size > 10*1024*1024){ alert('10MB ì´í•˜ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
        try{
          const path = `uploads/${id}/main_${Date.now()}_${f.name}`;
          const ref  = storage.ref().child(path);
          await ref.put(f,{customMetadata:{ownerUid: (me?.uid)||''}});
          const url  = await ref.getDownloadURL();
          await db.collection('projects').doc(id).update({
            mainFile:{ name:f.name,size:f.size,contentType:f.type,url,storagePath:path,uploadedAt:firebase.firestore.FieldValue.serverTimestamp(),ownerUid:(me?.uid)||'' },
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          // ì´ì „ íŒŒì¼ ì •ë¦¬
          if(d.mainFile?.storagePath){ try{ await storage.ref().child(d.mainFile.storagePath).delete(); }catch(e){} }
          await loadProjects();
        }catch(e){ alert('ì²¨ë¶€ êµì²´ ì‹¤íŒ¨: '+e.message); }
      });

      mainDel?.addEventListener('click', async ()=>{
        if(!confirm('ëŒ€í‘œ ì²¨ë¶€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
        try{
          if(d.mainFile?.storagePath){ try{ await storage.ref().child(d.mainFile.storagePath).delete(); }catch(e){} }
          await db.collection('projects').doc(id).update({ mainFile:null, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
          await loadProjects();
        }catch(e){ alert('ì²¨ë¶€ ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
      });
    }

    // ===== ëŒ“ê¸€ & íŒŒì¼ ê¸°ëŠ¥(ì„ íƒ ìˆ˜ì •/ì‚­ì œ / ì´ë¦„ìˆ˜ì •Â·êµì²´Â·ì‚­ì œ) =====
    setupCommentToolbar(id);  loadComments(id);
    setupFileToolbar(id);     loadFiles(id);

    document.getElementById(`form-comment-${id}`).addEventListener('submit', ev=>addComment(ev,id));
    document.getElementById(`form-file-${id}`).addEventListener('submit',  ev=>uploadFile(ev,id));

    // ë·° ì˜ì—­ ë‚´ìš©(ì„¤ëª…/íƒœê·¸/ì²¨ë¶€)ì€ ì €ì¥ í›„ ì „ì²´ ë¦¬ë¡œë“œ(loadProjects)ë¡œ ë™ê¸°í™”
  }

  // ===== ëŒ“ê¸€: ì„ íƒ í¸ì§‘/ì‚­ì œ =====
  function setupCommentToolbar(pid){
    const enter = $(`#c-enter-${pid}`);
    const edit  = $(`#c-edit-${pid}`);
    const del   = $(`#c-del-${pid}`);
    const cancel= $(`#c-cancel-${pid}`);
    const count = $(`#c-count-${pid}`);
    selComments.set(pid, new Set());

    const updateUI = ()=>{
      const n = selComments.get(pid).size;
      count.textContent = `${n}ê°œ ì„ íƒ`;
      edit.disabled = (n!==1);
      del .disabled = (n===0);
    };

    enter.addEventListener('click', ()=>{
      $(`#comments-${pid}`).classList.add('selecting');
      edit.style.display=''; del.style.display=''; count.style.display=''; cancel.style.display=''; enter.style.display='none';
      updateUI();
    });
    cancel.addEventListener('click', ()=>{
      selComments.set(pid,new Set());
      const list = $(`#comments-${pid}`);
      list.classList.remove('selecting');
      list.querySelectorAll('.select-cb').forEach(cb=>cb.checked=false);
      edit.style.display='none'; del.style.display='none'; count.style.display='none'; cancel.style.display='none'; enter.style.display='';
    });

    edit.addEventListener('click', async ()=>{
      const set = selComments.get(pid); if(set.size!==1) return;
      const cid = [...set][0];
      try{
        const snap = await db.collection('projects').doc(pid).collection('comments').doc(cid).get();
        const cur  = (snap.exists && snap.data()?.text) || '';
        const next = prompt('ìƒˆ ëŒ“ê¸€ ë‚´ìš©', cur);
        if(next==null) return;
        const text = (next||'').trim(); if(!text) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
        await db.collection('projects').doc(pid).collection('comments').doc(cid)
          .update({ text, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        loadComments(pid);
      }catch(e){ alert('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨: '+e.message); }
    });

    del.addEventListener('click', async ()=>{
      const set = selComments.get(pid); if(set.size===0) return;
      if(!confirm(`${set.size}ê°œ ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
      try{
        const batch = db.batch();
        set.forEach(cid=>{
          batch.delete(db.collection('projects').doc(pid).collection('comments').doc(cid));
        });
        await batch.commit();
        loadComments(pid);
      }catch(e){ alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
    });

    enter._update = updateUI;
  }

  async function loadComments(pid){
    const box = $(`#comments-${pid}`);
    box.innerHTML = '<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      const snap = await db.collection('projects').doc(pid).collection('comments')
        .orderBy('createdAt','desc').limit(100).get();
      box.innerHTML = '';
      if(snap.empty){ box.innerHTML = '<div class="muted">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      const set = selComments.get(pid) || new Set();
      snap.forEach(doc=>{
        const c = doc.data(); const cid = doc.id;
        const canManage = me && (isAdmin || me.uid===c.authorUid);
        const row = document.createElement('div');
        row.className='project';
        row.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <div class="muted" style="font-size:12px">${esc(c.authorName||'ìµëª…')} Â· ${fmt(c.createdAt)}${c.updatedAt?' (ìˆ˜ì •ë¨)':''}</div>
              <div>${esc(c.text)}</div>
            </div>
            <div>
              <input type="checkbox" class="select-cb" ${canManage?'':'disabled'} id="c-cb-${pid}-${cid}">
            </div>
          </div>`;
        box.appendChild(row);

        const cb = row.querySelector(`#c-cb-${pid}-${cid}`);
        if(cb){
          cb.checked = set.has(cid);
          cb.addEventListener('change', ()=>{
            const S = selComments.get(pid);
            if(cb.checked) S.add(cid); else S.delete(cid);
            const enterBtn = document.getElementById(`c-enter-${pid}`);
            if(enterBtn && enterBtn._update) enterBtn._update();
          });
        }
      });
      const enterBtn = document.getElementById(`c-enter-${pid}`);
      if(enterBtn && enterBtn._update) enterBtn._update();
    }catch(e){
      box.innerHTML = `<div class="muted">ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨: ${esc(e.message)}</div>`;
    }
  }

  async function addComment(e, pid){
    e.preventDefault();
    if(!me) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    const ta = document.getElementById(`c-${pid}`);
    const text = (ta.value||'').trim(); if(!text) return;
    try{
      await db.collection('projects').doc(pid).collection('comments').add({
        text, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        authorUid: me.uid, authorName: me.displayName||'ìµëª…'
      });
      ta.value=''; loadComments(pid);
    }catch(err){ alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: '+err.message); }
  }

  // ===== íŒŒì¼: ì„ íƒ ì´ë¦„ìˆ˜ì • / ì„ íƒ êµì²´ / ì„ íƒ ì‚­ì œ =====
  function setupFileToolbar(pid){
    const enter = $(`#f-enter-${pid}`);
    const rename= $(`#f-rename-${pid}`);
    const repIn = $(`#f-repl-input-${pid}`);
    const replace=$(`#f-replace-${pid}`);
    const del   = $(`#f-del-${pid}`);
    const cancel= $(`#f-cancel-${pid}`);
    const count = $(`#f-count-${pid}`);
    selFiles.set(pid, new Set());

    const updateUI = ()=>{
      const n = selFiles.get(pid).size;
      count.textContent = `${n}ê°œ ì„ íƒ`;
      rename.disabled  = (n!==1);
      replace.disabled = (n!==1);
      del.disabled     = (n===0);
    };

    enter.addEventListener('click', ()=>{
      $(`#files-${pid}`).classList.add('selecting');
      rename.style.display=''; replace.style.display=''; del.style.display=''; count.style.display=''; cancel.style.display=''; enter.style.display='none';
      updateUI();
    });
    cancel.addEventListener('click', ()=>{
      selFiles.set(pid,new Set());
      const list = $(`#files-${pid}`);
      list.classList.remove('selecting');
      list.querySelectorAll('.select-cb').forEach(cb=>cb.checked=false);
      rename.style.display='none'; replace.style.display='none'; del.style.display='none'; count.style.display='none'; cancel.style.display='none'; enter.style.display='';
      repIn.value = '';
    });

    rename.addEventListener('click', async ()=>{
      const set = selFiles.get(pid); if(set.size!==1) return;
      const fid = [...set][0];
      try{
        const snap = await db.collection('projects').doc(pid).collection('files').doc(fid).get();
        const cur  = (snap.exists && snap.data()?.name) || '';
        const next = prompt('ìƒˆ íŒŒì¼ ì´ë¦„(í‘œì‹œìš©)', cur);
        if(next==null) return;
        await db.collection('projects').doc(pid).collection('files').doc(fid)
          .update({ name: (next.trim()||cur), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
        loadFiles(pid);
      }catch(e){ alert('íŒŒì¼ ì´ë¦„ ìˆ˜ì • ì‹¤íŒ¨: '+e.message); }
    });

    replace.addEventListener('click', async ()=>{
      const set = selFiles.get(pid); if(set.size!==1) return;
      const fid = [...set][0];
      repIn.click();
      repIn.onchange = async ()=>{
        const nf = repIn.files && repIn.files[0];
        if(!nf) return;
        if(nf.size > 10*1024*1024) { alert('10MB ì´í•˜ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); repIn.value=''; return; }
        try{
          const doc = await db.collection('projects').doc(pid).collection('files').doc(fid).get();
          const old = doc.data() || {};
          const path = `uploads/${pid}/${Date.now()}_${nf.name}`;
          const ref  = storage.ref().child(path);
          await ref.put(nf,{customMetadata:{ownerUid: old.ownerUid || (me?.uid||'')}});
          const url = await ref.getDownloadURL();
          await db.collection('projects').doc(pid).collection('files').doc(fid).update({
            name:nf.name, size:nf.size, contentType:nf.type,
            url, storagePath:path, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          if(old.storagePath){ try{ await storage.ref().child(old.storagePath).delete(); }catch{} }
          loadFiles(pid);
        }catch(e){ alert('íŒŒì¼ êµì²´ ì‹¤íŒ¨: '+e.message); }
        finally{ repIn.value=''; }
      };
    });

    del.addEventListener('click', async ()=>{
      const set = selFiles.get(pid); if(set.size===0) return;
      if(!confirm(`${set.size}ê°œ íŒŒì¼ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
      try{
        for(const fid of set){
          const doc = await db.collection('projects').doc(pid).collection('files').doc(fid).get();
          const f = doc.data() || {};
          if(f.storagePath){ try{ await storage.ref().child(f.storagePath).delete(); }catch{} }
          await db.collection('projects').doc(pid).collection('files').doc(fid).delete();
        }
        loadFiles(pid);
      }catch(e){ alert('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
    });

    enter._update = updateUI;
  }

  async function loadFiles(pid){
    const box = $(`#files-${pid}`);
    box.innerHTML = '<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      const snap = await db.collection('projects').doc(pid).collection('files')
        .orderBy('createdAt','desc').limit(100).get();
      box.innerHTML='';
      if(snap.empty){ box.innerHTML = '<div class="muted">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      const set = selFiles.get(pid) || new Set();
      snap.forEach(doc=>{
        const f = doc.data(); const fid = doc.id;
        const can = me && (isAdmin || me.uid===f.ownerUid);
        const isImg = (f.contentType||'').startsWith('image/');
        const row = document.createElement('div');
        row.className='project';
        row.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="row" style="gap:10px;align-items:center;flex:1">
              ${isImg?`<img class="thumb" src="${esc(f.url)}" alt="${esc(f.name||'image')}">`:''}
              <div>
                <div class="muted">${esc(f.name||'íŒŒì¼')} (${f.size||0}B)</div>
                <a href="${esc(f.url)}" target="_blank" rel="noopener">${isImg?'ì›ë³¸ ì—´ê¸°':'ë‹¤ìš´ë¡œë“œ'}</a>
                ${f.updatedAt?`<span class="chip" style="margin-left:6px;">ìˆ˜ì •ë¨</span>`:''}
              </div>
            </div>
            <div><input type="checkbox" class="select-cb" ${can?'':'disabled'} id="f-cb-${pid}-${fid}"></div>
          </div>`;
        box.appendChild(row);

        const cb = row.querySelector(`#f-cb-${pid}-${fid}`);
        if(cb){
          cb.checked = set.has(fid);
          cb.addEventListener('change', ()=>{
            const S = selFiles.get(pid);
            if(cb.checked) S.add(fid); else S.delete(fid);
            const enterBtn = document.getElementById(`f-enter-${pid}`);
            if(enterBtn && enterBtn._update) enterBtn._update();
          });
        }
      });
      const enterBtn = document.getElementById(`f-enter-${pid}`);
      if(enterBtn && enterBtn._update) enterBtn._update();
    }catch(e){
      box.innerHTML = `<div class="muted">íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${esc(e.message)}</div>`;
    }
  }

  async function uploadFile(e, pid){
    e.preventDefault();
    if(!me) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    const input = document.getElementById(`f-${pid}`);
    const file  = input.files && input.files[0];
    if(!file) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
    if(file.size > 10*1024*1024) return alert('íŒŒì¼ì€ ìµœëŒ€ 10MBì…ë‹ˆë‹¤.');

    try{
      const path = `uploads/${pid}/${Date.now()}_${file.name}`;
      const ref  = storage.ref().child(path);
      const snap = await ref.put(file,{customMetadata:{ownerUid: me.uid, ownerEmail: me.email||''}});
      const url  = await snap.ref.getDownloadURL();
      await db.collection('projects').doc(pid).collection('files').add({
        name:file.name, size:file.size, contentType:file.type, url, storagePath:path,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        ownerUid: me.uid, ownerName: me.displayName||'ìµëª…'
      });
      input.value=''; loadFiles(pid);
    }catch(e){ alert('ì—…ë¡œë“œ ì‹¤íŒ¨: '+e.message); }
  }

  // ===== ì‘ì„± í¼ =====
  document.getElementById('form-new').addEventListener('submit', async e=>{
    e.preventDefault(); if(!me || !canWrite) return alert('ê¶Œí•œ ì—†ìŒ');
    const title=$('#p-title').value.trim(), desc=$('#p-desc').value.trim();
    const tags=parseTags($('#p-tags').value); const mf=$('#p-mainfile').files[0];
    if(!title || !desc) return alert('ì œëª©/ì„¤ëª…ì€ í•„ìˆ˜');
    try{
      const ref = await db.collection('projects').add({
        ownerUid, title, desc, tags,
        authorUid: me.uid, authorName: me.displayName||'ìµëª…', authorEmail: me.email||null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        mainFile: null
      });
      if(mf){
        if(mf.size>10*1024*1024) throw new Error('íŒŒì¼ì€ ìµœëŒ€ 10MB');
        const path=`uploads/${ref.id}/main_${Date.now()}_${mf.name}`;
        const snap=await storage.ref().child(path).put(mf,{customMetadata:{ownerUid:me.uid}});
        const url=await snap.ref.getDownloadURL();
        await ref.update({ mainFile:{name:mf.name,size:mf.size,contentType:mf.type,url,storagePath:path,uploadedAt:firebase.firestore.FieldValue.serverTimestamp(),ownerUid:me.uid}});
      }
      e.target.reset(); loadProjects();
    }catch(err){ alert('ë“±ë¡ ì‹¤íŒ¨: '+err.message); }
  });
</script>

<!--
Firestore ê·œì¹™(ìš”ì•½)
- projects/{pid}: createëŠ” authorUid==auth.uid && ownerUidê°€ ë³¸ì¸/ì¹œêµ¬/ê´€ë¦¬ì ì¤‘ í•˜ë‚˜ì¼ ë•Œ í—ˆìš©
- projects/{pid}/comments: read:true, create: ì‘ì„±ì, update/delete: ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ì
- projects/{pid}/files:    read:true, create: ì—…ë¡œë”, update/delete: ì—…ë¡œë” ë˜ëŠ” ê´€ë¦¬ì
Storage: /uploads/** write: ë¡œê·¸ì¸ & 10MB ì´í•˜ (ì‚­ì œëŠ” ì—…ë¡œë”ë§Œ ë“± í•„ìš”ì‹œ ì¶”ê°€)

ê·œì¹™ì´ ë§ì§€ ì•Šìœ¼ë©´ ì„ íƒ/í¸ì§‘/ì‚­ì œê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆì–´ìš”.
-->
</body>
</html>
