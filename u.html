<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</title>

  <link rel="canonical" href="https://kimys01.github.io/propot/u.html">
  <meta name="theme-color" content="#0b1020">
  <link rel="icon" href="web/favicon.svg">

  <meta property="og:type" content="website">
  <meta property="og:title" content="ë‚´ í¬íŠ¸í´ë¦¬ì˜¤">
  <meta property="og:description" content="ë‚´ê°€ ì“´ í”„ë¡œì íŠ¸ì™€ ì²¨ë¶€/ëŒ“ê¸€">
  <meta property="og:image" content="https://kimys01.github.io/propot/web/og-card.png">

  <link rel="stylesheet" href="base.css?v=2025-09-18-1">
  <link rel="stylesheet" href="u.css?v=2025-09-18-1">
</head>
<body>
<header>
  <div class="wrap row">
    <div class="row"><strong>ğŸ“„ í¬íŠ¸í´ë¦¬ì˜¤</strong><span id="owner-chip" class="chip"></span></div>
    <div class="row" style="margin-left:auto">
      <span id="user-line" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
      <button id="btn-login" class="secondary" aria-label="êµ¬ê¸€ ë¡œê·¸ì¸">Google ë¡œê·¸ì¸</button>
      <button id="btn-logout" class="secondary" style="display:none" aria-label="ë¡œê·¸ì•„ì›ƒ">ë¡œê·¸ì•„ì›ƒ</button>
      <a id="btn-home" class="secondary" href="index.html" aria-label="ë©”ì¸ìœ¼ë¡œ">ë©”ì¸</a>
      <button id="btn-copy" class="secondary" aria-label="ê³µìœ  ë§í¬ ë³µì‚¬">ê³µìœ  ë§í¬</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding:16px 18px">
  <section class="card">
    <h2 style="margin:0 0 8px">í”„ë¡œì íŠ¸ ì‘ì„±</h2>
    <p id="write-hint" class="muted">ì´ í˜ì´ì§€ì˜ ì†Œìœ ì/ê´€ë¦¬ì/ì´ˆëŒ€ëœ ì¹œêµ¬ë§Œ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.</p>
    <form id="form-new" class="list" style="display:none">
      <input id="p-title" placeholder="ì œëª©" required aria-label="ì œëª©"/>
      <textarea id="p-desc" placeholder="ì„¤ëª…" required aria-label="ì„¤ëª…"></textarea>
      <div class="row" style="gap:8px">
        <input id="p-tags" placeholder="íƒœê·¸(ì‰¼í‘œ êµ¬ë¶„) ì˜ˆ: ar, esp32" style="flex:1" aria-label="íƒœê·¸"/>
        <input id="p-mainfile" type="file" style="flex:1" aria-label="ëŒ€í‘œ ì²¨ë¶€íŒŒì¼"/>
      </div>
      <div class="row"><button type="submit">ë“±ë¡</button></div>
    </form>
  </section>

  <section class="card" style="margin-top:14px">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">í”„ë¡œì íŠ¸ ëª©ë¡</h2>
      <button id="btn-refresh" class="secondary" aria-label="ìƒˆë¡œê³ ì¹¨">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div id="list" class="list" style="margin-top:10px"></div>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
  const cfg = {
    apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",
    authDomain:"propot-cc6bf.firebaseapp.com",
    projectId:"propot-cc6bf",
    storageBucket:"propot-cc6bf.firebasestorage.app",
    appId:"1:30940698980:web:1729f30e68d3beb24ac271"
  };
  firebase.initializeApp(cfg);
  const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

  const $ = s=>document.querySelector(s);
  const esc = s=>String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const parseTags = v=>String(v||'').split(/[, \t]+/).map(x=>x.trim().replace(/^#/,'').toLowerCase()).filter(Boolean).slice(0,10);

  // === Error logging (same as index.html)
  async function logError(error, context) {
    try {
      await db.collection('clientLogs').add({
        at: firebase.firestore.FieldValue.serverTimestamp(),
        path: location.pathname + location.search,
        uid: (auth.currentUser && auth.currentUser.uid) || null,
        context: context || null,
        message: String(error && (error.message || error)) || '',
        stack: String(error && error.stack) || ''
      });
    } catch (_) {}
  }
  window.addEventListener('error', (e)=>logError(e.error||e.message, 'window.error'));
  window.addEventListener('unhandledrejection', (e)=>logError(e.reason, 'unhandledrejection'));

  const params = new URLSearchParams(location.search);
  const ownerUid = params.get('uid');
  if(!ownerUid){ alert('ì˜ëª»ëœ ì ‘ê·¼: uidê°€ ì—†ìŠµë‹ˆë‹¤.'); location.href='index.html'; }
  $('#owner-chip').textContent = `owner: ${ownerUid.slice(0,8)}â€¦`;

  const shareUrl = `${location.origin}${location.pathname}?uid=${encodeURIComponent(ownerUid)}`;
  $('#btn-copy').onclick = async ()=>{ try{ await navigator.clipboard.writeText(shareUrl); alert('ê³µìœ  ë§í¬ ë³µì‚¬ë¨'); } catch(e){ logError(e,'copy'); alert('ë³µì‚¬ ì‹¤íŒ¨: '+e.message); } };

  let me=null, isAdmin=false, canWrite=false;

  $('#btn-login').onclick = ()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>{ logError(e,'login'); alert(e.message); });
  $('#btn-logout').onclick= ()=>auth.signOut();
  $('#btn-refresh').onclick= ()=>loadProjects();

  function fmt(ts){ if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString(); }

  async function computePermission(){
    if(!me){ canWrite=false; $('#form-new').style.display='none'; return; }
    const isOwner = me.uid===ownerUid;
    let isFriend = false;
    if(!isOwner && !isAdmin){
      try{
        const q = await db.collection('friends')
          .where('ownerUid','==',ownerUid).where('friendUid','==',me.uid).limit(1).get();
        isFriend = !q.empty;
      }catch(e){ logError(e,'friend-check'); }
    }
    canWrite = isOwner || isFriend || isAdmin;
    $('#write-hint').textContent = canWrite ? 'ì‘ì„± ê°€ëŠ¥ ì‚¬ìš©ìì…ë‹ˆë‹¤.' : 'ì‘ì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
    $('#form-new').style.display = canWrite ? '' : 'none';
  }

  auth.onAuthStateChanged(async u=>{
    me=u;
    if(u){
      $('#user-line').textContent = `${u.displayName||'ìµëª…'} (${u.email||''})`;
      $('#btn-login').style.display='none'; $('#btn-logout').style.display='';
      try{ isAdmin=(await db.collection('roles').doc(u.uid).get()).exists; }catch{ isAdmin=false; }
    }else{
      $('#user-line').textContent='ë¡œê·¸ì¸ í•„ìš”';
      $('#btn-login').style.display=''; $('#btn-logout').style.display='none';
    }
    await computePermission();
    await loadProjects();
  });

  async function loadProjects(){
    const box = $('#list'); box.innerHTML='<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      const snap = await db.collection('projects')
        .where('ownerUid','==',ownerUid)
        .orderBy('createdAt','desc').limit(100).get();
      box.innerHTML='';
      if(snap.empty){ box.innerHTML='<div class="muted">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      snap.forEach(doc=>renderProject(doc.id, doc.data()));
    }catch(e){ logError(e,'loadProjects'); box.innerHTML=`<div class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(e.message)}</div>`; }
  }

  function renderProject(id, d){
    const mine = me && (me.uid===d.authorUid);
    const allowManage = me && (mine || isAdmin);
    const el = document.createElement('article');
    el.className='project';
    el.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h3 style="margin:0">${esc(d.title)}</h3>
          <div class="muted" style="margin:2px 0 8px">${esc(d.authorName||'ìµëª…')} Â· ${fmt(d.createdAt)}</div>
          <p style="margin:0">${esc(d.desc)}</p>
          ${(d.tags&&d.tags.length)?`<div class="row" style="gap:6px;margin-top:6px">${d.tags.map(t=>`<span class="chip">#${esc(t)}</span>`).join('')}</div>`:''}
          ${d.mainFile?.url?`<div style="margin-top:6px"><a class="chip" href="${d.mainFile.url}" target="_blank" rel="noopener">ì²¨ë¶€ ë³´ê¸°</a></div>`:''}
        </div>
        <div class="row" style="gap:6px">
          ${allowManage?`<button class="secondary" data-act="edit" aria-label="ê²Œì‹œê¸€ ìˆ˜ì •">ìˆ˜ì •</button><button class="secondary" data-act="del" aria-label="ê²Œì‹œê¸€ ì‚­ì œ">ì‚­ì œ</button>`:''}
        </div>
      </div>`;
    const btns = el.querySelectorAll('button[data-act]');
    btns.forEach(b=>{
      b.onclick=async()=>{
        if(b.dataset.act==='del'){
          if(!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
          try{ await db.collection('projects').doc(id).delete(); loadProjects(); }
          catch(e){ logError(e,'post-delete'); alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
        }else{
          const nt = prompt('ìƒˆ ì œëª©', d.title||''); if(nt==null) return;
          const nd = prompt('ìƒˆ ì„¤ëª…', d.desc||''); if(nd==null) return;
          try{
            await db.collection('projects').doc(id).update({
              title: nt.trim(),
              desc: nd.trim(),
              updatedAt:firebase.firestore.FieldValue.serverTimestamp()
            });
            loadProjects();
          }catch(e){ logError(e,'post-edit'); alert('ìˆ˜ì • ì‹¤íŒ¨: '+e.message); }
        }
      };
    });
    $('#list').appendChild(el);
  }

  // ìƒˆ ê¸€
  document.getElementById('form-new').addEventListener('submit', async e=>{
    e.preventDefault(); if(!me || !canWrite) return alert('ê¶Œí•œ ì—†ìŒ');
    const title=$('#p-title').value.trim(), desc=$('#p-desc').value.trim();
    const tags=parseTags($('#p-tags').value); const mf=$('#p-mainfile').files[0];
    if(!title || !desc) return alert('ì œëª©/ì„¤ëª…ì€ í•„ìˆ˜');
    try{
      const ref = await db.collection('projects').add({
        ownerUid, title, desc, tags,
        authorUid: me.uid, authorName: me.displayName||'ìµëª…', authorEmail: me.email||null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        mainFile: null
      });
      if(mf){
        if(mf.size>10*1024*1024) throw new Error('íŒŒì¼ì€ ìµœëŒ€ 10MB');
        const path=`uploads/${ref.id}/main_${Date.now()}_${mf.name}`;
        const snap=await storage.ref().child(path).put(mf,{customMetadata:{ownerUid:me.uid}});
        const url=await snap.ref.getDownloadURL();
        await ref.update({ mainFile:{name:mf.name,size:mf.size,contentType:mf.type,url,storagePath:path,uploadedAt:firebase.firestore.FieldValue.serverTimestamp(),ownerUid:me.uid}});
      }
      e.target.reset(); loadProjects();
    }catch(err){ logError(err,'post-create'); alert('ë“±ë¡ ì‹¤íŒ¨: '+err.message); }
  });

  // ê³µìœ  ë§í¬ ë³µì‚¬
  // (ìœ„ì—ì„œ ì •ì˜)
</script>
</body>
</html>
