<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</title>
<link rel="stylesheet" href="assets/css/base.css">
<link rel="stylesheet" href="assets/css/u.css">
</head>
<body>
<header>
  <div class="wrap row">
    <div class="row"><strong>ğŸ“„ í¬íŠ¸í´ë¦¬ì˜¤</strong><span id="owner-chip" class="chip"></span></div>
    <div class="row" style="margin-left:auto">
      <span id="user-line" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
      <button id="btn-login" class="secondary">Google ë¡œê·¸ì¸</button>
      <button id="btn-logout" class="secondary" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      <a id="btn-home" class="secondary" href="index.html">ë©”ì¸</a>
      <button id="btn-copy" class="secondary">ê³µìœ  ë§í¬</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding:16px 18px">
  <section class="card">
    <h2 style="margin:0 0 8px">í”„ë¡œì íŠ¸ ì‘ì„±</h2>
    <p id="write-hint" class="muted">ì´ í˜ì´ì§€ì˜ ì†Œìœ ì/ê´€ë¦¬ì/ì´ˆëŒ€ëœ ì¹œêµ¬ë§Œ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.</p>
    <form id="form-new" class="list" style="display:none">
      <input id="p-title" placeholder="ì œëª©" required/>
      <textarea id="p-desc" placeholder="ì„¤ëª…" required></textarea>
      <div class="row" style="gap:8px">
        <input id="p-tags" placeholder="íƒœê·¸(ì‰¼í‘œ êµ¬ë¶„) ì˜ˆ: ar, esp32" style="flex:1"/>
        <input id="p-mainfile" type="file" style="flex:1"/>
      </div>
      <div class="row"><button type="submit">ë“±ë¡</button></div>
    </form>
  </section>

  <section class="card" style="margin-top:14px">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">í”„ë¡œì íŠ¸ ëª©ë¡</h2>
      <button id="btn-refresh" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div id="list" class="list" style="margin-top:10px"></div>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
  // ===== Firebase =====
  const cfg = {
    apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",
    authDomain:"propot-cc6bf.firebaseapp.com",
    projectId:"propot-cc6bf",
    storageBucket:"propot-cc6bf.firebasestorage.app",
    appId:"1:30940698980:web:1729f30e68d3beb24ac271"
  };
  firebase.initializeApp(cfg);
  const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

  // ===== Helpers =====
  const $ = s=>document.querySelector(s);
  const esc = s=>String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  const parseTags = v=>String(v||'').split(/[, \t]+/).map(x=>x.trim().replace(/^#/,'').toLowerCase()).filter(Boolean).slice(0,10);
  const fmt = ts => { if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString(); };

  // ===== Owner (page) =====
  const params = new URLSearchParams(location.search);
  const ownerUid = params.get('uid');
  if(!ownerUid){ alert('ì˜ëª»ëœ ì ‘ê·¼: uidê°€ ì—†ìŠµë‹ˆë‹¤.'); location.href='index.html'; }
  $('#owner-chip').textContent = `owner: ${ownerUid.slice(0,8)}â€¦`;
  const shareUrl = `${location.origin}${location.pathname}?uid=${encodeURIComponent(ownerUid)}`;
  $('#btn-copy').onclick = async ()=>{ await navigator.clipboard.writeText(shareUrl); alert('ê³µìœ  ë§í¬ ë³µì‚¬ë¨'); };

  // ===== Session =====
  let me=null, isAdmin=false, canWrite=false;

  $('#btn-login').onclick = ()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message));
  $('#btn-logout').onclick= ()=>auth.signOut();
  $('#btn-refresh').onclick= ()=>loadProjects();

  async function computePermission(){
    if(!me){ canWrite=false; $('#form-new').style.display='none'; return; }
    const isOwner = me.uid===ownerUid;
    let isFriend = false;
    if(!isOwner && !isAdmin){
      try{
        const q = await db.collection('friends')
          .where('ownerUid','==',ownerUid)
          .where('friendUid','==',me.uid)
          .limit(1).get();
        isFriend = !q.empty;
      }catch(e){ console.warn('friend check error', e); }
    }
    canWrite = isOwner || isFriend || isAdmin;
    $('#write-hint').textContent = canWrite ? 'ì‘ì„± ê°€ëŠ¥ ì‚¬ìš©ìì…ë‹ˆë‹¤.' : 'ì‘ì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
    $('#form-new').style.display = canWrite ? '' : 'none';
  }

  auth.onAuthStateChanged(async u=>{
    me=u;
    if(u){
      $('#user-line').textContent = `${u.displayName||'ìµëª…'} (${u.email||''})`;
      $('#btn-login').style.display='none'; $('#btn-logout').style.display='';
      try{ isAdmin=(await db.collection('roles').doc(u.uid).get()).exists; }catch{ isAdmin=false; }
    }else{
      $('#user-line').textContent='ë¡œê·¸ì¸ í•„ìš”';
      $('#btn-login').style.display=''; $('#btn-logout').style.display='none';
      isAdmin=false;
    }
    await computePermission();
    await loadProjects();
  });

  // ===== Projects =====
  async function loadProjects(){
    const box = $('#list'); box.innerHTML='<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      const snap = await db.collection('projects')
        .where('ownerUid','==',ownerUid)
        .orderBy('createdAt','desc').limit(100).get();
      box.innerHTML='';
      if(snap.empty){ box.innerHTML='<div class="muted">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      snap.forEach(doc=>renderProject(doc.id, doc.data()));
    }catch(e){
      const hint = e.message && e.message.includes('The query requires an index')
        ? '<br/><span class="muted">âš ï¸ ì¸ë±ìŠ¤ í•„ìš”: ì½˜ì†” ë§í¬ë¡œ ìƒì„± í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</span>'
        : '';
      box.innerHTML=`<div class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(e.message)}${hint}</div>`;
    }
  }

  function renderProject(id, d){
    const mine = me && (me.uid===d.authorUid);
    const allowManage = me && (mine || isAdmin);

    const el = document.createElement('article');
    el.className='project';
    el.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div style="flex:1">
          <div id="pv-${id}">
            <h3 style="margin:0">${esc(d.title)}</h3>
            <div class="muted" style="margin:2px 0 8px">${esc(d.authorName||'ìµëª…')} Â· ${fmt(d.createdAt)}</div>
            <p style="margin:0">${esc(d.desc)}</p>
            ${(d.tags&&d.tags.length)?`<div class="row" style="gap:6px;margin-top:6px">${d.tags.map(t=>`<span class="chip">#${esc(t)}</span>`).join('')}</div>`:''}
            ${d.mainFile?.url?`<div style="margin-top:6px"><a class="chip" href="${d.mainFile.url}" target="_blank" rel="noopener">ì²¨ë¶€ ë³´ê¸°</a></div>`:''}
          </div>

          <form id="pe-${id}" class="list" style="display:none; margin-top:6px">
            <input id="e-title-${id}" value="${esc(d.title)}" required/>
            <textarea id="e-desc-${id}" required>${esc(d.desc)}</textarea>
            <div class="row" style="gap:6px">
              <button type="button" class="secondary" id="save-${id}">ì €ì¥</button>
              <button type="button" class="ghost" id="cancel-${id}">ì·¨ì†Œ</button>
            </div>
          </form>
        </div>
        <div class="row" style="gap:6px">
          ${allowManage?`
            <button class="secondary" id="edit-${id}">ìˆ˜ì •</button>
            <button class="danger" id="del-${id}">ì‚­ì œ</button>
          `:''}
        </div>
      </div>

      <div class="row" style="gap:16px; margin-top:14px; align-items:flex-start; flex-wrap:wrap">
        <!-- ëŒ“ê¸€ -->
        <div style="flex:1; min-width:280px">
          <h4 style="margin:0 0 6px">ğŸ’¬ ëŒ“ê¸€</h4>
          <div id="clist-${id}" class="list"></div>
          <form id="cform-${id}" class="list" style="margin-top:8px; ${canWrite?'':'display:none'}">
            <textarea id="cnew-${id}" placeholder="ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”" required></textarea>
            <div class="row"><button type="submit" class="secondary">ëŒ“ê¸€ ë“±ë¡</button></div>
          </form>
        </div>

        <!-- íŒŒì¼ -->
        <div style="flex:1; min-width:280px">
          <h4 style="margin:0 0 6px">ğŸ“ íŒŒì¼</h4>
          <div id="flist-${id}" class="list"></div>
          <form id="fform-${id}" class="row" style="gap:8px; margin-top:8px; ${canWrite?'':'display:none'}">
            <input type="file" id="fup-${id}" />
            <button type="submit">ì—…ë¡œë“œ</button>
          </form>
        </div>
      </div>
    `;
    $('#list').appendChild(el);

    // === ê²Œì‹œê¸€ í¸ì§‘/ì‚­ì œ ===
    if(allowManage){
      const pv = el.querySelector(`#pv-${id}`);
      const pe = el.querySelector(`#pe-${id}`);
      const btnE = el.querySelector(`#edit-${id}`);
      const btnD = el.querySelector(`#del-${id}`);
      const btnS = el.querySelector(`#save-${id}`);
      const btnC = el.querySelector(`#cancel-${id}`);

      const enter = ()=>{ pv.style.display='none'; pe.style.display=''; };
      const exit  = ()=>{ pe.style.display='none'; pv.style.display=''; };

      btnE.onclick = enter;
      btnC.onclick = exit;
      btnS.onclick = async ()=>{
        const nt = el.querySelector(`#e-title-${id}`).value.trim();
        const nd = el.querySelector(`#e-desc-${id}`).value.trim();
        if(!nt||!nd) return alert('ì œëª©/ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
        try{
          await db.collection('projects').doc(id).update({
            title: nt, desc: nd, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          await loadProjects();
        }catch(e){ alert('ìˆ˜ì • ì‹¤íŒ¨: '+e.message); }
      };
      btnD.onclick = async ()=>{
        if(!confirm('í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”? (ëŒ“ê¸€/íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) return;
        try{
          const pref = db.collection('projects').doc(id);
          // ëŒ“ê¸€ ì‚­ì œ
          let cs = await pref.collection('comments').limit(500).get();
          while(!cs.empty){ const b=db.batch(); cs.docs.forEach(d=>b.delete(d.ref)); await b.commit(); cs=await pref.collection('comments').limit(500).get(); }
          // íŒŒì¼ ì‚­ì œ(ìŠ¤í† ë¦¬ì§€ ì‹œë„)
          let fs = await pref.collection('files').limit(500).get();
          for(const fdoc of fs.docs){
            const f = fdoc.data();
            if(f.storagePath){ try{ await storage.ref().child(f.storagePath).delete(); }catch(err){ console.warn('storage delete fail', err); } }
            await fdoc.ref.delete();
          }
          await pref.delete();
          await loadProjects();
        }catch(e){ alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
      };
    }

    // === ëŒ“ê¸€ ì„¹ì…˜ ===
    loadComments(id);
    const cform = el.querySelector(`#cform-${id}`);
    if(cform){
      cform.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if(!me) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        const ta = el.querySelector(`#cnew-${id}`);
        const text = (ta.value||'').trim();
        if(!text) return;
        try{
          await db.collection('projects').doc(id).collection('comments').add({
            text,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            authorUid: me.uid,
            authorName: me.displayName || 'ìµëª…'
          });
          ta.value='';
          loadComments(id);
        }catch(er){ alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: '+er.message); }
      });
    }

    // === íŒŒì¼ ì„¹ì…˜ ===
    loadFiles(id);
    const fform = el.querySelector(`#fform-${id}`);
    if(fform){
      fform.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if(!me || !canWrite) return alert('ê¶Œí•œ ì—†ìŒ');
        const inp = el.querySelector(`#fup-${id}`);
        const file = inp.files && inp.files[0];
        if(!file) return alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
        if(file.size>10*1024*1024) return alert('íŒŒì¼ì€ ìµœëŒ€ 10MB');
        try{
          const path=`uploads/${id}/${Date.now()}_${file.name}`;
          const ref=storage.ref().child(path);
          const snap=await ref.put(file,{customMetadata:{ownerUid:me.uid}});
          const url=await snap.ref.getDownloadURL();
          await db.collection('projects').doc(id).collection('files').add({
            name:file.name,size:file.size,contentType:file.type,url,storagePath:path,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            ownerUid: me.uid, ownerName: me.displayName || 'ìµëª…'
          });
          inp.value='';
          loadFiles(id);
        }catch(err){ alert('ì—…ë¡œë“œ ì‹¤íŒ¨: '+err.message); }
      });
    }
  }

  // ===== Comments (inline edit like posts) =====
  async function loadComments(pid){
    const box = document.getElementById(`clist-${pid}`);
    if(!box) return;
    box.innerHTML = '<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      const snap = await db.collection('projects').doc(pid).collection('comments')
        .orderBy('createdAt','desc').limit(100).get();
      box.innerHTML = '';
      if(snap.empty){ box.innerHTML = '<div class="muted">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

      snap.forEach(doc=>{
        const c = doc.data();
        const cid = doc.id;
        const can = me && (me.uid===c.authorUid || isAdmin);

        const item = document.createElement('div');
        item.className = 'comment';
        item.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div style="flex:1">
              <div class="muted" style="font-size:12px">${esc(c.authorName||'ìµëª…')} Â· ${fmt(c.createdAt)}${c.updatedAt?' (ìˆ˜ì •ë¨)':''}</div>
              <div id="cv-${pid}-${cid}" style="white-space:pre-wrap">${esc(c.text)}</div>
              <form id="ce-${pid}-${cid}" class="list" style="display:none; margin-top:6px">
                <textarea id="ct-${pid}-${cid}" required>${esc(c.text)}</textarea>
                <div class="row" style="gap:6px">
                  <button type="button" class="secondary" id="cs-${pid}-${cid}">ì €ì¥</button>
                  <button type="button" class="ghost" id="cc-${pid}-${cid}">ì·¨ì†Œ</button>
                </div>
              </form>
            </div>
            <div class="row" style="gap:6px">
              ${can?`<button class="ghost" id="cebtn-${pid}-${cid}">ìˆ˜ì •</button><button class="danger" id="cdbtn-${pid}-${cid}">ì‚­ì œ</button>`:''}
            </div>
          </div>
        `;
        box.appendChild(item);

        if(can){
          const v = item.querySelector(`#cv-${pid}-${cid}`);
          const f = item.querySelector(`#ce-${pid}-${cid}`);
          const bE = item.querySelector(`#cebtn-${pid}-${cid}`);
          const bD = item.querySelector(`#cdbtn-${pid}-${cid}`);
          const bS = item.querySelector(`#cs-${pid}-${cid}`);
          const bC = item.querySelector(`#cc-${pid}-${cid}`);

          const enter = ()=>{ v.style.display='none'; f.style.display=''; };
          const exit  = ()=>{ f.style.display='none'; v.style.display=''; };

          bE.onclick = enter;
          bC.onclick = exit;
          bS.onclick = async ()=>{
            const nt = (item.querySelector(`#ct-${pid}-${cid}`).value||'').trim();
            if(!nt) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
            try{
              await db.collection('projects').doc(pid).collection('comments').doc(cid).update({
                text: nt,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              loadComments(pid);
            }catch(e){ alert('ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨: '+e.message); }
          };
          bD.onclick = async ()=>{
            if(!confirm('ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
            try{
              await db.collection('projects').doc(pid).collection('comments').doc(cid).delete();
              loadComments(pid);
            }catch(e){ alert('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
          };
        }
      });
    }catch(e){
      const msg = (e && e.code === 'permission-denied')
        ? 'ëŒ“ê¸€ì„ ë³¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•˜ê±°ë‚˜ í˜ì´ì§€ ì†Œìœ ìì—ê²Œ ê¶Œí•œì„ ìš”ì²­í•˜ì„¸ìš”.'
        : `ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨: ${e.message||e}`;
      box.innerHTML = `<div class="muted">${esc(msg)}</div>`;
    }
  }

  // ===== Files (list Â· rename Â· replace Â· delete) =====
  async function loadFiles(pid){
    const box = document.getElementById(`flist-${pid}`);
    if(!box) return;
    box.innerHTML = '<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      const snap = await db.collection('projects').doc(pid).collection('files')
        .orderBy('createdAt','desc').limit(100).get();
      box.innerHTML = '';
      if(snap.empty){ box.innerHTML = '<div class="muted">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

      snap.forEach(doc=>{
        const f = doc.data();
        const fid = doc.id;
        const can = me && (me.uid===f.ownerUid || isAdmin);
        const isImg = (f.contentType||'').startsWith('image/');

        const row = document.createElement('div');
        row.className = 'file-row';
        row.innerHTML = `
          <div class="row" style="gap:10px; align-items:center; flex:1">
            ${isImg?`<img class="thumb" src="${esc(f.url)}" alt="${esc(f.name||'image')}">`:''}
            <div style="min-width:0">
              <div class="muted" style="word-break:break-all">${esc(f.name||'íŒŒì¼')} (${f.size||0}B)</div>
              <a href="${esc(f.url)}" target="_blank" rel="noopener">${isImg?'ì›ë³¸ ì—´ê¸°':'ë‹¤ìš´ë¡œë“œ'}</a>
              ${f.updatedAt?`<span class="chip" style="margin-left:6px">ìˆ˜ì •ë¨</span>`:''}
            </div>
          </div>
          <div class="row" style="gap:6px">
            ${can?`
              <button class="ghost" id="frn-${pid}-${fid}">ì´ë¦„ìˆ˜ì •</button>
              <button class="ghost" id="fre-${pid}-${fid}">íŒŒì¼êµì²´</button>
              <button class="danger" id="fdl-${pid}-${fid}">ì‚­ì œ</button>
            `:''}
          </div>

          <!-- ì´ë¦„ìˆ˜ì • í¼ -->
          <form id="fedit-${pid}-${fid}" class="row" style="gap:6px; display:none; margin-top:8px; flex:1 0 100%">
            <input id="fname-${pid}-${fid}" value="${esc(f.name||'')}" placeholder="í‘œì‹œ ì´ë¦„"/>
            <button type="button" class="secondary" id="fsave-${pid}-${fid}">ì €ì¥</button>
            <button type="button" class="ghost" id="fcancel-${pid}-${fid}">ì·¨ì†Œ</button>
          </form>

          <!-- íŒŒì¼êµì²´ ì…ë ¥ -->
          <input type="file" id="fpick-${pid}-${fid}" style="display:none"/>
        `;
        box.appendChild(row);

        if(can){
          // ì´ë¦„ìˆ˜ì • í† ê¸€
          const btnRename = row.querySelector(`#frn-${pid}-${fid}`);
          const btnReplace= row.querySelector(`#fre-${pid}-${fid}`);
          const btnDelete = row.querySelector(`#fdl-${pid}-${fid}`);
          const editForm  = row.querySelector(`#fedit-${pid}-${fid}`);
          const nameInp   = row.querySelector(`#fname-${pid}-${fid}`);
          const btnSave   = row.querySelector(`#fsave-${pid}-${fid}`);
          const btnCancel = row.querySelector(`#fcancel-${pid}-${fid}`);
          const pick      = row.querySelector(`#fpick-${pid}-${fid}`);

          const showEdit = ()=>{ editForm.style.display=''; };
          const hideEdit = ()=>{ editForm.style.display='none'; };

          btnRename.onclick = showEdit;
          btnCancel.onclick = hideEdit;

          btnSave.onclick = async ()=>{
            const newName = (nameInp.value||'').trim();
            try{
              await db.collection('projects').doc(pid).collection('files').doc(fid).update({
                name: newName || f.name || null,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              loadFiles(pid);
            }catch(e){ alert('íŒŒì¼ ì´ë¦„ ìˆ˜ì • ì‹¤íŒ¨: '+e.message); }
          };

          btnReplace.onclick = ()=> pick.click();
          pick.onchange = async ()=>{
            const nf = pick.files && pick.files[0];
            if(!nf) return;
            if(nf.size>10*1024*1024) return alert('10MB ì´í•˜ë§Œ ì—…ë¡œë“œ');
            try{
              const newPath = `uploads/${pid}/${Date.now()}_${nf.name}`;
              const ref = storage.ref().child(newPath);
              await ref.put(nf,{customMetadata:{ownerUid: f.ownerUid || (me&&me.uid)||''}});
              const url = await ref.getDownloadURL();
              await db.collection('projects').doc(pid).collection('files').doc(fid).update({
                name:nf.name,size:nf.size,contentType:nf.type,url,storagePath:newPath,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              if(f.storagePath){ try{ await storage.ref().child(f.storagePath).delete(); }catch(err){ console.warn('old delete fail',err); } }
              loadFiles(pid);
            }catch(e){ alert('íŒŒì¼ êµì²´ ì‹¤íŒ¨: '+e.message); }
            finally{ pick.value=''; }
          };

          btnDelete.onclick = async ()=>{
            if(!confirm('ì´ íŒŒì¼ì„ ì‚­ì œí• ê¹Œìš”?')) return;
            try{
              if(f.storagePath){ try{ await storage.ref().child(f.storagePath).delete(); }catch(err){ console.warn('storage delete fail',err); } }
              await db.collection('projects').doc(pid).collection('files').doc(fid).delete();
              loadFiles(pid);
            }catch(e){ alert('íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
          };
        }
      });
    }catch(e){
      const msg = (e && e.code === 'permission-denied')
        ? 'íŒŒì¼ì„ ë³¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'
        : `íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${e.message||e}`;
      box.innerHTML = `<div class="muted">${esc(msg)}</div>`;
    }
  }

  // ===== New project submit =====
  document.getElementById('form-new').addEventListener('submit', async e=>{
    e.preventDefault(); if(!me || !canWrite) return alert('ê¶Œí•œ ì—†ìŒ');
    const title=$('#p-title').value.trim(), desc=$('#p-desc').value.trim();
    const tags=parseTags($('#p-tags').value); const mf=$('#p-mainfile').files[0];
    if(!title || !desc) return alert('ì œëª©/ì„¤ëª…ì€ í•„ìˆ˜');
    try{
      const ref = await db.collection('projects').add({
        ownerUid, title, desc, tags,
        authorUid: me.uid, authorName: me.displayName||'ìµëª…', authorEmail: me.email||null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        mainFile: null
      });
      if(mf){
        if(mf.size>10*1024*1024) throw new Error('íŒŒì¼ì€ ìµœëŒ€ 10MB');
        const path=`uploads/${ref.id}/main_${Date.now()}_${mf.name}`;
        const snap=await storage.ref().child(path).put(mf,{customMetadata:{ownerUid:me.uid}});
        const url=await snap.ref.getDownloadURL();
        await ref.update({
          mainFile:{name:mf.name,size:mf.size,contentType:mf.type,url,storagePath:path,uploadedAt:firebase.firestore.FieldValue.serverTimestamp(),ownerUid:me.uid}
        });
      }
      e.target.reset(); loadProjects();
    }catch(err){ alert('ë“±ë¡ ì‹¤íŒ¨: '+err.message); }
  });
</script>
</body>
</html>
