<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="https://kimys01.github.io/propot/">
<title>ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  /* === ì¼ê´€ëœ ìŠ¤íƒ€ì¼ í…Œë§ˆ ì ìš© === */
  :root {
    --primary-color: #6a5acd;
    --button-hover-color: #5a4ab9;
    --background-color: #f0f2f5;
    --container-bg-color: #ffffff;
    --text-color: #333;
    --text-muted-color: #666;
    --border-color: #e0e0e0;
    --danger-bg-color: #fee2e2;
    --danger-text-color: #b91c1c;
    --danger-border-color: #fecaca;
  }

  /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” ë° ì„¤ì • === */
  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:var(--background-color);
    color:var(--text-color);
    font:16px/1.5 'Noto Sans KR', system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Malgun Gothic,sans-serif;
  }
  a{color:var(--primary-color); text-decoration:none}
  a:hover{text-decoration:underline}

  /* === í—¤ë” ìŠ¤íƒ€ì¼ === */
  .hdr{
    position:sticky;
    top:0;
    background:var(--container-bg-color);
    border-bottom:1px solid var(--border-color);
    backdrop-filter:blur(8px);
    z-index:10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .hdr strong {
    color: var(--primary-color);
  }

  /* === ë ˆì´ì•„ì›ƒ í—¬í¼ í´ë˜ìŠ¤ === */
  .wrap{max-width:1024px;margin:0 auto;padding:14px 18px}
  .row{display:flex;gap:10px;align-items:center}
  .row.space{justify-content:space-between}
  .row.gap8{gap:8px}
  .row.wrap{flex-wrap:wrap}
  .pad16{padding:16px 18px}
  .mt10{margin-top:10px}.mt14{margin-top:14px}.mt8{margin-top:8px}.mt2{margin-top:2px}
  
  /* === ì¹´ë“œ ë° ì½˜í…ì¸  ìŠ¤íƒ€ì¼ === */
  .card{
    background:var(--container-bg-color);
    border: none;
    border-radius:12px;
    padding:24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
  }
  .list{display:grid;gap:12px}
  .project{
    background: var(--container-bg-color);
    border:1px solid var(--border-color);
    border-radius:12px;
    padding:16px;
  }
  .chip{
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    background-color: #ebebeb;
    color: var(--text-muted-color);
  }
  .muted{color:var(--text-muted-color)}
  .ttl{
    margin:0 0 12px;
    color: var(--primary-color);
    font-weight: 700;
    font-size: 22px;
  }

  /* === ë²„íŠ¼, ì…ë ¥ì°½ ë“± í¼ ìš”ì†Œ ìŠ¤íƒ€ì¼ === */
  button,input,textarea,a.secondary,a.ghost{font:inherit}
  textarea{min-height:80px;resize:vertical}

  button, a.secondary, a.ghost {
    padding:9px 14px;
    border:none;
    border-radius:8px;
    font-size: 14px;
    font-weight:500;
    cursor:pointer;
    transition: all 0.2s;
    display: inline-flex;
    justify-content: center;
    align-items: center;
  }

  button{ /* ê¸°ë³¸ ë²„íŠ¼ (Primary) */
    background-color:var(--primary-color);
    color:white;
  }
  button:hover {
    background-color: var(--button-hover-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  button.secondary, a.secondary{ /* ë³´ì¡° ë²„íŠ¼ (Secondary) */
    background-color:#f0f0f0;
    color:var(--text-color);
    border:1px solid var(--border-color);
  }
  button.secondary:hover, a.secondary:hover {
    background-color: #e5e5e5;
  }
  
  button.ghost, a.ghost{ /* ê³ ìŠ¤íŠ¸ ë²„íŠ¼ */
    background:transparent;
    color: var(--text-muted-color);
    border:1px solid var(--border-color);
  }
  button.ghost:hover, a.ghost:hover {
    background: rgba(106, 90, 205, 0.05);
    color: var(--primary-color);
    border-color: var(--primary-color);
  }

  button.danger {
    background-color: var(--danger-bg-color);
    color: var(--danger-text-color);
    border: 1px solid var(--danger-border-color);
  }
  button.danger:hover {
    background-color: #fecaca;
  }
  
  .mini{padding:6px 10px;border-radius:8px;font-size:12px}
  
  .inp{
    width:100%;
    background:#ffffff;
    color:var(--text-color);
    border:1px solid var(--border-color);
    border-radius:8px;
    padding:12px 14px;
    transition: all 0.2s;
  }
  .inp:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.2);
  }

  /* === ê¸°íƒ€ ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ === */
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:860px){.grid.cols-2{grid-template-columns:1fr}}

  .right-wrap{position:relative;min-width:220px}
  .manage{position:absolute;top:-6px;right:-6px;display:flex;gap:6px;z-index:1}
  .badges.has-actions{padding-right:170px}
  @media (max-width:560px){.right-wrap{position:static}.manage{position:static;margin-top:10px}.badges.has-actions{padding-right:0}}
  
  .file-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    background:#f9f9f9;
    border:1px solid var(--border-color);
    border-radius:12px;
    padding:8px 10px;
  }
  .flex{display:flex;gap:8px;align-items:center}
  .thumb{
    width:120px;
    height:80px;
    border-radius:8px;
    object-fit:cover;
    border:1px solid var(--border-color);
  }
  .select-cb{display:none}.selecting .select-cb{display:inline-block}
  .small{font-size:12px}
</style>
</head>
<body>
<header class="hdr">
  <div class="wrap row">
    <div class="row"><strong>ğŸ“„ í¬íŠ¸í´ë¦¬ì˜¤</strong><span id="owner-chip" class="chip"></span></div>
    <div class="row ml-auto gap8">
      <span id="user-line" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
      <button id="btn-login" class="secondary">ë¡œê·¸ì¸</button>
      <button id="btn-logout" class="secondary" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      <a id="btn-home" class="secondary" href="index.html">ë©”ì¸</a>
      <button id="btn-copy" class="secondary">ê³µìœ  ë§í¬ ë³µì‚¬</button>
    </div>
  </div>
</header>

<main class="wrap pad16">
  <section id="write-section" class="card" style="display:none;">
    <h2 class="ttl">í”„ë¡œì íŠ¸ ì‘ì„±</h2>
    <p id="write-hint" class="muted"></p>
    <form id="form-new" class="list">
      <input id="p-title" class="inp" placeholder="í”„ë¡œì íŠ¸ ì œëª©" required/>
      <textarea id="p-desc" class="inp" placeholder="í”„ë¡œì íŠ¸ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…" required></textarea>
      <div class="grid cols-2">
        <input id="p-tags" class="inp" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„) ì˜ˆ: ì›¹ê°œë°œ, React"/>
        <input id="p-mainfile" class="inp" type="file"/>
      </div>
      <div class="row"><button type="submit">ë“±ë¡í•˜ê¸°</button></div>
    </form>
  </section>

  <section class="card mt14">
    <div class="row space wrap">
      <h2 class="ttl">í”„ë¡œì íŠ¸ ëª©ë¡</h2>
      <div class="row gap8">
        <input id="search-input" class="inp" placeholder="ê²€ìƒ‰: í‚¤ì›Œë“œ ë˜ëŠ” #íƒœê·¸" style="min-width:220px">
        <button id="btn-refresh" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div id="list" class="list mt10"></div>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
  const cfg={apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",authDomain:"propot-cc6bf.firebaseapp.com",projectId:"propot-cc6bf",storageBucket:"propot-cc6bf.firebasestorage.app",appId:"1:30940698980:web:1729f30e68d3beb24ac271"};
  firebase.initializeApp(cfg);
  const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

  const $=s=>document.querySelector(s);
  const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const parseTags=v=>String(v||'').split(/[, \t]+/).map(x=>x.trim().replace(/^#/,'').toLowerCase()).filter(Boolean).slice(0,10);
  const fmt=ts=>{ if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString(); };

  const params=new URLSearchParams(location.search); const ownerUid=params.get('uid');
  if(!ownerUid){ alert('ì˜ëª»ëœ ì ‘ê·¼: ì‚¬ìš©ì UIDê°€ ì—†ìŠµë‹ˆë‹¤.'); location.href='index.html'; }
  $('#owner-chip').textContent=`ì†Œìœ ì: ${ownerUid.slice(0,8)}â€¦`;
  const shareUrl=`${location.origin}${location.pathname.replace('u.html', '')}u.html?uid=${encodeURIComponent(ownerUid)}`;
  $('#btn-copy').onclick=async()=>{ try { await navigator.clipboard.writeText(shareUrl); alert('ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); } catch(e) { alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); } };

  let me=null,isAdmin=false,canWrite=false;
  let loadedProjects=[];
  const selComments=new Map(); const selFiles=new Map();

  $('#btn-login').onclick=()=>location.href=`login.html?redirect=${encodeURIComponent(location.href)}`;
  $('#btn-logout').onclick=()=>auth.signOut();
  $('#btn-refresh').onclick=()=>loadProjects();

  auth.onAuthStateChanged(async u=>{
    me=u;
    if(u){
      $('#user-line').textContent=`${u.displayName||'ìµëª…'}`;
      $('#btn-login').style.display='none'; $('#btn-logout').style.display='';
      try{ isAdmin=(await db.collection('roles').doc(u.uid).get()).exists; }catch{ isAdmin=false; }
    }else{
      $('#user-line').textContent='ë¡œê·¸ì¸ í•„ìš”';
      $('#btn-login').style.display=''; $('#btn-logout').style.display='none';
    }
    await computePermission();
    await loadProjects();
  });

  async function computePermission(){
    if(!me){ canWrite=false; return; }
    const isOwner=me.uid===ownerUid; let isFriend=false;
    if(!isOwner && !isAdmin){
      try{
        const friendDocId = `${ownerUid}_${me.uid}`;
        const friendDoc = await db.collection('friends').doc(friendDocId).get();
        isFriend=friendDoc.exists;
      }catch(e){ console.warn('ì¹œêµ¬ ê´€ê³„ í™•ì¸ ì¤‘ ì˜¤ë¥˜:',e); }
    }
    canWrite=isOwner||isFriend||isAdmin;
    $('#write-hint').textContent=canWrite?'í”„ë¡œì íŠ¸ë¥¼ ë“±ë¡í•˜ì—¬ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì±„ì›Œë³´ì„¸ìš”.':'ì´ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ì†Œìœ ì, ë˜ëŠ” ê³µìœ ë°›ì€ ì¹œêµ¬ë§Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    $('#write-section').style.display=canWrite?'block':'none';
  }

  const searchInput=document.getElementById('search-input'); if(searchInput) searchInput.addEventListener('input', applyFilter);
  function applyFilter(){
    if(!searchInput){ renderProjects(loadedProjects); return; }
    const q=(searchInput.value||'').trim(); if(!q){ renderProjects(loadedProjects); return; }
    const tokens=q.split(/\s+/); const tagFilt=tokens.filter(t=>t.startsWith('#')).map(t=>t.slice(1).toLowerCase());
    const kw=tokens.filter(t=>!t.startsWith('#')).map(t=>t.toLowerCase());
    const filtered=loadedProjects.filter(({data})=>{
      const hay=(data.title+' '+data.desc+' '+(data.authorName||'')+' '+(data.tags||[]).join(' ')).toLowerCase();
      const tags=(data.tags||[]).map(t=>String(t).toLowerCase());
      const okTags=tagFilt.length===0||tagFilt.every(t=>tags.includes(t));
      const okKw=kw.length===0||kw.every(k=>hay.includes(k));
      return okTags&&okKw;
    });
    renderProjects(filtered);
  }

  async function loadProjects(){
    const box=$('#list'); box.innerHTML='<div class="muted" style="text-align:center; padding: 20px 0;">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      let snap; try{
        snap=await db.collection('projects').where('ownerUid','==',ownerUid).orderBy('createdAt','desc').limit(100).get();
      }catch(e){
        console.warn('ì¸ë±ìŠ¤ ìƒì„± í•„ìš”. í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬í•©ë‹ˆë‹¤:',e.message);
        snap=await db.collection('projects').where('ownerUid','==',ownerUid).limit(100).get();
      }
      loadedProjects=[]; snap.forEach(doc=>loadedProjects.push({id:doc.id,data:doc.data()}));
      loadedProjects.sort((a,b)=>((b.data.createdAt?.toMillis?.()||0)-(a.data.createdAt?.toMillis?.()||0)));
      applyFilter();
    }catch(e){ $('#list').innerHTML=`<div class="muted">í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${esc(e.message)}</div>`; }
  }

  function renderProjects(list){
    const listEl=$('#list'); listEl.innerHTML='';
    if(!list||!list.length){ listEl.innerHTML='<div class="muted" style="text-align:center; padding: 20px 0;">ì•„ì§ ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    list.forEach(({id,data})=>renderProjectCard(id,data,listEl));
  }

  function renderProjectCard(id,d,listEl){
    const mine=me&&(me.uid===d.authorUid); const allowManage=me&&(mine||isAdmin);
    const card=document.createElement('article'); card.className='project';
    card.innerHTML=`
      <div class="row space wrap">
        <div>
          <h3 style="margin:0">${esc(d.title)}</h3>
          <div class="muted mt2 small">${esc(d.authorName||'ìµëª…')} Â· ${fmt(d.createdAt)}</div>
        </div>
        <div class="right-wrap">
          <div class="badges ${allowManage?'has-actions':''}">
            ${d.mainFile?.url?`<a class="chip" href="${d.mainFile.url}" target="_blank" rel="noopener">ëŒ€í‘œ ì²¨ë¶€íŒŒì¼ ë³´ê¸°</a>`:''}
          </div>
          ${allowManage?`
          <div class="manage">
            <button class="ghost mini" id="btn-edit-${id}">ìˆ˜ì •</button>
            <button class="danger mini" id="btn-del-${id}">ì‚­ì œ</button>
            <button class="secondary mini" id="btn-save-${id}" style="display:none;">ì €ì¥</button>
            <button class="ghost mini" id="btn-cancel-${id}" style="display:none;">ì·¨ì†Œ</button>
          </div>`:''}
        </div>
      </div>
      <p style="margin:8px 0 0; white-space: pre-wrap;">${esc(d.desc)}</p>
      ${(d.tags&&d.tags.length)?`<div class="row wrap" style="gap:6px;margin-top:8px">${d.tags.map(t=>`<span class="chip">#${esc(t)}</span>`).join('')}</div>`:''}

      <form id="edit-${id}-form" class="list" style="display:none; margin-top: 10px;">
        <input id="e-title-${id}" class="inp" type="text" value="${esc(d.title)}" required/>
        <textarea id="e-desc-${id}" class="inp" required>${esc(d.desc)}</textarea>
        <div class="grid" style="gap:6px">
          <div class="muted small">ëŒ€í‘œ ì²¨ë¶€: ${d.mainFile?.name?esc(d.mainFile.name):'ì—†ìŒ'}</div>
          <div class="row wrap gap8">
            <input type="file" id="e-mainfile-${id}" class="inp"/>
            ${d.mainFile?.url?`<a class="chip" href="${d.mainFile.url}" target="_blank" rel="noopener">í˜„ì¬ íŒŒì¼ ì—´ê¸°</a>`:''}
            ${d.mainFile?`<button type="button" class="danger mini" id="e-mainfile-del-${id}">ì²¨ë¶€ ì‚­ì œ</button>`:''}
          </div>
        </div>
      </form>

      <div class="grid cols-2 mt8">
        <div>
          <h4 style="margin:12px 0 8px">ğŸ’¬ ëŒ“ê¸€</h4>
          <div class="list" id="comments-${id}"></div>
          <form class="list" id="form-comment-${id}" style="margin-top:10px;">
            <textarea id="c-${id}" class="inp" placeholder="ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš” (ë¡œê·¸ì¸ í•„ìš”)" required></textarea>
            <div class="row"><button type="submit" class="secondary">ëŒ“ê¸€ ë“±ë¡</button></div>
          </form>
        </div>
        <div>
          <h4 style="margin:12px 0 8px">ğŸ“ ê´€ë ¨ íŒŒì¼</h4>
          <div class="list" id="files-${id}"></div>
          <form class="row wrap" id="form-file-${id}" style="margin-top:10px;">
            <input type="file" id="f-${id}" class="inp"/>
            <button type="submit">ì—…ë¡œë“œ</button>
          </form>
        </div>
      </div>
    `;
    listEl.appendChild(card);

    if(allowManage){
      const btnEdit=$(`#btn-edit-${id}`),btnDel=$(`#btn-del-${id}`),btnSave=$(`#btn-save-${id}`),btnCancel=$(`#btn-cancel-${id}`);
      const editForm=$(`#edit-${id}-form`), viewSection=card.querySelectorAll('p, .badges, .row.wrap');
      
      const toggleEditMode=(isEditing)=>{
        editForm.style.display=isEditing?'block':'none';
        viewSection.forEach(el=>el.style.display=isEditing?'none':'');
        btnEdit.style.display=isEditing?'none':'';
        btnDel.style.display=isEditing?'none':'';
        btnSave.style.display=isEditing?'':'none';
        btnCancel.style.display=isEditing?'':'none';
      };

      btnEdit.addEventListener('click',()=>toggleEditMode(true));
      btnCancel.addEventListener('click',()=>toggleEditMode(false));
      btnSave.addEventListener('click',async()=>{
          const title=$(`#e-title-${id}`).value.trim();
          const desc=$(`#e-desc-${id}`).value.trim();
          const newFile = $(`#e-mainfile-${id}`).files[0];

          if(!title||!desc) return alert('ì œëª©ê³¼ ì„¤ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
          
          try {
            const updateData = { title, desc, updatedAt:firebase.firestore.FieldValue.serverTimestamp() };
            if (newFile) {
                if(newFile.size > 10 * 1024 * 1024) throw new Error('íŒŒì¼ì€ ìµœëŒ€ 10MBì…ë‹ˆë‹¤.');
                const path = `uploads/${id}/main_${Date.now()}_${newFile.name}`;
                const ref = storage.ref().child(path);
                const snap = await ref.put(newFile, { customMetadata: { ownerUid: me.uid } });
                const url = await snap.ref.getDownloadURL();
                updateData.mainFile = { name: newFile.name, size: newFile.size, contentType: newFile.type, url, storagePath: path, uploadedAt: firebase.firestore.FieldValue.serverTimestamp(), ownerUid: me.uid };
                if (d.mainFile?.storagePath) { try { await storage.ref().child(d.mainFile.storagePath).delete(); } catch(e){} }
            }
            await db.collection('projects').doc(id).update(updateData);
            loadProjects();
          } catch(e) { alert('ìˆ˜ì • ì‹¤íŒ¨: '+e.message); }
      });
      btnDel.addEventListener('click',async()=>{
        if(!confirm('í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ë©´ ëª¨ë“  ëŒ“ê¸€ê³¼ íŒŒì¼ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try{
          const ref=db.collection('projects').doc(id);
          // subcollection deletion logic here...
          await ref.delete(); loadProjects();
        }catch(e){ alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
      });

      const mainFileDelBtn = $(`#e-mainfile-del-${id}`);
      if(mainFileDelBtn) mainFileDelBtn.addEventListener('click', async () => {
        if(!confirm('ëŒ€í‘œ ì²¨ë¶€íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            if (d.mainFile?.storagePath) { try { await storage.ref().child(d.mainFile.storagePath).delete(); } catch(e){} }
            await db.collection('projects').doc(id).update({ mainFile: null, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            loadProjects();
        } catch (e) { alert('ì²¨ë¶€íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
      });
    }

    // Comment and File logic would be here...
    loadComments(id);
    loadFiles(id);
    $(`#form-comment-${id}`).addEventListener('submit',ev=>addComment(ev,id));
    $(`#form-file-${id}`).addEventListener('submit',ev=>uploadFile(ev,id));
  }

  async function loadComments(pid){
    const box=$('#comments-'+pid); box.innerHTML='';
    try {
        const snap = await db.collection('projects').doc(pid).collection('comments').orderBy('createdAt', 'desc').get();
        if(snap.empty){ box.innerHTML='<div class="muted small">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
        snap.forEach(doc => {
            const c = doc.data();
            const el = document.createElement('div');
            el.className = 'project';
            el.style.padding = '8px';
            el.style.marginTop = '8px';
            el.innerHTML = `<div class="muted small">${esc(c.authorName||'ìµëª…')} Â· ${fmt(c.createdAt)}</div><div>${esc(c.text)}</div>`;
            box.appendChild(el);
        });
    } catch (e) { box.innerHTML = `<div class="muted small">ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨</div>`; }
  }

  async function addComment(e,pid){
    e.preventDefault(); if(!me) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    const input = $(`#c-${pid}`);
    const text = (input.value||'').trim(); if(!text) return;
    try{ await db.collection('projects').doc(pid).collection('comments').add({text,createdAt:firebase.firestore.FieldValue.serverTimestamp(),authorUid:me.uid,authorName:me.displayName||'ìµëª…'}); input.value=''; loadComments(pid);}catch(e){ alert('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨: '+e.message);}
  }
  
  async function loadFiles(pid) {
    const box=$(`#files-${pid}`); box.innerHTML='';
    try {
      const snap = await db.collection('projects').doc(pid).collection('files').orderBy('createdAt','desc').get();
      if(snap.empty){ box.innerHTML='<div class="muted small">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      snap.forEach(doc => {
        const f = doc.data();
        const isImg = (f.contentType||'').startsWith('image/');
        const row = document.createElement('div');
        row.className = 'file-row';
        row.style.marginTop = '8px';
        row.innerHTML = `<div class="flex" style="flex:1;gap:10px">${isImg?`<img class="thumb" src="${esc(f.url)}" alt="${esc(f.name||'image')}">`:''}<div><div class="muted small" style="word-break:break-all;">${esc(f.name||'íŒŒì¼')}</div><a href="${esc(f.url)}" target="_blank" rel="noopener">${isImg?'ì›ë³¸ ì—´ê¸°':'ë‹¤ìš´ë¡œë“œ'}</a></div></div>`;
        box.appendChild(row);
      });
    } catch(e) { box.innerHTML = `<div class="muted small">íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨</div>`; }
  }
  
  async function uploadFile(e, pid) {
    e.preventDefault(); if(!me || !canWrite) return alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
    const input = $(`#f-${pid}`);
    const file = input.files[0];
    if(!file) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    if(file.size > 10 * 1024 * 1024) return alert('íŒŒì¼ì€ 10MB ì´í•˜ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');

    try {
      const path = `uploads/${pid}/${Date.now()}_${file.name}`;
      const ref = storage.ref().child(path);
      const snap = await ref.put(file, { customMetadata: { ownerUid: me.uid } });
      const url = await snap.ref.getDownloadURL();
      await db.collection('projects').doc(pid).collection('files').add({
          name: file.name,
          size: file.size,
          contentType: file.type,
          url,
          storagePath: path,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          ownerUid: me.uid,
          ownerName: me.displayName || 'ìµëª…'
      });
      input.value = '';
      loadFiles(pid);
    } catch (e) {
      alert('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
    }
  }

  $('#form-new').addEventListener('submit',async e=>{
    e.preventDefault(); if(!me||!canWrite) return alert('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
    const title=$('#p-title').value.trim(), desc=$('#p-desc').value.trim(); const tags=parseTags($('#p-tags').value); const mf=$('#p-mainfile').files[0]; if(!title||!desc) return alert('ì œëª©ê³¼ ì„¤ëª…ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.');
    try{
      const ref=await db.collection('projects').add({ownerUid,title,desc,tags,authorUid:me.uid,authorName:me.displayName||'ìµëª…',authorEmail:me.email||null,createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp(),mainFile:null});
      if(mf){ if(mf.size>10*1024*1024) throw new Error('ëŒ€í‘œ ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ 10MBì…ë‹ˆë‹¤.'); const path=`uploads/${ref.id}/main_${Date.now()}_${mf.name}`; const snap=await storage.ref().child(path).put(mf,{customMetadata:{ownerUid:me.uid}}); const url=await snap.ref.getDownloadURL(); await ref.update({mainFile:{name:mf.name,size:mf.size,contentType:mf.type,url,storagePath:path,uploadedAt:firebase.firestore.FieldValue.serverTimestamp(),ownerUid:me.uid}}); }
      e.target.reset(); loadProjects();
    }catch(err){ alert('í”„ë¡œì íŠ¸ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: '+err.message); }
  });
</script>
</body>
</html>
