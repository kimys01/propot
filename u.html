<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="https://kimys01.github.io/propot/">
<title>내 포트폴리오</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-color: #6a5acd;
    --button-hover-color: #5a4ab9;
    --background-color: #f0f2f5;
    --container-bg-color: #ffffff;
    --text-color: #333;
    --text-muted-color: #666;
    --border-color: #e0e0e0;
    --danger-bg-color: #fee2e2;
    --danger-text-color: #b91c1c;
    --danger-border-color: #fecaca;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:var(--background-color);
    color:var(--text-color);
    font:16px/1.5 'Noto Sans KR', system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Malgun Gothic,sans-serif;
  }
  a{color:var(--primary-color); text-decoration:none}
  a:hover{text-decoration:underline}
  .hdr{
    position:sticky;
    top:0;
    background:var(--container-bg-color);
    border-bottom:1px solid var(--border-color);
    backdrop-filter:blur(8px);
    z-index:10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .hdr strong { color: var(--primary-color); }
  .wrap{max-width:1024px;margin:0 auto;padding:14px 18px}
  .row{display:flex;gap:10px;align-items:center}
  .row.space{justify-content:space-between}
  .row.gap8{gap:8px}
  .row.wrap{flex-wrap:wrap}
  .pad16{padding:16px 18px}
  .mt10{margin-top:10px}.mt14{margin-top:14px}.mt8{margin-top:8px}
  .card{
    background:var(--container-bg-color);
    border: none;
    border-radius:12px;
    padding:24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
  }
  .list{display:grid;gap:12px}
  .project {
    background: var(--container-bg-color);
    border:1px solid var(--border-color);
    border-radius:12px;
    padding:16px;
  }
  .chip{
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    background-color: #ebebeb;
    color: var(--text-muted-color);
  }
  .muted{color:var(--text-muted-color)}
  .ttl{
    margin:0 0 12px;
    color: var(--primary-color);
    font-weight: 700;
    font-size: 22px;
  }
  button,input,textarea,a.secondary,a.ghost{font:inherit}
  textarea{min-height:80px;resize:vertical}
  button, a.secondary, a.ghost {
    padding:9px 14px;
    border:none;
    border-radius:8px;
    font-size: 14px;
    font-weight:500;
    cursor:pointer;
    transition: all 0.2s;
    display: inline-flex;
    justify-content: center;
    align-items: center;
  }
  button{
    background-color:var(--primary-color);
    color:white;
  }
  button:hover {
    background-color: var(--button-hover-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  button.secondary, a.secondary{
    background-color:#f0f0f0;
    color:var(--text-color);
    border:1px solid var(--border-color);
  }
  button.secondary:hover, a.secondary:hover {
    background-color: #e5e5e5;
  }
  button.ghost, a.ghost{
    background:transparent;
    color: var(--text-muted-color);
    border:1px solid var(--border-color);
  }
  button.ghost:hover, a.ghost:hover {
    background: rgba(106, 90, 205, 0.05);
    color: var(--primary-color);
    border-color: var(--primary-color);
  }
   button.danger {
    background-color: var(--danger-bg-color);
    color: var(--danger-text-color);
    border: 1px solid var(--danger-border-color);
  }
  button.danger:hover {
    background-color: #fecaca;
  }
  .mini{padding:6px 10px;border-radius:8px;font-size:12px}
  .inp{
    width:100%;
    background:#ffffff;
    color:var(--text-color);
    border:1px solid var(--border-color);
    border-radius:8px;
    padding:12px 14px;
    transition: all 0.2s;
  }
  .inp:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.2);
  }
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:860px){.grid.cols-2{grid-template-columns:1fr}}
  .manage{display:flex;gap:6px;}

  /* --- 추가된 스타일: 파일 첨부, 갤러리 뷰, 댓글 --- */
  .file-display {
    margin-top: 10px;
    background-color: #f9f9f9;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .file-display img {
    width: 80px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
  }
  .gallery-view {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }
  .gallery-view .project {
    padding: 0;
    overflow: hidden;
  }
  .gallery-view .project .project-thumbnail {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
  }
  .gallery-view .project .project-info {
    padding: 12px;
  }
  .comments-section {
    border-top: 1px solid var(--border-color);
    padding-top: 16px;
    margin-top: 16px;
  }
  .comment-item {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  .comment-item:last-child {
    border-bottom: none;
  }
  .comment-item p {
    margin: 4px 0 0;
  }
</style>
</head>
<body>
<header class="hdr">
  <div class="wrap row">
    <div class="row"><strong>📄 포트폴리오</strong><span id="owner-chip" class="chip"></span></div>
    <div class="row ml-auto gap8">
      <span id="user-line" class="muted">로그인 필요</span>
      <button id="btn-login" class="secondary">로그인</button>
      <button id="btn-logout" class="secondary" style="display:none">로그아웃</button>
      <a id="btn-home" class="secondary" href="index.html">메인</a>
      <button id="btn-copy" class="secondary">공유 링크 복사</button>
    </div>
  </div>
</header>

<main class="wrap pad16">
  
  <section id="write-section" class="card" style="display:none;">
    <h2 class="ttl">프로젝트 작성</h2>
    <p id="write-hint" class="muted"></p>
    <form id="form-new" class="list">
      <input id="p-title" class="inp" placeholder="프로젝트 제목" required/>
      <textarea id="p-desc" class="inp" placeholder="프로젝트에 대한 상세 설명" required></textarea>
      <div class="grid cols-2">
        <input id="p-tags" class="inp" placeholder="태그 (쉼표로 구분)"/>
        <input id="p-file" type="file" class="inp"/>
      </div>
      <div class="row"><button type="submit">등록하기</button></div>
    </form>
  </section>

  <section class="card mt14">
    <div class="row space wrap">
      <h2 class="ttl">프로젝트 목록</h2>
    </div>
    <div id="list" class="list mt10"></div>
  </section>

</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
  const cfg={apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",authDomain:"propot-cc6bf.firebaseapp.com",projectId:"propot-cc6bf",storageBucket:"propot-cc6bf.firebasestorage.app",appId:"1:30940698980:web:1729f30e68d3beb24ac271"};
  firebase.initializeApp(cfg);
  const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

  const $=s=>document.querySelector(s);
  const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const parseTags=v=>String(v||'').split(/[, \t]+/).map(x=>x.trim().replace(/^#/,'').toLowerCase()).filter(Boolean).slice(0,10);
  const fmt=ts=>{ if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString(); };

  const params=new URLSearchParams(location.search);
  const ownerUid=params.get('uid');
  if(!ownerUid){
    alert('잘못된 접근: 사용자 UID가 없습니다.');
    location.href='index.html';
  }

  let me=null, isAdmin=false, canWrite=false;
  let ownerData = {}, loadedProjects = [];

  async function initializePage() {
    await loadOwnerProfile();
    auth.onAuthStateChanged(async user => {
      me = user;
      updateHeaderUI();
      await computePermission();
      await loadProjects();
    });
  }

  function updateHeaderUI() {
    if (me) {
      $('#user-line').textContent = `${me.displayName || '익명'}`;
      $('#btn-login').style.display = 'none';
      $('#btn-logout').style.display = '';
    } else {
      $('#user-line').textContent = '로그인 필요';
      $('#btn-login').style.display = '';
      $('#btn-logout').style.display = 'none';
    }
  }

  async function loadOwnerProfile() {
    try {
      const userDoc = await db.collection('users').doc(ownerUid).get();
      if (userDoc.exists) {
        ownerData = userDoc.data();
        $('#owner-chip').textContent = `소유자: ${ownerData.displayName || '익명'}`;
      } else {
        $('#owner-chip').textContent = `존재하지 않는 사용자`;
      }
    } catch (e) {
      console.error("Owner profile load failed:", e);
      $('#owner-chip').textContent = `정보 로딩 실패`;
    }
  }

  async function computePermission(){
    if(!me){ canWrite=false; return; }
    const isOwner = me.uid === ownerUid;
    let isFriend = false;
    try { 
      isAdmin = (await db.collection('roles').doc(me.uid).get()).exists; 
    } catch { 
      isAdmin = false; 
    }
    if(!isOwner && !isAdmin){
      try{
        const friendDocId = `${ownerUid}_${me.uid}`;
        const friendDoc = await db.collection('friends').doc(friendDocId).get();
        isFriend = friendDoc.exists;
      }catch(e){ console.warn('친구 관계 확인 중 오류:', e); }
    }
    canWrite = isOwner || isFriend || isAdmin;
    $('#write-section').style.display = canWrite ? 'block' : 'none';
    $('#write-hint').textContent = canWrite ? '새로운 프로젝트를 등록하여 포트폴리오를 채워보세요.' : '이 포트폴리오의 소유자 또는 공유받은 친구만 작성할 수 있습니다.';
  }
  
  async function loadProjects() {
    const box=$('#list');
    box.innerHTML = '<div class="muted">프로젝트를 불러오는 중...</div>';
    try {
      const projectsRef = db.collection('projects');
      const snap = await projectsRef.where('ownerUid', '==', ownerUid).orderBy('createdAt', 'desc').get();
      
      loadedProjects = [];
      snap.forEach(doc => loadedProjects.push({ id: doc.id, data: doc.data() }));

      renderProjects(loadedProjects);
    } catch (e) {
      console.error("Projects load failed:", e);
      box.innerHTML = `<div class="muted">프로젝트를 불러오는 데 실패했습니다: ${esc(e.message)}</div>`;
    }
  }

  function renderProjects(list) {
    const listEl = $('#list');
    listEl.innerHTML = '';
    
    if (ownerData.jobRole && ownerData.jobRole.includes('designer')) {
      listEl.classList.add('gallery-view');
    } else {
      listEl.classList.remove('gallery-view');
    }

    if (!list || !list.length) {
      listEl.innerHTML = '<div class="muted">아직 등록된 프로젝트가 없습니다.</div>';
      return;
    }
    list.forEach(({ id, data }) => renderProjectCard(id, data, listEl));
  }

  function renderProjectCard(id, data, listEl) {
    const mine = me && (me.uid === data.authorUid);
    const allowManage = me && (mine || isAdmin);
    const isGalleryView = listEl.classList.contains('gallery-view');
    
    const card = document.createElement('article');
    card.className = 'project';
    card.id = `project-${id}`;
    
    let fileHtml = '';
    if (data.mainFile) {
        const isImage = data.mainFile.contentType.startsWith('image/');
        if (isGalleryView) {
            if (isImage) {
                fileHtml = `<img src="${esc(data.mainFile.url)}" alt="${esc(data.title)}" class="project-thumbnail">`;
            }
        } else {
            fileHtml = `<div class="file-display">
                ${isImage ? `<img src="${esc(data.mainFile.url)}" alt="thumbnail">` : '📄'}
                <div>
                    <a href="${esc(data.mainFile.url)}" target="_blank" rel="noopener">${esc(data.mainFile.name)}</a>
                    <div class="muted small">${(data.mainFile.size / 1024).toFixed(1)} KB</div>
                </div>
            </div>`;
        }
    } else if (isGalleryView) {
        fileHtml = `<div class="project-thumbnail" style="background:#f0f0f0; display:flex; align-items:center; justify-content:center; color:#ccc;">No Image</div>`;
    }

    const infoHtml = `
      <div class="project-info">
        <div class="row space wrap">
          <div>
            <h3 style="margin:0">${esc(data.title)}</h3>
            <div class="muted small" style="margin-top:2px;">${esc(data.authorName || '익명')} · ${fmt(data.createdAt)}</div>
          </div>
          ${allowManage ? `<div class="manage">
            <button class="ghost mini btn-edit">수정</button>
            <button class="danger mini btn-del">삭제</button>
          </div>` : ''}
        </div>
        <p style="margin:8px 0 0; white-space: pre-wrap; display:${isGalleryView ? 'none' : 'block'};">${esc(data.desc)}</p>
        ${(data.tags && data.tags.length) ? `<div class="row wrap" style="gap:6px;margin-top:8px">${data.tags.map(t => `<span class="chip">#${esc(t)}</span>`).join('')}</div>` : ''}
      </div>
    `;

    const commentsHtml = `
      <div class="comments-section">
          <h4 style="margin:0 0 8px 0; font-size: 16px;">댓글</h4>
          <div class="list" id="comments-${id}"></div>
          ${canWrite ? `<form class="list mt10" id="form-comment-${id}">
              <textarea class="inp" placeholder="댓글을 입력하세요..." required style="min-height: 60px;"></textarea>
              <div class="row"><button type="submit" class="secondary mini">등록</button></div>
          </form>` : '<p class="muted small mt10">댓글을 작성하려면 로그인이 필요합니다.</p>'}
      </div>`;

    card.innerHTML = fileHtml + infoHtml + commentsHtml;

    let editHtml = `
      <form class="list edit-form" style="padding:16px;">
        <input class="inp" value="${esc(data.title)}" required>
        <textarea class="inp" required>${esc(data.desc)}</textarea>
        <input class="inp" value="${(data.tags || []).join(', ')}">
        <div class="muted small">현재 파일: ${data.mainFile ? esc(data.mainFile.name) : '없음'}</div>
        <input type="file" class="inp file-input">
        <div class="row gap8">
            <button type="submit">저장</button>
            <button type="button" class="ghost btn-cancel-edit">취소</button>
            ${data.mainFile ? '<button type="button" class="danger mini btn-del-file">파일 삭제</button>' : ''}
        </div>
      </form>
    `;

    listEl.appendChild(card);

    // 댓글 기능 초기화
    if(canWrite) {
      const commentForm = card.querySelector(`#form-comment-${id}`);
      if(commentForm) {
          commentForm.addEventListener('submit', (e) => addComment(e, id));
      }
    }
    loadComments(id);

    if (allowManage) {
      const btnEdit = card.querySelector('.btn-edit');
      const btnDel = card.querySelector('.btn-del');

      btnEdit.onclick = () => {
        card.innerHTML = editHtml;
        const form = card.querySelector('.edit-form');
        const btnCancel = card.querySelector('.btn-cancel-edit');
        const btnDelFile = card.querySelector('.btn-del-file');

        btnCancel.onclick = () => loadProjects();

        if(btnDelFile) {
            btnDelFile.onclick = async () => {
                if (!confirm('첨부파일을 삭제하시겠습니까?')) return;
                try {
                    const projectRef = db.collection('projects').doc(id);
                    if(data.mainFile.storagePath) {
                        await storage.ref(data.mainFile.storagePath).delete();
                    }
                    await projectRef.update({ mainFile: null });
                    await loadProjects();
                } catch(err) { alert('파일 삭제 실패: '+err.message); }
            };
        }

        form.onsubmit = async (e) => {
          e.preventDefault();
          const newTitle = form.children[0].value.trim();
          const newDesc = form.children[1].value.trim();
          const newTags = parseTags(form.children[2].value);
          const newFile = card.querySelector('.file-input').files[0];

          if (!newTitle || !newDesc) return alert('제목과 설명을 입력하세요.');

          try {
            const projectRef = db.collection('projects').doc(id);
            const updateData = {
              title: newTitle, desc: newDesc, tags: newTags,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (newFile) {
              if (newFile.size > 10 * 1024 * 1024) throw new Error('10MB 이하 파일만 업로드 가능합니다.');
              if (data.mainFile && data.mainFile.storagePath) {
                await storage.ref(data.mainFile.storagePath).delete().catch(e => console.warn("Old file deletion failed:", e));
              }
              const storagePath = `uploads/${ownerUid}/${id}/${Date.now()}_${newFile.name}`;
              const fileRef = storage.ref(storagePath);
              const snap = await fileRef.put(newFile);
              const url = await snap.ref.getDownloadURL();
              updateData.mainFile = {
                  name: newFile.name, size: newFile.size, contentType: newFile.type,
                  url, storagePath
              };
            }
            await projectRef.update(updateData);
            await loadProjects();
          } catch (err) { alert('수정 실패: ' + err.message); }
        };
      };

      btnDel.onclick = async () => {
        if (!confirm('정말로 이 프로젝트를 삭제하시겠습니까?')) return;
        try {
          // 댓글 하위 컬렉션 삭제
          const commentsRef = db.collection('projects').doc(id).collection('comments');
          const commentsSnap = await commentsRef.get();
          const batch = db.batch();
          commentsSnap.docs.forEach(doc => batch.delete(doc.ref));
          await batch.commit();

          // 파일 삭제
          if (data.mainFile && data.mainFile.storagePath) {
            await storage.ref(data.mainFile.storagePath).delete().catch(e => console.warn("File deletion failed:", e));
          }
          // 프로젝트 문서 삭제
          await db.collection('projects').doc(id).delete();
          await loadProjects();
        } catch (err) { alert('삭제 실패: ' + err.message); }
      };
    }
  }

  // --- 댓글 관련 함수들 ---
  async function loadComments(projectId) {
    const box = $(`#project-${projectId} #comments-${projectId}`);
    if (!box) return;
    box.innerHTML = '<div class="muted small">댓글 불러오는 중...</div>';
    try {
      const commentsRef = db.collection('projects').doc(projectId).collection('comments');
      const snap = await commentsRef.orderBy('createdAt', 'asc').get();

      if (snap.empty) {
        box.innerHTML = '<div class="muted small">아직 댓글이 없습니다.</div>';
        return;
      }
      box.innerHTML = '';
      snap.forEach(doc => {
        const commentId = doc.id;
        const data = doc.data();
        const canManageComment = me && (me.uid === data.authorUid || me.uid === ownerUid || isAdmin);
        const commentEl = document.createElement('div');
        commentEl.className = 'comment-item';
        
        const viewHtml = `
          <div class="comment-view">
            <div class="row space">
              <div class="muted small"><strong>${esc(data.authorName || '익명')}</strong> · ${fmt(data.createdAt)} ${data.updatedAt ? '(수정됨)' : ''}</div>
              ${canManageComment ? `<div class="manage">
                  <button class="ghost mini btn-mod-comment">수정</button>
                  <button class="danger mini btn-del-comment">삭제</button>
              </div>` : ''}
            </div>
            <p style="margin: 4px 0 0;">${esc(data.text)}</p>
          </div>
        `;
        
        const editHtml = `
          <div class="comment-edit-view list">
            <textarea class="inp" style="min-height: 60px;">${esc(data.text)}</textarea>
            <div class="row gap8">
                <button type="button" class="secondary mini btn-save-mod">저장</button>
                <button type="button" class="ghost mini btn-cancel-mod">취소</button>
            </div>
          </div>
        `;
        
        commentEl.innerHTML = viewHtml;
        box.appendChild(commentEl);

        if (canManageComment) {
          const viewMode = commentEl.querySelector('.comment-view');
          
          const editBtn = viewMode.querySelector('.btn-mod-comment');
          editBtn.onclick = () => {
            commentEl.innerHTML = editHtml;
            const editMode = commentEl.querySelector('.comment-edit-view');
            const saveBtn = editMode.querySelector('.btn-save-mod');
            const cancelBtn = editMode.querySelector('.btn-cancel-mod');

            saveBtn.onclick = async () => {
              const newText = editMode.querySelector('textarea').value.trim();
              if (!newText) return alert('댓글 내용을 입력하세요.');
              try {
                await db.collection('projects').doc(projectId).collection('comments').doc(commentId).update({
                  text: newText,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadComments(projectId);
              } catch (err) { alert('댓글 수정 실패: ' + err.message); }
            };

            cancelBtn.onclick = () => {
              commentEl.innerHTML = viewHtml;
              commentEl.querySelector('.btn-mod-comment').onclick = editBtn.onclick; // 이벤트 다시 연결
              commentEl.querySelector('.btn-del-comment').onclick = deleteBtn.onclick; // 이벤트 다시 연결
            };
          };

          const deleteBtn = viewMode.querySelector('.btn-del-comment');
          deleteBtn.onclick = async () => {
            if (confirm('이 댓글을 삭제하시겠습니까?')) {
              try {
                await db.collection('projects').doc(projectId).collection('comments').doc(commentId).delete();
                loadComments(projectId);
              } catch (err) { alert('댓글 삭제 실패: ' + err.message); }
            }
          };
        }
      });
    } catch (e) {
      console.error("Comments load failed:", e);
      box.innerHTML = `<div class="muted small">댓글을 불러오는 데 실패했습니다.</div>`;
    }
  }

  async function addComment(event, projectId) {
    event.preventDefault();
    if (!me) {
      alert('댓글을 작성하려면 로그인이 필요합니다.');
      return;
    }
    const form = $(`#form-comment-${projectId}`);
    const textarea = form.querySelector('textarea');
    const text = textarea.value.trim();
    if (!text) return;

    try {
      await db.collection('projects').doc(projectId).collection('comments').add({
        authorUid: me.uid,
        authorName: me.displayName || '익명',
        text: text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      textarea.value = '';
      loadComments(projectId);
    } catch (err) {
      alert('댓글 등록 실패: ' + err.message);
    }
  }

  $('#btn-login').onclick=()=>location.href=`login.html`;
  $('#btn-logout').onclick=()=>auth.signOut();
  
  const shareUrl=`${location.origin}${location.pathname.replace('u.html', '')}u.html?uid=${encodeURIComponent(ownerUid)}`;
  $('#btn-copy').onclick=async()=>{ try { await navigator.clipboard.writeText(shareUrl); alert('공유 링크가 복사되었습니다.'); } catch(e) { alert('복사에 실패했습니다.'); } };

  $('#form-new').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!canWrite) return alert('작성 권한이 없습니다.');

    const title = $('#p-title').value.trim();
    const desc = $('#p-desc').value.trim();
    const tags = parseTags($('#p-tags').value);
    const file = $('#p-file').files[0];

    if (!title || !desc) return alert('제목과 설명은 필수입니다.');

    try {
      const projectsRef = db.collection('projects');
      const docRef = await projectsRef.add({
        ownerUid: ownerUid,
        authorUid: me.uid,
        authorName: me.displayName || '익명',
        title, desc, tags,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        mainFile: null
      });

      if (file) {
        if (file.size > 10 * 1024 * 1024) throw new Error('10MB 이하 파일만 업로드 가능합니다.');
        const storagePath = `uploads/${ownerUid}/${docRef.id}/${Date.now()}_${file.name}`;
        const fileRef = storage.ref(storagePath);
        const snap = await fileRef.put(file);
        const url = await snap.ref.getDownloadURL();
        await docRef.update({
          mainFile: {
            name: file.name, size: file.size, contentType: file.type,
            url, storagePath
          }
        });
      }

      e.target.reset();
      await loadProjects();
    } catch (err) {
      alert('프로젝트 등록 실패: ' + err.message);
    }
  });

  initializePage();
</script>
</body>
</html>

