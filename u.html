<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base href="https://kimys01.github.io/propot/">
<title>내 포트폴리오</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  /* === 일관된 스타일 테마 적용 === */
  :root {
    --primary-color: #6a5acd;
    --button-hover-color: #5a4ab9;
    --background-color: #f0f2f5;
    --container-bg-color: #ffffff;
    --text-color: #333;
    --text-muted-color: #666;
    --border-color: #e0e0e0;
    --danger-bg-color: #fee2e2;
    --danger-text-color: #b91c1c;
    --danger-border-color: #fecaca;
  }

  /* === 기본 스타일 초기화 및 설정 === */
  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:var(--background-color);
    color:var(--text-color);
    font:16px/1.5 'Noto Sans KR', system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Malgun Gothic,sans-serif;
  }
  a{color:var(--primary-color); text-decoration:none}
  a:hover{text-decoration:underline}

  /* === 헤더 스타일 === */
  .hdr{
    position:sticky;
    top:0;
    background:var(--container-bg-color);
    border-bottom:1px solid var(--border-color);
    backdrop-filter:blur(8px);
    z-index:10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .hdr strong {
    color: var(--primary-color);
  }

  /* === 레이아웃 헬퍼 클래스 === */
  .wrap{max-width:1024px;margin:0 auto;padding:14px 18px}
  .row{display:flex;gap:10px;align-items:center}
  .row.space{justify-content:space-between}
  .row.gap8{gap:8px}
  .row.wrap{flex-wrap:wrap}
  .pad16{padding:16px 18px}
  .mt10{margin-top:10px}.mt14{margin-top:14px}.mt8{margin-top:8px}.mt2{margin-top:2px}
  
  /* === 카드 및 콘텐츠 스타일 === */
  .card{
    background:var(--container-bg-color);
    border: none;
    border-radius:12px;
    padding:24px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.07);
  }
  .list{display:grid;gap:12px}
  .project{
    background: var(--container-bg-color);
    border:1px solid var(--border-color);
    border-radius:12px;
    padding:16px;
  }
  .chip{
    font-size:12px;
    padding:2px 8px;
    border-radius:999px;
    background-color: #ebebeb;
    color: var(--text-muted-color);
  }
  .muted{color:var(--text-muted-color)}
  .ttl{
    margin:0 0 12px;
    color: var(--primary-color);
    font-weight: 700;
    font-size: 22px;
  }

  /* === 버튼, 입력창 등 폼 요소 스타일 === */
  button,input,textarea,a.secondary,a.ghost{font:inherit}
  textarea{min-height:80px;resize:vertical}

  button, a.secondary, a.ghost {
    padding:9px 14px;
    border:none;
    border-radius:8px;
    font-size: 14px;
    font-weight:500;
    cursor:pointer;
    transition: all 0.2s;
    display: inline-flex;
    justify-content: center;
    align-items: center;
  }

  button{ /* 기본 버튼 (Primary) */
    background-color:var(--primary-color);
    color:white;
  }
  button:hover {
    background-color: var(--button-hover-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  button.secondary, a.secondary{ /* 보조 버튼 (Secondary) */
    background-color:#f0f0f0;
    color:var(--text-color);
    border:1px solid var(--border-color);
  }
  button.secondary:hover, a.secondary:hover {
    background-color: #e5e5e5;
  }
  
  button.ghost, a.ghost{ /* 고스트 버튼 */
    background:transparent;
    color: var(--text-muted-color);
    border:1px solid var(--border-color);
  }
  button.ghost:hover, a.ghost:hover {
    background: rgba(106, 90, 205, 0.05);
    color: var(--primary-color);
    border-color: var(--primary-color);
  }

  button.danger {
    background-color: var(--danger-bg-color);
    color: var(--danger-text-color);
    border: 1px solid var(--danger-border-color);
  }
  button.danger:hover {
    background-color: #fecaca;
  }
  
  .mini{padding:6px 10px;border-radius:8px;font-size:12px}
  
  .inp{
    width:100%;
    background:#ffffff;
    color:var(--text-color);
    border:1px solid var(--border-color);
    border-radius:8px;
    padding:12px 14px;
    transition: all 0.2s;
  }
  .inp:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.2);
  }

  /* === 직무별 기능 스타일 === */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
  }
  .gallery-item {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: #eee;
  }
  .gallery-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease;
  }
  .gallery-item:hover img {
    transform: scale(1.05);
  }
  .gallery-item-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
    color: white;
    padding: 12px;
    font-size: 14px;
    font-weight: 500;
  }
  .showreel-container {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    height: 0;
    overflow: hidden;
    max-width: 100%;
    background: #000;
    border-radius: 8px;
  }
  .showreel-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
  .article-item {
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    transition: background-color 0.2s;
  }
  .article-item:hover {
    background-color: #f9f9f9;
  }

  /* === 기타 컴포넌트 스타일 === */
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:860px){.grid.cols-2{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="hdr">
  <div class="wrap row">
    <div class="row"><strong>📄 포트폴리오</strong><span id="owner-chip" class="chip"></span></div>
    <div class="row ml-auto gap8">
      <span id="user-line" class="muted">로그인 필요</span>
      <button id="btn-login" class="secondary">로그인</button>
      <button id="btn-logout" class="secondary" style="display:none">로그아웃</button>
      <a id="btn-home" class="secondary" href="index.html">메인</a>
      <button id="btn-copy" class="secondary">공유 링크 복사</button>
    </div>
  </div>
</header>

<main class="wrap pad16">
  
  <!-- === 직무별 맞춤 섹션 (기본 숨김) === -->
  <section id="developer-section" class="card" style="display:none;">
    <h2 class="ttl">💻 Developer Profile</h2>
    <div id="developer-profile-view"></div>
    <form id="developer-edit-form" class="list mt14" style="display:none;">
        <input id="github-username" class="inp" placeholder="GitHub 사용자 이름 (예: torvalds)"/>
        <div class="row"><button type="submit">GitHub 정보 저장</button></div>
    </form>
  </section>

  <section id="designer-section" class="card" style="display:none;">
    <h2 class="ttl">🎨 Design Gallery</h2>
    <p class="muted">대표 이미지가 있는 프로젝트가 여기에 표시됩니다.</p>
    <div id="designer-gallery" class="gallery-grid mt14"></div>
  </section>

  <section id="creator-section" class="card" style="display:none;">
      <h2 class="ttl">🎬 Showreel</h2>
      <div id="creator-showreel-view"></div>
      <form id="creator-edit-form" class="list mt14" style="display:none;">
          <input id="showreel-url" class="inp" placeholder="YouTube 또는 Vimeo 영상 URL"/>
          <div class="row"><button type="submit">쇼릴 저장</button></div>
      </form>
  </section>

  <section id="writer-section" class="card" style="display:none;">
      <h2 class="ttl">✍️ Featured Articles</h2>
      <p class="muted">주요 프로젝트가 여기에 요약되어 표시됩니다.</p>
      <div id="writer-articles" class="list mt14"></div>
  </section>


  <section id="write-section" class="card mt14" style="display:none;">
    <h2 class="ttl">프로젝트 작성</h2>
    <p id="write-hint" class="muted"></p>
    <form id="form-new" class="list">
      <input id="p-title" class="inp" placeholder="프로젝트 제목" required/>
      <textarea id="p-desc" class="inp" placeholder="프로젝트에 대한 상세 설명" required></textarea>
      <div class="grid cols-2">
        <input id="p-tags" class="inp" placeholder="태그 (쉼표로 구분) 예: 웹개발, React"/>
        <input id="p-mainfile" class="inp" type="file"/>
      </div>
      <div class="row"><button type="submit">등록하기</button></div>
    </form>
  </section>

  <section class="card mt14">
    <div class="row space wrap">
      <h2 class="ttl">전체 프로젝트</h2>
      <div class="row gap8">
        <input id="search-input" class="inp" placeholder="검색: 키워드 또는 #태그" style="min-width:220px">
        <button id="btn-refresh" class="secondary">새로고침</button>
      </div>
    </div>
    <div id="list" class="list mt10"></div>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script>
  const cfg={apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",authDomain:"propot-cc6bf.firebaseapp.com",projectId:"propot-cc6bf",storageBucket:"propot-cc6bf.firebasestorage.app",appId:"1:30940698980:web:1729f30e68d3beb24ac271"};
  firebase.initializeApp(cfg);
  const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

  const $=s=>document.querySelector(s);
  const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const fmt=ts=>{ if(!ts) return ''; const d=ts.toDate?ts.toDate():new Date(ts); return d.toLocaleString(); };

  const params=new URLSearchParams(location.search); const ownerUid=params.get('uid');
  if(!ownerUid){ alert('잘못된 접근: 사용자 UID가 없습니다.'); location.href='index.html'; }
  
  let me=null,isAdmin=false,canWrite=false;
  let loadedProjects=[];
  let ownerData = {};

  async function initializePage() {
    await loadOwnerProfileAndSetupUI();
    auth.onAuthStateChanged(async u => {
      me = u;
      if (u) {
        $('#user-line').textContent = `${u.displayName || '익명'}`;
        $('#btn-login').style.display = 'none';
        $('#btn-logout').style.display = '';
        try { isAdmin = (await db.collection('roles').doc(u.uid).get()).exists; } catch { isAdmin = false; }
      } else {
        $('#user-line').textContent = '로그인 필요';
        $('#btn-login').style.display = '';
        $('#btn-logout').style.display = 'none';
      }
      await computePermission();
      setupEditForms(); // 권한 확인 후 수정 폼 설정
      await loadProjects();
    });
  }

  async function loadOwnerProfileAndSetupUI() {
    try {
      const userDoc = await db.collection('users').doc(ownerUid).get();
      if (userDoc.exists) {
        ownerData = userDoc.data();
        $('#owner-chip').textContent = `소유자: ${ownerData.displayName || '익명'}`;
        
        const jobRoles = ownerData.jobRole || [];
        
        // 직무별 섹션 표시 및 렌더링
        if (jobRoles.includes('developer')) {
          $('#developer-section').style.display = 'block';
          renderDeveloperProfile(ownerData);
        }
        if (jobRoles.includes('designer')) {
          $('#designer-section').style.display = 'block';
        }
        if (jobRoles.includes('creator')) {
          $('#creator-section').style.display = 'block';
          renderCreatorShowreel(ownerData);
        }
        if (jobRoles.includes('writer')) {
          $('#writer-section').style.display = 'block';
        }
      } else {
        $('#owner-chip').textContent = `존재하지 않는 사용자`;
      }
    } catch (e) {
      console.error("Owner profile load failed:", e);
      $('#owner-chip').textContent = `정보 로딩 실패`;
    }
  }

  function setupEditForms() {
      if (canWrite) {
          const devForm = $('#developer-edit-form');
          if(devForm) {
              devForm.style.display = 'block';
              devForm.addEventListener('submit', async (e) => {
                  e.preventDefault();
                  const username = $('#github-username').value.trim();
                  if (!username) return alert('GitHub 사용자 이름을 입력하세요.');
                  await db.collection('users').doc(ownerUid).update({ githubUsername: username });
                  alert('저장되었습니다.');
                  ownerData.githubUsername = username;
                  renderDeveloperProfile(ownerData);
              });
          }

          const creatorForm = $('#creator-edit-form');
          if(creatorForm) {
              creatorForm.style.display = 'block';
              creatorForm.addEventListener('submit', async (e) => {
                  e.preventDefault();
                  const url = $('#showreel-url').value.trim();
                  if (!url) return alert('영상 URL을 입력하세요.');
                  await db.collection('users').doc(ownerUid).update({ showreelUrl: url });
                  alert('저장되었습니다.');
                  ownerData.showreelUrl = url;
                  renderCreatorShowreel(ownerData);
              });
          }
      }
  }

  function renderDeveloperProfile(userData) {
      const view = $('#developer-profile-view');
      if (userData.githubUsername) {
          view.innerHTML = `<a href="https://github.com/${esc(userData.githubUsername)}" target="_blank" rel="noopener">
              <button class="secondary">🔗 GitHub @${esc(userData.githubUsername)}</button>
          </a>`;
          $('#github-username').value = userData.githubUsername;
      } else {
          view.innerHTML = `<p class="muted">아직 GitHub 정보가 등록되지 않았습니다.</p>`;
      }
  }

  function renderCreatorShowreel(userData) {
      const view = $('#creator-showreel-view');
      const url = userData.showreelUrl;
      if (url) {
          let embedUrl = '';
          if (url.includes('youtube.com/watch?v=')) {
              const videoId = url.split('v=')[1].split('&')[0];
              embedUrl = `https://www.youtube.com/embed/${videoId}`;
          } else if (url.includes('youtu.be/')) {
              const videoId = url.split('youtu.be/')[1].split('?')[0];
              embedUrl = `https://www.youtube.com/embed/${videoId}`;
          } else if (url.includes('vimeo.com/')) {
              const videoId = url.split('vimeo.com/')[1].split('?')[0];
              embedUrl = `https://player.vimeo.com/video/${videoId}`;
          }
          if (embedUrl) {
              view.innerHTML = `<div class="showreel-container"><iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe></div>`;
          } else {
              view.innerHTML = `<p class="muted">지원되지 않는 영상 URL 형식입니다. (YouTube, Vimeo 지원)</p>`;
          }
          $('#showreel-url').value = url;
      } else {
          view.innerHTML = `<p class="muted">아직 쇼릴 영상이 등록되지 않았습니다.</p>`;
      }
  }

  function renderDesignerGallery(projects) {
      const gallery = $('#designer-gallery');
      if (!gallery) return;
      gallery.innerHTML = '';
      const imageProjects = projects.filter(p => p.data.mainFile && p.data.mainFile.contentType.startsWith('image/'));
      if (imageProjects.length === 0) {
          gallery.innerHTML = `<p class="muted">아직 갤러리에 표시할 이미지가 없습니다.</p>`;
          return;
      }
      imageProjects.forEach(p => {
          const item = document.createElement('div');
          item.className = 'gallery-item';
          item.innerHTML = `
              <img src="${esc(p.data.mainFile.url)}" alt="${esc(p.data.title)}">
              <div class="gallery-item-overlay">${esc(p.data.title)}</div>
          `;
          gallery.appendChild(item);
      });
  }

  function renderWriterArticles(projects) {
      const container = $('#writer-articles');
      if (!container) return;
      container.innerHTML = '';
      if (projects.length === 0) {
          container.innerHTML = `<p class="muted">아직 표시할 글이 없습니다.</p>`;
          return;
      }
      projects.slice(0, 5).forEach(p => { // 최대 5개만 표시
          const item = document.createElement('div');
          item.className = 'article-item';
          item.innerHTML = `
              <h4 style="margin:0;">${esc(p.data.title)}</h4>
              <p class="muted small" style="margin:2px 0 6px;">${esc(p.data.desc.substring(0, 100))}...</p>
              ${(p.data.tags&&p.data.tags.length)?`<div class="row wrap" style="gap:6px;">${p.data.tags.map(t=>`<span class="chip">#${esc(t)}</span>`).join('')}</div>`:''}
          `;
          container.appendChild(item);
      });
  }

  $('#btn-login').onclick=()=>location.href=`login.html?redirect=${encodeURIComponent(location.href)}`;
  $('#btn-logout').onclick=()=>auth.signOut();
  $('#btn-refresh').onclick=()=>loadProjects();

  const shareUrl=`${location.origin}${location.pathname.replace('u.html', '')}u.html?uid=${encodeURIComponent(ownerUid)}`;
  $('#btn-copy').onclick=async()=>{ try { await navigator.clipboard.writeText(shareUrl); alert('공유 링크가 복사되었습니다.'); } catch(e) { alert('복사에 실패했습니다.'); } };

  async function computePermission(){
    if(!me){ canWrite=false; return; }
    const isOwner=me.uid===ownerUid; let isFriend=false;
    if(!isOwner && !isAdmin){
      try{
        const friendDocId = `${ownerUid}_${me.uid}`;
        const friendDoc = await db.collection('friends').doc(friendDocId).get();
        isFriend=friendDoc.exists;
      }catch(e){ console.warn('친구 관계 확인 중 오류:',e); }
    }
    canWrite=isOwner||isFriend||isAdmin;
    $('#write-hint').textContent=canWrite?'프로젝트를 등록하여 포트폴리오를 채워보세요.':'이 포트폴리오의 소유자, 또는 공유받은 친구만 작성할 수 있습니다.';
    $('#write-section').style.display=canWrite?'block':'none';
  }

  const searchInput=document.getElementById('search-input'); if(searchInput) searchInput.addEventListener('input', applyFilter);
  function applyFilter(){
    if(!searchInput){ renderProjects(loadedProjects); return; }
    const q=(searchInput.value||'').trim(); if(!q){ renderProjects(loadedProjects); return; }
    const tokens=q.split(/\s+/); const tagFilt=tokens.filter(t=>t.startsWith('#')).map(t=>t.slice(1).toLowerCase());
    const kw=tokens.filter(t=>!t.startsWith('#')).map(t=>t.toLowerCase());
    const filtered=loadedProjects.filter(({data})=>{
      const hay=(data.title+' '+data.desc+' '+(data.authorName||'')+' '+(data.tags||[]).join(' ')).toLowerCase();
      const tags=(data.tags||[]).map(t=>String(t).toLowerCase());
      const okTags=tagFilt.length===0||tagFilt.every(t=>tags.includes(t));
      const okKw=kw.length===0||kw.every(k=>hay.includes(k));
      return okTags&&okKw;
    });
    renderProjects(filtered);
  }

  async function loadProjects(){
    const box=$('#list'); box.innerHTML='<div class="muted" style="text-align:center; padding: 20px 0;">프로젝트를 불러오는 중…</div>';
    try{
      let snap; try{
        snap=await db.collection('projects').where('ownerUid','==',ownerUid).orderBy('createdAt','desc').limit(100).get();
      }catch(e){
        console.warn('인덱스 생성 필요. 클라이언트에서 정렬합니다:',e.message);
        snap=await db.collection('projects').where('ownerUid','==',ownerUid).limit(100).get();
      }
      loadedProjects=[]; snap.forEach(doc=>loadedProjects.push({id:doc.id,data:doc.data()}));
      loadedProjects.sort((a,b)=>((b.data.createdAt?.toMillis?.()||0)-(a.data.createdAt?.toMillis?.()||0)));
      
      // 프로젝트 로드 후 직무별 갤러리/목록 렌더링
      renderDesignerGallery(loadedProjects);
      renderWriterArticles(loadedProjects);

      applyFilter();
    }catch(e){ $('#list').innerHTML=`<div class="muted">프로젝트를 불러오는 데 실패했습니다: ${esc(e.message)}</div>`; }
  }

  function renderProjects(list){
    const listEl=$('#list'); listEl.innerHTML='';
    if(!list||!list.length){ listEl.innerHTML='<div class="muted" style="text-align:center; padding: 20px 0;">아직 등록된 프로젝트가 없습니다.</div>'; return; }
    list.forEach(({id,data})=>renderProjectCard(id,data,listEl));
  }

  function renderProjectCard(id,d,listEl){
    const mine=me&&(me.uid===d.authorUid); const allowManage=me&&(mine||isAdmin);
    const card=document.createElement('article'); card.className='project';
    card.innerHTML=`
      <div class="row space wrap">
        <div>
          <h3 style="margin:0">${esc(d.title)}</h3>
          <div class="muted mt2 small">${esc(d.authorName||'익명')} · ${fmt(d.createdAt)}</div>
        </div>
        <div class="right-wrap">
          <div class="badges ${allowManage?'has-actions':''}">
            ${d.mainFile?.url?`<a class="chip" href="${d.mainFile.url}" target="_blank" rel="noopener">대표 첨부파일 보기</a>`:''}
          </div>
          ${allowManage?`
          <div class="manage">
            <button class="ghost mini" id="btn-edit-${id}">수정</button>
            <button class="danger mini" id="btn-del-${id}">삭제</button>
            <button class="secondary mini" id="btn-save-${id}" style="display:none;">저장</button>
            <button class="ghost mini" id="btn-cancel-${id}" style="display:none;">취소</button>
          </div>`:''}
        </div>
      </div>
      <p style="margin:8px 0 0; white-space: pre-wrap;">${esc(d.desc)}</p>
      ${(d.tags&&d.tags.length)?`<div class="row wrap" style="gap:6px;margin-top:8px">${d.tags.map(t=>`<span class="chip">#${esc(t)}</span>`).join('')}</div>`:''}
    `;
    listEl.appendChild(card);
    // (이하 생략)
  }

  // 페이지 스크립트 실행 시작
  initializePage();
</script>
</body>
</html>

