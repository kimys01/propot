<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="base.css">
  <style>
    /* í˜ì´ì§€ ì „ìš©ìœ¼ë¡œ ì•½ê°„ë§Œ ë³´ê°• */
    .searchbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .searchbar input{ min-width:260px }
    .user-card .uid{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .pill{ font-size:12px; padding:2px 8px; border:1px solid #2b3a78; border-radius:999px; color:#bcd0ff }
    .muted{ color:var(--muted) }
  </style>
</head>
<body>
<header>
  <div class="wrap row" style="gap:10px">
    <div class="row" style="gap:8px">
      <strong>ğŸ›¡ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</strong>
      <span class="pill">Users Â· Friends Â· Projects</span>
    </div>
    <div class="row" style="margin-left:auto">
      <span id="who" class="muted">ë¡œê·¸ì¸ í•„ìš”</span>
      <button id="btn-login" class="secondary">Google ë¡œê·¸ì¸</button>
      <button id="btn-logout" class="ghost" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      <a class="secondary" href="index.html">ë©”ì¸</a>
    </div>
  </div>
</header>

<main class="wrap" style="padding:16px 18px">
  <section class="card">
    <h2 style="margin:0 0 8px">ì‚¬ìš©ì ê²€ìƒ‰</h2>
    <div class="searchbar">
      <input id="q" placeholder="ì´ë¦„/ì´ë©”ì¼/UID í¬í•¨ ê²€ìƒ‰" />
      <button id="btn-refresh" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
      <span class="muted" id="result-line"></span>
    </div>
    <p class="muted" id="guard">â€» ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤. ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
  </section>

  <section class="card" style="margin-top:14px">
    <div class="row" style="justify-content:space-between; align-items:flex-end">
      <h2 style="margin:0">ì‚¬ìš©ì ëª©ë¡</h2>
      <div class="row" style="gap:8px">
        <label class="muted">ì •ë ¬
          <select id="sort">
            <option value="updatedAt">ìµœê·¼ ì—…ë°ì´íŠ¸</option>
            <option value="createdAt">ê°€ì…ì¼</option>
            <option value="displayName">ì´ë¦„(ê°€ë‚˜ë‹¤)</option>
            <option value="emailLower">ì´ë©”ì¼(ê°€ë‚˜ë‹¤)</option>
          </select>
        </label>
        <label class="muted">í‘œì‹œ ê°œìˆ˜
          <select id="limit">
            <option>50</option><option selected>100</option><option>200</option>
          </select>
        </label>
      </div>
    </div>
    <div id="list" class="list" style="margin-top:10px"></div>
  </section>
</main>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  // ===== Firebase init =====
  const firebaseConfig = {
    apiKey:"AIzaSyBofsqFmPSvocB0cBU8Azj-nMDWTB_of00",
    authDomain:"propot-cc6bf.firebaseapp.com",
    projectId:"propot-cc6bf",
    appId:"1:30940698980:web:1729f30e68d3beb24ac271"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // ===== helpers =====
  const $ = s => document.querySelector(s);
  const esc = s => String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const fmt = ts => { if(!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString(); };
  const lower = s => String(s||'').trim().toLowerCase();

  let me=null, isAdmin=false, cacheUsers=[];

  // ===== auth ui =====
  $('#btn-login').onclick = ()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message));
  $('#btn-logout').onclick= ()=>auth.signOut();

  auth.onAuthStateChanged(async u=>{
    me=u;
    if(!u){
      $('#who').textContent='ë¡œê·¸ì¸ í•„ìš”';
      $('#btn-login').style.display=''; $('#btn-logout').style.display='none';
      $('#guard').textContent='â€» ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤. ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
      $('#list').innerHTML='';
      return;
    }
    $('#who').textContent = `${u.displayName||'ìµëª…'} (${u.email||''})`;
    $('#btn-login').style.display='none'; $('#btn-logout').style.display='';
    try{
      isAdmin = (await db.collection('roles').doc(u.uid).get()).exists;
    }catch{ isAdmin=false; }
    if(!isAdmin){
      $('#guard').innerHTML = 'â›” ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. <a href="index.html">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>';
      $('#list').innerHTML='';
      return;
    }
    $('#guard').textContent = 'ê´€ë¦¬ì ëª¨ë“œì…ë‹ˆë‹¤. ëª¨ë“  ì‚¬ìš©ì ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆì–´ìš”.';
    await loadUsers();
  });

  // ===== load & render users =====
  $('#btn-refresh').onclick = ()=>loadUsers();
  $('#q').addEventListener('input', ()=>applyFilter());
  $('#sort').addEventListener('change', ()=>loadUsers());
  $('#limit').addEventListener('change', ()=>loadUsers());

  async function loadUsers(){
    if(!isAdmin) return;
    const sort = $('#sort').value;
    const lim  = parseInt($('#limit').value,10)||100;
    $('#result-line').textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
    $('#list').innerHTML = '<div class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    try{
      // ë„ˆë¬´ ë§ì€ ì¸ë±ìŠ¤ë¥¼ ìš”êµ¬í•˜ì§€ ì•Šë„ë¡ updatedAt, createdAtì€ ì„œë²„ ì •ë ¬, ë‚˜ë¨¸ì§€ëŠ” í´ë¼ ì •ë ¬ fallback
      let snap;
      if(sort==='updatedAt' || sort==='createdAt'){
        snap = await db.collection('users').orderBy(sort,'desc').limit(lim).get();
      }else{
        // displayName / emailLower ì •ë ¬ ìš”ì²­ â†’ ìš°ì„  updatedAtìœ¼ë¡œ ê°€ì ¸ì˜¨ ë’¤ JSì—ì„œ ì •ë ¬
        snap = await db.collection('users').orderBy('updatedAt','desc').limit(lim).get();
      }
      cacheUsers = snap.docs.map(d=>({ id:d.id, data:d.data() }));
      if(sort==='displayName') cacheUsers.sort((a,b)=> (a.data.displayName||'').localeCompare(b.data.displayName||'','ko'));
      if(sort==='emailLower') cacheUsers.sort((a,b)=> (a.data.emailLower||'').localeCompare(b.data.emailLower||''));
      renderUsers(cacheUsers);
      $('#result-line').textContent = `${cacheUsers.length}ëª… ë¡œë“œë¨`;
      applyFilter(); // ê²€ìƒ‰ì–´ ìˆìœ¼ë©´ í•„í„°
    }catch(e){
      $('#list').innerHTML = `<div class="muted">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${esc(e.message)}</div>`;
      $('#result-line').textContent = 'ì˜¤ë¥˜';
    }
  }

  function applyFilter(){
    const q = lower($('#q').value);
    if(!q){ renderUsers(cacheUsers); return; }
    const filtered = cacheUsers.filter(({data})=>{
      const hay = `${data.uid||''} ${data.displayName||''} ${data.email||''}`.toLowerCase();
      return hay.includes(q);
    });
    renderUsers(filtered);
    $('#result-line').textContent = `${filtered.length}ëª… (ê²€ìƒ‰)`;
  }

  function renderUsers(list){
    const box = $('#list');
    box.innerHTML='';
    if(!list || !list.length){
      box.innerHTML = '<div class="muted">í‘œì‹œí•  ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    list.forEach(({id, data})=>{
      const el = document.createElement('article');
      el.className = 'project user-card'; // base.cssì˜ ì¹´ë“œ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©
      el.innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="row" style="gap:8px; align-items:center">
              <h3 style="margin:0">${esc(data.displayName || 'ì´ë¦„ ì—†ìŒ')}</h3>
              ${data.email ? `<span class="pill">${esc(data.email)}</span>` : ''}
              ${id ? `<span class="pill uid">${esc(id)}</span>` : ''}
            </div>
            <div class="muted" style="margin-top:4px">ê°€ì…: ${fmt(data.createdAt)} Â· ìˆ˜ì •: ${fmt(data.updatedAt)}</div>
          </div>
          <div class="row" style="gap:6px">
            <a class="secondary" href="u.html?uid=${encodeURIComponent(id)}" target="_blank" rel="noopener">í˜ì´ì§€ ì—´ê¸°</a>
            <button class="ghost" data-copy="${id}">ë§í¬ ë³µì‚¬</button>
            <button class="ghost" data-fold="${id}">ìì„¸íˆ</button>
          </div>
        </div>
        <div id="more-${id}" style="display:none; margin-top:8px">
          <div class="muted">ìµœê·¼ í”„ë¡œì íŠ¸ 5ê°œ / ì¹œêµ¬ í˜„í™©</div>
          <div class="list" id="p-${id}" style="margin-top:8px"></div>
          <div class="list" id="f-${id}" style="margin-top:8px"></div>
        </div>
      `;
      box.appendChild(el);

      // ë§í¬ ë³µì‚¬
      el.querySelector('button[data-copy]').onclick = async (ev)=>{
        const uid = ev.target.getAttribute('data-copy');
        const link = `${location.origin}${location.pathname.replace(/admin\.html?$/,'')}u.html?uid=${encodeURIComponent(uid)}`;
        await navigator.clipboard.writeText(link);
        ev.target.textContent = 'ë³µì‚¬ë¨!';
        setTimeout(()=>ev.target.textContent='ë§í¬ ë³µì‚¬', 1200);
      };

      // ìì„¸íˆ(ìµœê·¼ í”„ë¡œì íŠ¸/ì¹œêµ¬)
      el.querySelector('button[data-fold]').onclick = async (ev)=>{
        const uid = ev.target.getAttribute('data-fold');
        const wrap = document.getElementById(`more-${uid}`);
        const open = wrap.style.display === 'none';
        wrap.style.display = open ? '' : 'none';
        if(open && !wrap._loaded){
          wrap._loaded = true;
          loadMini(uid);
        }
      };
    });
  }

  // ì„ íƒ ì‚¬ìš©ì ë¯¸ë‹ˆ íŒ¨ë„(ìµœê·¼ í”„ë¡œì íŠ¸/ì¹œêµ¬)
  async function loadMini(uid){
    // ìµœê·¼ í”„ë¡œì íŠ¸ 5ê°œ
    try{
      const ps = await db.collection('projects')
        .where('ownerUid','==',uid)
        .orderBy('createdAt','desc').limit(5).get();
      const pBox = document.getElementById(`p-${uid}`);
      if(ps.empty){ pBox.innerHTML = '<div class="muted">í”„ë¡œì íŠ¸ ì—†ìŒ</div>'; }
      else{
        pBox.innerHTML='';
        ps.forEach(d=>{
          const x = d.data();
          const row = document.createElement('div');
          row.className='project';
          row.innerHTML = `
            <div class="row" style="justify-content:space-between">
              <div>
                <div><strong>${esc(x.title||'(ì œëª©ì—†ìŒ)')}</strong></div>
                <div class="muted" style="font-size:12px">${esc(x.authorName||'ìµëª…')} Â· ${fmt(x.createdAt)}</div>
              </div>
              <a class="ghost" href="u.html?uid=${encodeURIComponent(uid)}" target="_blank" rel="noopener">í˜ì´ì§€ë¡œ</a>
            </div>`;
          pBox.appendChild(row);
        });
      }
    }catch(e){
      document.getElementById(`p-${uid}`).innerHTML = `<div class="muted">í”„ë¡œì íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${esc(e.message)}</div>`;
    }

    // ì¹œêµ¬(ë‚´ í˜ì´ì§€ì— ê¸€ì“°ê¸° ê¶Œí•œ ë¶€ì—¬ëœ ì‚¬ìš©ì) 5ëª…
    try{
      const fs = await db.collection('friends')
        .where('ownerUid','==',uid)
        .orderBy('createdAt','desc').limit(5).get();
      const fBox = document.getElementById(`f-${uid}`);
      if(fs.empty){ fBox.innerHTML = '<div class="muted">ê³µìœ ëœ ì¹œêµ¬ ì—†ìŒ</div>'; }
      else{
        fBox.innerHTML='';
        fs.forEach(d=>{
          const f=d.data();
          const row=document.createElement('div');
          row.className='project';
          row.innerHTML = `
            <div class="row" style="justify-content:space-between">
              <div>
                <div><strong>${esc(f.friendName||f.friendUid||'ì¹œêµ¬')}</strong></div>
                <div class="muted" style="font-size:12px">${esc(f.friendUid)}</div>
              </div>
              <a class="ghost" href="u.html?uid=${encodeURIComponent(uid)}" target="_blank" rel="noopener">í˜ì´ì§€ë¡œ</a>
            </div>`;
          fBox.appendChild(row);
        });
      }
    }catch(e){
      document.getElementById(`f-${uid}`).innerHTML = `<div class="muted">ì¹œêµ¬ ë¡œë“œ ì‹¤íŒ¨: ${esc(e.message)}</div>`;
    }
  }
</script>
</body>
</html>
